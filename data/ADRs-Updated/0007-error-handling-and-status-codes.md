# 7. Error Handling And Status Codes

Date: 2020-01-27

## Status

Proposed

## Context

When something goes wrong, the API should respond with as meaningful information as possible, to allow developers to pinpoint the source of the problem.

## Decision

If a valid request comes in for data, we show data. If creating a resource, we show the created resource, along with HATEOAS links showing what a client may do with it.

If something goes wrong, we use two simultaneous approaches

* Return an appropriate HTTP status code
* Return one or more custom error codes and messages, in order to offer more targeted error information For this we refer to [Problem Details for HTTP APIs](https://tools.ietf.org/html/rfc7807)

> HTTP [RFC7230] status codes are sometimes not sufficient to convey enough information about an error to be helpful.

### HTTP status codes

Without overdoing it, here is a simple set of error codes that we will implement:

* 200 - Generic everything is OK
* 201 - Created something OK
* 202 - Accepted but is being processed async (eg video transcoding)
* 301 - Moved Permanently (although we would provide the new link in with HATEOAS also)
* 400 - Generic bad request (generally invalid syntax)
* 401 - Unauthorised (no current user and there should be)
* 403 - Forbidden - The current user is forbidden from accessing this data (in this way)
* 404 - That URL is not a valid route, or the item resource does not exist
* 405 - Method not allowed
* 410 - Data has been deleted, deactivated, suspended etc
* 413 - Payload too large
* 415 - Unsupported media type
* 500 - Something unexpected happened and it is the API's fault
* 503 - Service Unavailable - please try again later (although the client might choose to queue and retry any request which returns a 5xx)

### Multiple errors

[JSON-API states](https://jsonapi.org/format/#errors):
> A server MAY choose to stop processing as soon as a problem is encountered, or it MAY continue processing and encounter multiple problems. For instance, a server might process multiple attributes and then return multiple validation problems in a single response.

With `opg-data` API **we will always endeavour to continue to encounter and provide feedback on an array of all errors** in a single response, rather than feeding errors out singly, causing the consumer to discover a new error with each subsequent request. Painful.

### <a name="errors-in-20x"></a> 200 and 201 means success - with ONE exception

A 200 or 201 status code offers certainty to the API consumer that their operation was **A SUCCESS**. There should **never** be an error code/message returned as a response to a 20x.

**With ONE exception**... (appropriated from Twitter):

> In some cases you may see the errors detailed above in a response that returned a 200 status code. In those cases, the endpoint is designed to return the data that it can, while providing detailed errors about what it could not return.

So, for GET queries where a range of resources are attempted, we return those resources that could be successfully retrieved, and provide error messages about those that couldn't be.

### Error Formatting

#### an examination of the application/problem+json format

It is found that our proposed error format satisfies the requirements of the `application/problem+json` type specified in [Problem Details for HTTP APIs](https://tools.ietf.org/html/rfc7807):

```json
HTTP/1.1 404 Not Found
Host: api.example.com
Content-Type: application/problem+json
{
  "type": "URI to problem type",
  "title": "Human readable reason",
  "detail": "Human readable occurance-specific details",
  "instance": "path to specific occurance",
  "balance": "problem-specificic extension",
  "accounts": ["problem-specificic extension",
               "problem-specificic extension"]
 }
```

> A problem details object can have the following members:
> * "type" (string) - A URI reference [RFC3986] that identifies the problem type.  This specification encourages that, when dereferenced, it provide human-readable documentation for the problem type (e.g., using HTML [W3C.REC-html5-20141028]).  When this member is not present, its value is assumed to be "about:blank".
> * "title" (string) - A short, human-readable summary of the problem type.  It SHOULD NOT change from occurrence to occurrence of the problem, except for purposes of localization (e.g., using proactive content negotiation; see [RFC7231], Section 3.4).
> * "status" (number) - The HTTP status code ([RFC7231], Section 6) generated by the origin server for this occurrence of the problem.
> * "detail" (string) - A human-readable explanation specific to this occurrence of the problem.
> * "instance" (string) - A URI reference that identifies the specific occurrence of the problem.  It may or may not yield further information if dereferenced.

We can adopt the ethos of JSON-API (for consistency across our API) whilst also providing the information set out in the `application/problem+json` type, above.

#### OPG-Data error format

As per our regular content structure [0005-content-structure.md](0005-content-structure.md)

> At the root level is always a JSON object.
> This **MUST** contain at least one of the following root-level members:
> * data: the document's "primary data" resource object
>   * A single resource object is represented by a JSON object
>   * A collection or resource objects is represented by an array of objects
> * errors: an array of error objects
> [JSON-API](https://jsonapi.org/format/#errors) states:
> Error objects **MUST** be returned as an array keyed by errors in the top level of a JSON:API document.

## Examples

### Basic structure

* Errors are an array, containing as many errors as we could encounter on the request
* Required fields:
  * "title": "Human readable reason",
  * "detail": "Human readable occurance-specific details",
  * "type": "URI to problem type", (URIs contained within links array)
  * "instance": URI to specific instance, where logged, (URIs contained within links array)
  * "source": an indication of the source of the problem, which may be either
    * "parameter" - identifying the problem relates to a parameter in the request path
    * "pointer" - identifying the problem relates to a attribute in the body of the request

```json
Content-Type: application/vnd.opg-data.v1+json
{
    "errors": [
        {
            "title": "Human readable reason",
            "detail": "Human readable occurance-specific details",
            "links": {
                "type": "URI to problem type",
                "instance": "URI to specific occurance"
            },
            "source": {
                "parameter": "id"
            }
        }
    ]
 }
```

### 404 Not Found

Request:

```json
PATCH /clients/invalidID HTTP/1.1
Host: api.example.com
Accept: application/vnd.opg-data.v1+json

{
    "data": {
        "type": "clients",
        "id": "invalidID",
        "attributes": {
            "first_name": "Bob",
            "last_name": "Jones"
        }
    }
}
```

Response:

```json
HTTP/1.1 404 Not Found
Host: api.example.com
Content-Type: application/vnd.opg-data.v1+json

{
    "errors": [
        {
            "title": "No resource at this URI",
            "detail": "You requested a resource which doesn't exist",
            "links": {
                "type": "https://api.example.com/help/errors/no-resource",
                "instance": "https://api.example.com/logging/A123BCD"
            },
            "code": "OPGDATA-API-NO-RESOURCE",
            "source": {
                "parameter": "clientid"
            }
        }
    ]
}
```

### 403 Forbidden

Request:

```json
PATCH /clients/123123abc HTTP/1.1
Host: api.example.com
Accept: application/vnd.opg-data.v1+json

{
    "data": {
        "type": "clients",
        "id": "123123abc",
        "attributes": {
            "admin_rights", "elevated",
            "payment_status", "paid"
        }
    }
}
```

Response:

```json
HTTP/1.1 403 Forbidden
Host: api.example.com
Content-Type: application/vnd.opg-data.v1+json

{
    "errors": [
        {
            "title": "User Lacks Permissions",
            "detail": "You are not authorised to perform the selected action(s) on this resource",
            "links": {
                "type": "https://api.example.com/help/errors/forbidden"
                "instance": "https://api.example.com/logging/A123BCD",
            },
            "code": "OPGDATA-API-FORBIDDEN",
            "source": {
                "pointer": "/data/attributes/admin_rights"
            }
        },
        {
            "title": "User Lacks Permissions",
            "detail": "You are not authorised to perform the selected action(s) on this resource",
            "links": {
                "type": "https://api.example.com/help/errors/forbidden"
                "instance": "https://api.example.com/logging/B456DEF",
            },
            "code": "OPGDATA-API-FORBIDDEN",
            "source": {
                "pointer": "/data/attributes/payment_status"
            }
        }
    ]
}
```

### References

* [https://jsonapi.org/format/#errors](https://jsonapi.org/format/#errors)
* [Problem Details for HTTP APIs](https://tools.ietf.org/html/rfc7807)

## Consequences

* Standardised unambiguous error reporting, using the established JSON-API format, aiming to point our consumer to the source of the error as quickly as possible.
* Returning multiple errors as an array is very helpful to the consumer
* Implement the best practicies outlined in [IETF rfc7807](https://tools.ietf.org/html/rfc7807)
