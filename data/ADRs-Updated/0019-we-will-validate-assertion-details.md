# 19. We will validate assertion details

Date: 2017-08-09

## Status

Accepted

## Context

Assertions are generated by the MSA, and they look like:

```
<saml2:Assertion ID="_95dc6950-68ff-4ad7-b062-c7ff44998386" IssueInstant="2017-08-01T15:21:20.087Z" Version="2.0">
  <saml2:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity">http://www.test-rp-ms.gov.uk/SAML2/MD</saml2:Issuer>
  <ds:Signature>...</ds:Signature>
  <saml2:Subject>
    <saml2:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">expected-pid</saml2:NameID>
    <saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
      <saml2:SubjectConfirmationData InResponseTo="request-id-386f467d-85c1-4c71-b3fc-cdc3739682b1" NotOnOrAfter="2017-08-01T16:21:20.087Z" Recipient="http://rp-endpoint.com"/>
    </saml2:SubjectConfirmation>
  </saml2:Subject>
  <saml2:Conditions>
    <saml2:AudienceRestriction>
      <saml2:Audience>rp-entity</saml2:Audience>
    </saml2:AudienceRestriction>
  </saml2:Conditions>
  <saml2:AuthnStatement AuthnInstant="2017-08-01T15:21:20.092Z">
    <saml2:AuthnContext>
      <saml2:AuthnContextClassRef>urn:uk:gov:cabinet-office:tc:saml:authn-context:level2</saml2:AuthnContextClassRef>
    </saml2:AuthnContext>
  </saml2:AuthnStatement>
</saml2:Assertion>
```

Elements such as `Conditions` specify restrictions on where the assertion
should be treated as valid. Relying parties SHOULD validate these things.

## Decision

We will validate any details that the MSA currently provides. If we see
elements we're not expecting we'll throw.

We'll validate:

* There must be exactly one `SubjectConfirmation`
* There must be exactly one `NameID` inside `Subject`
* The `SubjectConfirmationData` method MUST be `...bearer`
* If there's a `NotBefore` on the `SubjectConfirmationData` then it MUST be valid
* There MUST be a `NotOnOrAfter` on the `SubjectConfirmationData` and it MUST be valid
* `InResponseTo` MUST be present on the `SubjectConfirmationData` and it MUST be valid
* `Conditions` MUST be present
* If `Conditions` has `NotBefore` or `NotOnOrAfter` they MUST be valid
* `Conditions` MUST NOT contain any `OneTimeUse` or `ProxyRestriction` elements
* There MUST be exactly one `AudienceRestriction` and it must match our `entityID`


We'll ignore:

* Recipient - this concept is already checked by AudienceRestriction, and it's hard for the
  VSP to check whether it's correct because we don't know what URL we're running behind.

## Consequences

Assertions must match a particular format, which is more strict than the SAML specification.

In some situations it may be harder for us to change the format without
also updating the verify-service-provider.

It will be more difficult for malicious parties to misuse Assertions in inappropriate ways.
