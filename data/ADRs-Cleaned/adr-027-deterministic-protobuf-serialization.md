adr deterministic protobuf serialization changelog initial draft clarify rule proposed abstract fully deterministic structure serialization work across many language client needed signing message sure whenever serialize data structure matter supported language raw byte stay protobuf serialization bijective exist practically unlimited number valid binary representation given protobuf document document describes deterministic serialization scheme subset protobuf document cover case reused case well signature verification cosmos sdk signer verifier agree serialization signdoc defined adr without transmitting serialization currently block signature workaround create new txraw instance defined adrprotobuftransactionencoding converting field byte client side add additional manual step sending signing transaction following encoding scheme adrs particular signdoc serialization specification scope adr defines protobuf serializer output valid protobuf serialization every protobuf parser parse map supported version due complexity defining deterministic serialization might change future implementation must reject document containing map invalid input background protobuf encoding numeric type protobuf encoded varints varints byte since varint byte bit data varints representation uint bit unsigned integer encoding numeric value casted base type uint decoding parsed uint casted appropriate numeric type maximum valid value varint complies protobuf field type usint highest bit dropped decoding introducing bit malleability field type usint highest bit dropped decoding introducing bit malleability among source nondeterminism adr eliminates possibility encoding malleability serialization rule serialization based protobuf encoding following addition field must serialized ascending order extra field extra data must added default value must omitted repeated field scalar numeric type must packed encoding varint encoding must longer needed trailing zero byte little endian leading zero big endian per rule default value must omitted rule apply case maximum value varint must word decoded highest bit bit unsigned integer must byte varints group bit bit lowest useful maximum value bit value varint encoding must one exception word decoded highest bit bit unsigned integer must one exception negative int must encoded full byte sign extension maximum value boolean value varint encoding must must per rule default value must omitted boolean included must value rule number pretty straight forward describe default behavior protobuf encoders author aware rule interesting protobuf deserialization cannot differentiate unset field field set default value serialization level however possible set field empty value omitting entirely significant difference json property empty null undefined leading different document omitting field set default value valid parser must assign default value field missing serialization scalar type omitting default required spec repeated field serializing way express empty list enums must first element numeric value default message field default unset omitting default allows amount forward compatibility user newer version protobuf schema produce serialization user older version long newly added field set default value implementation three main implementation strategy ordered least custom development protobuf serializer follows rule default gogoproto known compliant case certain annotation nullable false might also configure existing serializer accordingly normalize default value encoding serializer follows rule allows explicitly unset field serialization normalize default value unset done working protobufjs const byte signdocencode bodybytes bodylength body null normalize empty byte unset authinfobytes authinfolength authinfo null normalize empty byte unset chainid chainid null normalize unset accountnumber accountnumber null normalize unset accountsequence accountsequence null normalize unset finish handwritten serializer type none way work write serializer signdoc would look something like building existing protobuf utility signdocbodybytesempty bufwriteuvarintxa wire type field number bodybytes bufwriteuvarintsigndocbodybyteslength bufwritebytessigndocbodybytes signdocauthinfoempty bufwriteuvarintx wire type field number authinfo bufwriteuvarintsigndocauthinfolength bufwritebytessigndocauthinfo signdocchainidempty bufwriteuvarintxa wire type field number chainid bufwriteuvarintsigndocchainidlength bufwritebytessigndocchainid signdocaccountnumber bufwriteuvarintx wire type field number accountnumber bufwriteuvarintsigndocaccountnumber signdocaccountsequence bufwriteuvarintx wire type field number accountsequence bufwriteuvarintsigndocaccountsequence test vector given protobuf definition articleproto protobuf package blog syntax proto enum type unspecified image news enum review unspecified rejected message article string title string description uint created uint updated bool public bool promoted type type review review repeated string comment repeated string backlinks serializing value yaml title world change description created updated public true promoted false type typenews review reviewunspecified comment nice one thank backlinks must result serialization text abfceeffcbebebecbceaefeaebf inspecting serialized document see every second field omitted shell echo abfceeffcbebebecbceaefeaebf xxd protoc decoderaw world change nice one thank consequence encoding available allows get deterministic serialization protobuf document cosmos sdk signing positive well defined rule verified independent reference implementation simple enough keep barrier implement transaction signing low allows continue empty value signdoc avoiding work around sequence imply change httpsgithubcomcosmoscosmossdkpull merged important anymore negative implementing transaction signing encoding rule must understood implemented rule number add complexity implementation data structure may require custom code serialization thus code portable require additional work client implementing serialization properly handle custom data structure neutral usage cosmos sdk reason mentioned negative section prefer keep workarounds shared data structure example aforementioned txraw raw byte workaround allows valid protobuf library without implementing custom serializer adheres standard related risk bug reference message serialized guaranteed order known unknown field written serialization order implementation detail detail particular implementation may change future therefore protocol buffer parser must able parse field order httpsdevelopersgooglecomprotocolbuffersdocsencodingorder httpsdevelopersgooglecomprotocolbuffersdocsencodingsignedintegers note scalar message field message parsed there way telling whether field explicitly set default value example whether boolean set false set bear mind defining message type example dont boolean switch behavior set false dont want behavior also happen default httpsdevelopersgooglecomprotocolbuffersdocsprotodefault message parsed encoded message contain particular singular element corresponding field parsed object set default value field httpsdevelopersgooglecomprotocolbuffersdocsprotodefault also note scalar message field set default value serialized wire httpsdevelopersgooglecomprotocolbuffersdocsprotodefault enums default value first defined enum value must httpsdevelopersgooglecomprotocolbuffersdocsprotodefault message field field set exact value languagedependent httpsdevelopersgooglecomprotocolbuffersdocsprotodefault encoding rule part reasoning taken canonicalproto aaron craelius