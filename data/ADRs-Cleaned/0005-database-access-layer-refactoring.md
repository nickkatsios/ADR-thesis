database access layer refactoring recently discovered issue one class serviceapimoduleapplicationsrcmodeldataaccesspostgres search parameter correctly escaped investigation found test coverage file directory practically zero also found writing unit test class tricky acting factory class real database connection made difficult mock result set etc test different code path pseudocode old code followed pattern class abstractbase adapter laminasdbadapteradapter construct abstractbase reference real database adapter public constructadapter thisadapter adapter public getadapter return thisadapter class userdata public getdata query new sqlthisgetadapter note getdata method constructing sql directly inside userdata class mean cant mock test cant control constructed refactor data database access class databasespecific operation sql construction mocked test decided pull adapter data access class instead wrapping dbwrapper class put utility method class method creating sql instance dbwrapper hold reference adapter look like class dbwrapper public constructadapter thisadapter adapter public createsql return new sqlthisadapter class abstractbase public constructdbwrapper thisdbwrapper dbwrapper class userdata public getdata query thisdbwrappercreatesql able pas mock dbwrapper instance data access class turn return mock sql instance createsql method make possible unit test class previously difficult test consequence con refactoring live code existing automated test fraught risk change made could potential repercussion arent immediately apparent example initial refactoring caused one daily cron job fail generates statistic service additional class manage however offer potential refactoring moving almost identical select statement construction code multiple class single location pro code unit tested however note first pas issue unit test complex due suboptimal structure class mock required single unit test though tentative test highlight additional refactoring perform future