adr transfer state entry total amount token escrow changelog initial draft applied ibcgo every transfer channel escrow bank account account lock token transferred chain act source token token transferred returned originating chain design make easy query balance escrow account find total amount token escrow particular channel however case would useful determine total escrowed amount given denomination across channel token transferred example assuming three channel cosmos hub osmosis atom transferred cosmos hub osmosis channel would like know atom transferred locked escrow account channel without needing iterate escrow account add balance sample case feature would useful please refer osmosis rate limiting case described state entry denom amount total amount token escrow across transfer channel given denomination stored state entry keyed denomination totalescrowfordenomdenom panic amount negative negative amount ever attempted stored keeper function panic coinamountisnegative panicfmtsprintfamount cannot negative coinamount delete state entry amount zero setting amount particular denomination value might zero token transferred chain transferred back happens state entry particular denomination deleted since cosmos sdks xbank module prune nonzero balance coinamountiszero storedeletekey delete key since cosmos sdk xbank module prune nonzero balance return bundle escrowunescrow setting state entry two new function implemented bundle together operation escrowingunescrowing setting total escrow amount state since operation executed together escrowing token escrowtoken send given token provided sender escrow address also update total escrowed amount adding escrowed token current total escrow func keeper escrowtokenctx sdkcontext sender escrowaddress sdkaccaddress token sdkcoin error err kbankkeepersendcoinsctx sender escrowaddress sdknewcoinstoken err nil failure expected insufficient balance return err track total amount escrow keyed denomination allow efficient iteration currenttotalescrow kgettotalescrowfordenomctx tokengetdenom newtotalescrow currenttotalescrowaddtoken ksettotalescrowfordenomctx newtotalescrow return nil unescrowing token unescrowtoken send given token escrow address provided receiver also update total escrow deducting unescrowed token current total escrow func keeper unescrowtokenctx sdkcontext escrowaddress receiver sdkaccaddress token sdkcoin error err kbankkeepersendcoinsctx escrowaddress receiver sdknewcoinstoken err nil note error expected occur given unexpected bug malicious counterparty module bug may occur bank part code allows escrow address drained malicious counterparty module could drain escrow address allowing token sent back escrowed return errorsmodwraperr unable unescrow token may caused malicious counterparty module bug please open issue counterparty module track total amount escrow keyed denomination allow efficient iteration currenttotalescrow kgettotalescrowfordenomctx tokengetdenom newtotalescrow currenttotalescrowsubtoken ksettotalescrowfordenomctx newtotalescrow return nil token escrowed sendtransfer escrowtoken called token unescrowed execution onrecvpacket onacknowledgementpacket ontimeoutpacket callback unescrowtoken called grpc query endpoint cli retrieve amount grpc query endpoint added possible retrieve total amount given denomination proto totalescrowfordenom return total amount token escrow based denom rpc totalescrowfordenomquerytotalescrowfordenomrequest return querytotalescrowfordenomresponse googleapihttpget ibcappstransfervdenomsdenomtotalescrow querytotalescrowfordenomrequest request type totalescrowfordenom rpc method message querytotalescrowfordenomrequest string denom querytotalescrowfordenomresponse response type totalescrowfordenom rpc method message querytotalescrowfordenomresponse cosmosbasevbetacoin amount gogoprotonullable false cli query also available retrieve total amount via command line shell query ibctransfer totalescrow denom consequence positive possibility retrieve total amount particular denomination escrow across transfer channel without iteration negative notable consequence neutral new entry added state every denomination transferred chain reference issue