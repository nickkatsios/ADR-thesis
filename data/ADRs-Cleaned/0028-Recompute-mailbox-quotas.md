recompute mailbox quota lazy consensus implemented jmap custom quota extension well imap rfc enables user monitor amount space message count allowed effectively track quota value user effectively james relies eventbus increment cassandra counter corresponding user however upon cassandra failure value incorrect hence correcting data model detail table imapuidtable hold mailbox flag message lookup message table messagev hold message metadata independently mailbox content message stored blob blobparts table table currentquota hold per quotaroot current value quotaroots defines group mailbox share quota limitation operation quota update done asynchronously event bus listener successful mailbox operation quota update applied inconsistent eventbus error retried upon error counter nonindempotent result inconsistent quota implement generic corrective task exposed via webadmin task reuse currentquotacalculator call every quotaroot user way noncassandra implementation also benefit task consequence task concurrentsafe concurrent operation result invalid quota persisted however source truth altered rerunning task eventually return correct result reference jira