adr inplace store migration changelog initial draft abstract adr introduces mechanism perform inplace state store migration chain software upgrade chain upgrade introduces statebreaking change inside module current procedure consists exporting whole state json file via simd genesis export command running migration script json file simd genesis migrate command clearing store simd unsaferesetall command starting new chain migrated json file new genesis optionally custom initial block height example procedure seen cosmos hub migration guide procedure cumbersome multiple reason procedure take time take hour run export command plus additional hour run initchain fresh chain migrated json exported json file heavy mbgb making difficult view edit transfer turn introduces additional work solve problem streaming genesis propose migration procedure based modifying store inplace without involving json exportprocessimport flow described module consensusversion introduce new method appmodule interface type appmodule interface snip consensusversion uint method return uint serf statebreaking version module must incremented consensusbreaking change introduced module avoid potential error default value initial version module must set cosmos sdk version corresponds module series modulespecific migration function consensusbreaking change introduced module migration script consensusversion version must registered configurator newlyadded registermigration method module receive reference configurator registerservices method appmodule migration function registered migration function registered increasing order func appmodule registerservicescfg moduleconfigurator snip cfgregistermigrationtypesmodulename funcctx sdkcontext error perform inplace store migration consensusversion cfgregistermigrationtypesmodulename funcctx sdkcontext error perform inplace store migration consensusversion etc example new consensusversion module migration function must registered configurator cosmos sdk migration function handled module keeper keeper hold sdkstorekey perform inplace store migration overload keeper migrator wrapper module handle migration function migrator struct handling inplace store migration type migrator struct basekeeper migration function live inside migration folder module called migrator method propose format migratemton method name migrateto migrates version func migrator migratetoctx sdkcontext error return vbankmigratestorectx mkeeperstorekey vbank package xbankmigrationsv module migration function specific module store evolution described adr example xbank store key migration introduction adr lengthprefixed address seen storego code tracking module version xupgrade introduce new prefix store xupgrades store store track module current version modelized mapstringuint module name module consensusversion running migration see next section detail key prefix keyvalue format text bytesmodulename bigendianmoduleconsensusversion initial state store set appgos initchainer method upgradehandler signature updated take versionmap well return upgraded versionmap error diff type upgradehandler funcctx sdkcontext plan plan type upgradehandler funcctx sdkcontext plan plan versionmap versionmap versionmap error apply upgrade query versionmap xupgrade store pas handler handler run actual migration function see next section successful return updated versionmap stored state diff func upgradekeeper applyupgradectx sdkcontext plan typesplan snip handlerctx plan updatedvm err handlerctx plan kgetmoduleversionmapctx kgetmoduleversionmap fetch versionmap stored state err nil return err set updated consensus version state ksetmoduleversionmapctx updatedvm grpc query endpoint query versionmap stored xupgrades state also added app developer doublecheck versionmap upgrade handler run running migration migration handler registered inside configurator happens startup running migration happen calling runmigrations method modulemanager function loop module module get old consensusversion module versionmap argument let call fetch new consensusversion module consensusversion method appmodule call run registered migration module sequentially special case consensusversion module mean module newly added upgrade case migration function run module current consensusversion saved xupgrades store required migration missing registered configurator runmigrations function error practice runmigrations method called inside upgradehandler appupgradekeepersetupgradehandlermyplan funcctx sdkcontext plan upgradetypesplan moduleversionmap moduleversionmap error return appmmrunmigrationsctx assuming chain upgrade block procedure run follows old binary halt beginblock starting block store consensusversions old binary module stored new binary start block upgradehandler set new binary run beginblock new binary inside xupgrades applyupgrade versionmap retrieved old binary store passed runmigrations function migrating module store inplace module beginblocks consequence backwards compatibility adr introduces new method consensusversion appmodule module implement also alters upgradehandler function signature backwardscompatible module must register migration function bumping consensusversions running script upgrade handler optional application may perfectly well decide call runmigrations inside upgrade handler continue legacy json migration path positive perform chain upgrade without manipulating json file benchmark made yet probable inplace store migration take time json migration main reason supporting claim simd genesis export command old binary initchain function new binary skipped negative module developer must correctly track consensusbreaking change module consensusbreaking change introduced module without corresponding consensusversion bump runmigrations function wont detect migration chain upgrade might unsuccessful documentation clearly reflect neutral cosmos sdk continue support json migration via existing simd genesis export simd genesis migrate command current adr allow creating renaming deleting store modifying existing store key value cosmos sdk already storeloader operation discussion reference initial discussion httpsgithubcomcosmoscosmossdkdiscussions implementation consensusversion runmigrations httpsgithubcomcosmoscosmossdkpull issue discussing xupgrade design httpsgithubcomcosmoscosmossdkissues