adr abci integration phase changelog initial draft alexanderbez tacturtle nov update prepareproposal processproposal semantics per initial implementation alexanderbez abstract adr describes initial adoption abci next evolution abci within cosmos sdk abci aim provide application developer flexibility control application consensus semantics inapplication mempools inprocess oracle orderbook style matching engine tendermint release abci notably time writing tendermint releasing include prepareproposal processproposal prepareproposal abci method concerned block proposer requesting application evaluate series transaction included next block defined slice txrecord object application either accept reject completely ignore transaction important consideration make application essentially define control mempool allowing define sophisticated transaction priority filtering mechanism completely ignoring txrecords tendermint sends favoring transaction essentially mean tendermint mempool act like gossip data structure second abci method processproposal process block proposer proposal defined prepareproposal important note following respect processproposal execution processproposal must deterministic must coherence prepareproposal processproposal word two correct process tendermint call requestprocessproposal application return accept responseprocessproposal important note abci integration application responsible locking semantics tendermint still responsible future however application responsible locking allows parallel execution possibility integrate abci introduced tendermint next major release cosmos sdk integrate abci method baseapp type describe implementation two method individually prior describing implementation two new method important note existing abci method checktx delivertx etc still exist serve function prepareproposal prior evaluating implement prepareproposal important note checktx still executed responsible evaluating transaction validity one important additive distinction executing transaction checktx application add valid transaction passing antehandler mempool data structure order provide flexible approach meet varying application developer define mempool interface data structure utilizing golang generic allowing developer focus transaction ordering developer requiring absolute full control implement custom mempool implementation define general mempool interface follows subject change type mempool interface insert attempt insert appside mempool returning error upon failure insertsdkcontext sdktx error select return iterator appside mempool specified shall incorporated iterator iterator must closed caller selectsdkcontext byte iterator counttx return number transaction currently mempool counttx int remove attempt remove transaction mempool returning error upon failure removesdktx error iterator defines appside mempool iterator interface minimal possible order iteration determined appside mempool implementation type iterator interface next return next transaction mempool transaction return nil next iterator return transaction current position iterator sdktx define implementation mempool defined noncemempool cover basic application usecases namely prioritize transaction transaction sender allowing multiple transaction sender default appside mempool implementation noncemempool operate single skip list data structure specifically transaction lowest nonce globally prioritized transaction nonce prioritized sender address type noncemempool struct txqueue huanduskiplist previous discussion come agreement tendermint perform request application via requestprepareproposal certain amount transaction reaped tendermints local mempool exact amount transaction reaped determined local operator configuration referred oneshot approach seen discussion tendermint reaps transaction local mempool sends application via requestprepareproposal application evaluate transaction specifically inform tendermint reject include transaction note application even replace transaction entirely transaction evaluating transaction requestprepareproposal application ignore transaction sent request instead reap requestprepareproposalmaxtxbytes mempool since application technically insert inject transaction insert checktx execution recommended application ensure transaction validity reaping transaction prepareproposal however validity exactly mean entirely determined application cosmos sdk provide default prepareproposal implementation simply select maxbytes valid transaction however application override default implementation implementation set baseapp via setprepareproposal processproposal processproposal abci method relatively straightforward responsible ensuring validity proposed block containing transaction selected prepareproposal step however application determines validity proposed block depends application varying case application simply calling antehandler chain would suffice could easily application control validation process proposed block ensuring certain order certain transaction included theoretically could achieved custom antehandler implementation cleanest efficient solution instead define additional abci interface method existing application interface similar existing abci method beginblock endblock new interface method defined follows processproposalsdkcontext abciprocessproposalrequest error note must call processproposal new internal branched state argument cannot simply existing checkstate baseapp already modified checkstate point executing processproposal create similar branched state processproposalstate deliverstate note processproposalstate never committed completely discarded processproposal finish execution cosmos sdk provide default implementation processproposal transaction validated checktx flow antehandler always return accept unless transaction cannot decoded delivertx since transaction truly removed appside mempool prepareproposal since processproposal fail take multiple round want lose transaction finally remove transaction appside mempool delivertx since phase transaction included proposed block alternatively keep transaction truly removed reaping phase prepareproposal add back appside mempool case processproposal fails consequence backwards compatibility abci naturally backwards compatible prior version cosmos sdk tendermint example application request requestprepareproposal application speak abci naturally fail however first phase integration existing abci method know today still exist function currently positive application full control transaction ordering priority lay groundwork full integration abci unlock appside case around block construction integration tendermint consensus engine negative requires mempool general data structure collect store uncommitted transaction duplicated tendermint cosmos sdk additional request tendermint cosmos sdk block execution albeit overhead negligible backwards compatible previous version tendermint cosmos sdk discussion possible design appside implementation mempoolt mempooltx many different way different data structure implementation different tradeoff proposed solution keep thing simple cover case would required basic application tradeoff made improve performance reaping inserting provided mempool implementation reference httpsgithubcomtenderminttendermintblobmasterspecabcibbreadmemd httpsgithubcomtenderminttendermintissuesissuecomment httpsgithubcomtenderminttendermintissuesissuecomment