title available stock improvement area inventory tag inventory performance stock currently available stock calculation performed every update product true product updated via api also ordered via store api route order placed triggered stockupdaterlineitemwritten performs update available stock subtracting stock quantity open order many open order storage lead bottleneck many order executed time product solved problem updating available stock directly checkoutorderplaced event ordered quantity php public function orderplacedcheckoutorderplacedevent event void foreach eventgetordergetlineitems lineitem lineitemgettype lineitemproductlineitemtype continue arraykeyexistslineitemgetreferencedid idslineitemgetreferencedid idslineitemgetreferencedid lineitemgetquantity order placed event high load event high load simply reduce quantity instead executing high cost update function query new retryablequery thisconnection thisconnectionprepareupdate product set availablestock availablestock quantity foreach quantity queryexecuteid uuidfromhextobytesstring quantity quantity thisupdateavailableflagarraykeysids eventgetcontext prevent executing lineitemwritten logic addition checkoutorderplaced logic set state within cartorderroute query event listener skip process php public function lineitemwrittenentitywrittenevent event void dont want trigger update method inside order process eventgetcontexthasstatecheckoutorderroute return addition optimization perform stock update one three relevant field stock minpurchase iscloseout changed checked productindexer within update method php stock eventgetprimarykeyswithpropertychangeproductdefinitionentityname stock iscloseout minpurchase thisstockupdaterupdatestocks eventgetcontext