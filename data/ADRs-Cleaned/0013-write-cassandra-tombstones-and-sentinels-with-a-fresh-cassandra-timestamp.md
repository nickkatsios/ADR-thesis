write cassandra tombstone sentinel fresh cassandra timestamp mutation mutation cassandra take place cassandra writetime timestamp normal cassandra operation time wallclock time mutation took place resolve conflict performing read given column recently written value read lastwritewins atlasdb column take form row column column value column atlas timestamp timestamps unique thus transactional table mutation column take place apart deleting cell longer needed sweep atlasdb reliance wallclock time generally considered unacceptable thus atlas timestamps cell written start timestamp given cassandra timestamp sweep sentinel given cassandra timestamp tombstone inserted deleting cell start timestamp given cassandra timestamp range tombstone time exclusive given cassandra timestamp transactional table several key invariant preserved tombstone range tombstone cover cell cassandra timestamp must cassandra timestamp greater tombstone range tombstone cover sweep sentinel cassandra timestamp must cassandra timestamp greater insertion fresh sweep sentinel tombstone cover sentinel written timestamp must cassandra timestamp greater notice existing system satisfy third invariant switching conservative sweep writes sentinel thorough sweep remove sentinel back broken sentinel written conservative sweep reversion strategy visible reader thing behave differently nontransactional table table timestamp backup lock schema mutation lock schema metadata written metadata table written read wallclock time compaction cassandra store data multiple sstables periodically compacted together compaction help clear deleted data reclaim disk space tombstone reclaimed well compacting sstables together recent value tombstone cassandra determine whether tombstone safely reclaimed cassandra first check based realtime age tombstone gcgraceseconds give protection zombie data failed node recovers assuming check pass look minimum write timestamp sstables involved compaction precisely reclaimable tombstone tombstone deletion timestamp lowest timestamp sstables include partition deleted cell within partition memtables otherwise may live data tombstone covering suddenly become visible since atlas writes sweep sentinel timestamp sstables memtables minimum timestamp may prevent compaction subset sstables dropping many legitimately reclaimable tombstone change timestamps sweep sentinel tombstone range tombstone written fresh timestamp timestamp service case sentinel tombstone single api call add set garbage collection sentinel delete set cell make one call fresh timestamp timestamp service cell write timestamps unchanged write timestamp still receives cassandra timestamp taking rpc overhead fine operation dont happen critical path operation dont occur part normal client readwrite transaction write pattern metadata table unchanged still wallclock time chicken egg problem embedded user timestamp service additionally existing cli manipulate metadata table dont ready access timestamp service also table receive minimal writes deletes compared actual transactional data table thus concern cassandra strainperformance perspective proof correctnesssafety recall invariant seek preserve tombstone range tombstone cover cell cassandra timestamp must cassandra timestamp greater tombstone range tombstone cover sweep sentinel cassandra timestamp must cassandra timestamp greater insertion fresh sweep sentinel tombstone cover sentinel written timestamp must cassandra timestamp greater cell covered cassandra timestamp must also atlas start timestamp given cell already written database fresh timestamp necessarily greater giving statement statement follow guarantee timestamp service migrationscutover notice even presence value written old scheme invariant preserved statement hold cell write timestamps havent changed reuse proof statement timestamps value covering would deletiontimestamp know fresh timestamp least since timestamps arent given twice timestamps existing value changed major compaction may necessary one begin reap benefit better tombstone droppability may especially relevant larger table marked appendheavyandreadlight sizetieredcompactionstrategy also heavier user general may several timestamps sstables frequently compacted thus issue consequence keyvalue service fresh timestamp supplier initialisation approach optional considered provided would legacy mode decided mandate providing supplier benefit better tombstone droppability significant fresh timestamp supplier unused key value service cassandra inserting sentinel writing tombstonesrange tombstone requires one additional rpc operation occur critical path normal readwrite transaction client may thus performancesensitive read writes critical path suffer extra rpc overhead memoisation approach considered nave memoisation wrong risk write value delete shortly memoized timestamp given tombstone could fresh timestamp given write case value remains live variant max memoized timestamp writetimestamp briefly considered though opted memoizing simplicity hot codepaths