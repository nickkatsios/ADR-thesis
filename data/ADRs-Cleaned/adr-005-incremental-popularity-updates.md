record incremental popularity update rejected adr perform popularity updating without index lock changed process bulk loading data rummagers search index update existing index place rather creating separate index required locking existing index new one ready main reason bulk load data update popularity field every night affect every document search index problem switching new index observed regular spike error search api coincide nightly task run elasticsearch query taking longer normal timing want read index unaffected bulk indexing user ability search important content part investigation looked way could change implementation nightly popularity update improve performance considered limiting popularity update task changed small number document every night decided making technical change popularity update process instead reduced number sidekiq process index elasticsearch time reduced impact search performance without making noticeable difference indexing time learned pagetraffic index contains today analytics data updated nightly number page view link day period stored field rank relative page govuk stored rank field compared field page traffic two successive day work much page popularity shift practice small number number page actually significant change day day change least page view mean shouldnt update entire search index every day could get away current update workload despite dont think incremental popularity update would work without significant change rummager doesnt value directly order search result rank relative ranking compared page index rank value change lot day day since small difference page view single document shift lot document confident update content whose rank changed could keep rummagers data reflecting actual distribution pageviews update popularity field search index derive rank value pagetraffic mean update time data actually available compare previous day popularity current popularity derived rank considered also storing search index retaining popularity well could see change meet threshold updating popularity rejected mean document becomes popular would still neglect update rank document overtakes also document arent viewed often would introduce bias towards older content rank new document start pageviews equal current size index popularity derived may better change rummager directly popularity boost would let partial popularity update bigger change want make right would careful measurement ensure dont break query consequence running popularity update still impact search response time still ability bulk load empty index migrateschema rake task cluster isnt tuned optimally bulkindexing performance experimented setting affect indexing performance see helped reduce impact search performance since none change affected left configuration