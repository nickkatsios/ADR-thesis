adr light client refactor changelog initial draft new decomposition concurrency handle abstraction light client protocol provides method verifying application state without execution preceding transaction protocol light client described english rust implementation described adr adr outline next iteration light client implementation rust outline runtime concurrency concern basis work come learning reactor experiment well blockchain reactor refactor key take always work separate concern independently verifiable human well computer component deterministic function wherever possible event index parameter component function execution maintain alignment spec implementation lightclient refactored coordinate interaction multiple peer two abstraction introduced instance representing api interacting single peer supervisor provides api interacting set peer known peerlist peerlist single peer primary multiple peer available secondary lightclient instance configured perform light client protocol single peer instance decomposed independently verifiable component fetching lightblocks peer verifier verifying lightblock based trustedstate scheduler schedule next block based last trustedstate clock provide current time addition cryptographic operation also decomposed three subcomponents hasher hashing header commitvalidator validating commit integrity votingpowercalculator tallying voting power validator set commit verifying signature component operation represented trait allowing mock replacement integration testing supervisor manage lifecycle instance coordinate execution fork detection protocol publishing evidence peer integration goal allow light client accessible multiple component running different thread one component rpc server allow external party interact internal light client another immediate relayer able fetch latest trusted state verified light client order relay ibc message component facade expose interface provides synchronous interaction mocked testing interface free serialization concern user hood facade facilitating interaction boundary allowing component operate freely safely distinct thread runtime rust main let mut lightclient supervisornew get handle specifically relayer let relayerlightclient lightclienthandle let relayer relayernewlightclient run consume supervisor lightclientrun lack better naming call abstraction handle supervisor outlined executed running thread spawn handle handle clonable given component want safe serialized access supervisor implementation simple abstraction facilitates communication channel event send across channel include callback callback abstraction allows outer handle expose synchronous operation event delegation inherently asynchronous delegating level open door exposing synchronous interaction thread pool allowing component handle concurrency optimization internally without burdening component user rust pub struct handle sender channelsender impl handle pub verifytotargetmut self height height result let sender receiver channelbounded let callback callbacknewmove result let event match result okheader eventverifiedheader errerr eventfailedverification sendersendeventunwrap selfsendersendeventverifytotargetheight callbackunwrap match receiverrecvunwrap eventverifiedheader return okheader eventfailedverification return errtoo bar return errthat unexpected supervisor pub struct supervisor sender channelsender receiver channelreceiver impl supervisor pub handlemut self handle let sender selfsenderclone return handlenewsender pub runmut self threadspawnmove loop let event selfreceiverrecvunwrap match event eventterminatesender printlnterminating light client sendersendunwrap return eventverifytotargetheight callback let outcome selfverifytotargetheight callbackcalloutcome noop implemented verification predicate verifier component component scheduler component supervisor example consequence positive better isolation concern deterministic testing composition component clear easy specifyverify concurrency model component control concurrency locally optimized bottleneck still exposing synchronous interface negative neutral reference light client spec blockchain reactor refactor reactor experiment