jetstream subscribe workflow metadatavalue author kozlovic partially implemented tag jetstream client document attempt describe workflow jetstream subscription library creation behavior runtime deletion subscription design creation library apis allows creation jetstream subscription depending language may various type subscription like channel based various queue subscription etc different apis one set configuration creating subscription user provide several thing subject case required see stream name section optional stream name optional consumer name optional consumer configuration see queue name subscription meant queue subscription indication push pull subscription handler receiving message asynchronously whatever mean library language misconfiguration checked subscribe api return error outright instance queue name provided configuring heartbeat flow control mistake since server would send message random member subject provided along stream name library wont able locatecreate consumer pull subscription ack policy none error time writing consumer configuration object look like ordered alphabetically seen jsgo type consumerconfig struct ackpolicy ackpolicy jsonackpolicy ackwait timeduration jsonackwaitomitempty delivergroup string jsondelivergroupomitempty deliverpolicy deliverpolicy jsondeliverpolicy deliversubject string jsondeliversubjectomitempty description string jsondescriptionomitempty durable string jsondurablenameomitempty filtersubject string jsonfiltersubjectomitempty flowcontrol bool jsonflowcontrolomitempty heartbeat timeduration jsonidleheartbeatomitempty maxackpending int jsonmaxackpendingomitempty maxdeliver int jsonmaxdeliveromitempty maxwaiting int jsonmaxwaitingomitempty server return error provided deliversubject provided optstartseq uint jsonoptstartseqomitempty server return error provided deliver policy bystartsequence optstarttime timetime jsonoptstarttimeomitempty server return error provided deliver policy bystarttime ratelimit uint jsonratelimitbpsomitempty bit per sec replaypolicy replaypolicy jsonreplaypolicy samplefrequency string jsonsamplefreqomitempty stream name stream specified subject subscribe api call required error returned case library subject provided way find stream subscription request sent server prefixstreamnames subject json content subjectsubject response list stream name positive contains single entry library stream name otherwise error indicating matching stream name returned however even provided stream name subject may needed instance consumer created library filtersubject set consumer lookup performed incoming filtersubject empty ensure match subject consumer name consumer name specified indicates library intent existing consumer library lookup consumer server get consumerinfo lookup fails considered error unless subscription pull subscriber case library still proceeds subscription queue name user attempt create queue subscription consumer name durable specified common pattern error noticed user member jsqueuesubscribefoo bar member jsqueuesubscribefoo bar report member receiving message subscription call would create ephemeral jetstream consumer could break api force user specify consumer name instead client taken approach describe consumer name provided natsbindstream consumer durable natsdurabledurablename library would queue name durable name push consumer active information queue group binding lookup succeeds newer server consumerinfo field called pushbound boolean pushbound bool jsonpushboundomitempty boolean indicates server already registered interest push consumer deliver subject consumerinfoconfig consumerconfig object inspected detect delivergroup set hand library return proper error user attempt create invalid subscription pushbound true delivergroup user try create non queue subscription return error duplicate subscription regardless pushbound value user try create non queue subscription delivergroup non empty return error trying create non queue subscription consumer created queue group user try create queue subscription delivergroup non empty match user queue name return error trying create queue subscription consumer created different queue group user try create queue subscription delivergroup empty return error trying create queue subscription consumer create without deliver group check filtersubject empty must match subject passed subscribe api return error indicating subject mismatch user trying create pull subscription deliversubject empty return error indicating user cant create pull subscription push based consumer opposite user creating pull subscription deliversubject empty return error indicating pull susbcription required generally user provided configuration match configuration get consumerinfoconfig error returned indicate change applied deliver subject changed existing consumer flow control set consumer queue deliver group requested return error indicating flow control supported queue heartbeat configured consumer queue deliver group requested return error indicating heartbeat supported queue nats subscription point nats subscription created deliver subject found consumer info inbox note subscription created prior attempt create consumer applicable durable subscription way server detect durable already subscription interest server simply update delivery subject durable consumer creating consumer library determined attempt create consumer consumer name provided durable name exists library fill consumer config provided user push consumer deliversubject specified library pick inbox name pull consumer deliversubject left blank library set filtersubject user provided subject ensure ackpolicy set possibly field maxackpending set delivergroup queue name subscribe call queue subscription request sent prefixconsumerdurablecreatestream namedurable name durable subscription prefixconsumercreatestream name ephemeral operation successful library get api response consumerinfo since library successfully created jetstream consumer keep track fact delete consumer unsubscribe drain ephemeral consumer name saved consumerinfos response since available beforehand result indicates consumer already exists mean race process got lookup found error attempting create jetstream consumer got already exists error case library perform consumer lookup perform check described push consumer active information queue group binding section note pull subscription basic check consumer type validity done check specific push consumer unless queue subscription api call return error consumer already exists push consumer nats queue subscription created prior addconsumer call destroyed replaced new nats queue subscription consumer info deliversubject jsack server sends message subscriber message replyto value called ack reply subject aka jsack message must contain replyto jsack format considered jetstream message jsack always start jsack jsack without modification publish subject message acks jetstream message jsack encodes delivery information stream consumer name stream sequence contains information allowing proper routing multiple account preventing ack account ack message stream consumer name another account multiple format jsack period delimited string version contains field must supported ensure client backward compatible previous version server version domain account hash inserted position directly jsack bringing number token may additional token added future must ensure client support token version version token new token may added end token format replyto start jsack token token token correct data type client raise error token version version token format jsackstream nameconsumer namenum deliveredstream sequenceconsumer sequencetimestampnum pending token version version token format jsackdomainaccount hashstream nameconsumer namenum deliveredstream sequenceconsumer sequencetimestampnum pending domain server still set token special value underscore server make sure user cant pick domain name user client expose domain value either emptynull string documenting meaning domain note domain always present simplifies library code bother variable number token somewhere close beginning subject possibly shifting find location field care append new token end simplify exportimport subject jsackdomainaccount otherwise would possibly something like jsackdomainaccount account hash client time routing last token ack handling ack accomplished publishing message jsack subject payload consisting byte ack type client must support terminal ack type ack nak term progress ack type wpi terminal ack type published message client ignore user request send type ack suggested implementation mark message sent terminal ack type way successful publish ack rely state subsequent acks consumer configured ack policy none client ignore request send type ack client return throw escalate error unless publishing ack error server instance due connectivity automatic management client provide automatic management asm default client behavior asm mean handling message heartbeat flow control pull gap awareness etc client optionally provide mode allow user handle required offered support backward compatibility preexisting user heartbeat jetstream consumer configured idle heartbeat interval server send heartbeat server pending message library set timer monitor either message received ensuring server connected message received within certain time period alarm surfaced user way make sense client language example notifying user asynchronous error callback time allowed alarm raised time idle heartbeat interval client may optionally provide way user configure time message gap checking message gap applies consumer participating queue library interrogate jetstream message heartbeat message contains last consumer sequence last stream sequence jetstream message information found ack replyto subject see ack heartbeat message information found header natslastconsumer natslaststream library detects gap consumer sequence surface notification user way make sense client language example notifying user asynchronous error callback note gap checking disabled queue deliver group subscription ordered consumer ordered consumer see adr ready rely message gap handling implementation ordered consumer possibly want handle detection gap client may want provide optional detection message gap flow control jetstream consumer flow control enabled applicable pull consumer library may receive flow control message instead regular jetstream message time message would normally passed user processing either synchronously via next message via asynchronous callback client respond provided replyto publishing value subject message empty payload flow control message reached server likely sent message user requesting message synchronously via next message client try respond next buffered message responds flow control within wait time supplied user part next message call note format flow control subject inspected since may change server discretion always publishable subject possible either flow control response missed consumer considered stalled server perspective server requires flow control turned idle heartbeat set flow control message missed heartbeat message contain header called natsconsumerstalled value identical flow control subject client detects heartbeat stalled header publishes server would respond flow control possible idle heartbeat duration flow control multiple heartbeat message contain flow control subject required respond specific subject suggested client track last flow control subject responded avoid replying multiple time flow control server ignore duplicate unnecessary traffic pull mode pull mode surfaced user considered fetch iterate count miscellaneous error know error condition passed user raised error conflicting thing like trying pull push consumer exceeding max ack pending etc responder like try reply subscription went away unknown error recognized client passed user raised error unsubscribe drain subscription unsubscribed drained library created consumer called addconsumer got jetstream consumer deleted end call note think problematic queue subscription since first member start create consumer case consumer already exists marked needing delete consumer unsubscribedrain member may attached consumer instance consumer exists create queue group durable named shared since consumer exist call create one member jsqueuesubscribefoo bar natsdurableshared another application add member since consumer existed prior call following call create consumer subscription marked delete consumer member jsqueuesubscribefoo bar natsdurableshared however point member away memberdrain completes library delete consumer shared library created cause member stop receiving message unsubscribe normal unsubscribe processing done subscription marked needing delete consumer library send deleteconsumer request return error drain deletion consumer delayed past point subscription fully drained removed connection since asynchronous process deletion consumer fails error pushed asynchronous error callback consequence possible existing library change would break simver left library maintainer evaluate