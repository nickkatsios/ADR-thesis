adr protocol buffer transaction encoding changelog march initial draft march api update april added detail interface oneof handling april switch may describe public key encoding june store txbody authinfo byte signdoc document txraw broadcast storage type august adr serializing signdoc august move sequence field signdoc signerinfo discussed september remove publickey type favor secpkpubkey edpubkey multisiglegacyaminopubkey october add getaccount getaccountwithheight method accountretriever interface feb cosmos sdk tendermints pubkey interface anymore cryptotypespubkey update reflect may rename clientctxjsonmarshaler clientctxjsoncodec june add clientctxcodec codeccodec february account creation step adr continuation motivation design established adr namely aim design protocol buffer migration path clientside cosmos sdk specifically clientside migration path primarily includes generation signing message construction routing addition cli rest handler business logic querier mind tackle migration path via two main area querying however adr solely focus transaction querying addressed future adr build proposal based detailed discussion original design transaction changed substantially oneof jsonsigning approach approach described transaction since interface value encoded googleprotobufany state see adr sdkmsgs encoding transaction one main goal encode interface value core set type reused apps client safely compatible many chain possible one goal specification provide flexible crosschain transaction format serve wide variety case without breaking client compatibility order facilitate signing transaction separated txbody reused signdoc signature protobuf typestypesproto package cosmossdkv message txbody body authinfo authinfo list signature match length order authinfos signerinfos allow connecting signature meta information like public key signing mode position repeated byte signature variant pin signer exact binary representation body authinfo signing broadcasting verification binary serializetx txraw stored tendermint hash shaserializetx txraw becomes txhash commonly transaction message txraw protobuf serialization txbody match representation signdoc byte body protobuf serialization authinfo match representation signdoc byte authinfo list signature match length order authinfos signerinfos allow connecting signature meta information like public key signing mode position repeated byte signature message txbody list message executed required signer message define number order element authinfos signerinfos signature required signer address added list first time occurs convention first required signer usually first message referred primary signer pay fee whole transaction repeated googleprotobufany message string memo int timeoutheight repeated googleprotobufany extensionoptions message authinfo list defines signing mode required signer number order element must match required signer txbodys message first element primary signer one pay fee repeated signerinfo signerinfos fee calculated based cost evaluating body signature verification signer estimated via simulation fee fee message signerinfo public key optional account already exist state unset verifier required signer address position lookup public key googleprotobufany publickey modeinfo describes signing mode signer nested structure support nested multisig pubkeys modeinfo modeinfo sequence sequence account describes number committed transaction signed given address prevent replay attack uint sequence message modeinfo oneof sum single single multi multi single mode info single signer structured message allow additional field locale signmodetextual future message single signmode mode multi mode info multisig public key message multi bitarray specifies key within multisig signing compactbitarray bitarray modeinfos corresponding mode signer multisig could include nested multisig public key repeated modeinfo modeinfos enum signmode signmodeunspecified signmodedirect signmodetextual signmodelegacyaminojson discussed order include much possible signdoc signerinfo separated signature raw signature live outside signed aiming flexible extensible crosschain transaction format new transaction processing added txbody soon case discovered even cant implemented yet coordination overhead txbody includes extensionoptions field transaction processing already covered app developer nevertheless attempt upstream important improvement signing signing mode aim provide following guarantee malleability txbody authinfo cannot change transaction signed predictable gas signing transaction paying fee final gas fully dependent signing guarantee give maximum amount confidence message signer manipulation intermediary cant result meaningful change signmodedirect direct signing behavior sign raw txbody byte broadcast wire advantage requiring minimum additional client capability beyond standard protocol buffer implementation leaving effectively zero hole transaction malleability subtle difference signing encoding format could potentially exploited attacker signature structured signdoc reuses serialization txbody authinfo add field needed signature protobuf typestypesproto message signdoc protobuf serialization txbody match representation txraw byte body protobuf serialization authinfo match representation txraw byte authinfo string chainid uint accountnumber order sign default mode client take following step serialize txbody authinfo valid protobuf implementation create signdoc serialize adr sign encoded signdoc byte build txraw serialize broadcasting signature verification based comparing raw txbody authinfo byte encoded txraw based canonicalization algorithm creates added complexity client addition preventing form upgradeability addressed later document signature verifier deserialize txraw pull body authinfo create list required signer address message required signer pull account number sequence state obtain public key either state authinfos signerinfos create signdoc serialize adr verify signature list position serialized signdoc signmodelegacyamino order support legacy wallet exchange amino json temporarily supported transaction signing wallet exchange chance upgrade protobuf based signing disabled meantime foreseen disabling current amino signing would cause much breakage feasible note mainly requirement cosmos hub chain may choose disable amino signing immediately legacy client able sign transaction current amino json format encoded protobuf rest txencode endpoint broadcasting signmodetextual discussed extensively desire humanreadable signing encoding especially hardware wallet like ledger display transaction content user signing json attempt fall short ideal signmodetextual intended placeholder humanreadable encoding replace amino json new encoding even focused readability json possibly based formatting string like messageformat order ensure new humanreadable format suffer transaction malleability issue signmodetextual requires humanreadable byte concatenated raw signdoc generate sign byte multiple humanreadable format maybe even localized message may supported signmodetextual implemented unknown field filtering unknown field protobuf message generally rejected transaction processor important data may present unknown field ignored cause unexpected behavior client present malleability vulnerability attacker bloat size adding random uninterpreted data unsigned content master txbody also scenario may choose safely ignore unknown field httpsgithubcomcosmoscosmossdkissuesissuecomment provide graceful forward compatibility newer client propose field number bit set case range considered noncritical field safely ignored unknown handle unknown field filter always reject unknown field unsigned content toplevel unsigned part authinfo present based signing mode reject unknown field message including nested anys field bit set likely custom protobuf parser pas take message byte filedescriptors return boolean result public key encoding public key cosmos sdk implement cryptotypespubkey interface propose protobuf encoding interface example baseaccountpubkey signerinfopublickey following public key implemented secpk secpr legacymultisignature protobuf message pubkey byte key multisiglegacyaminopubkey array anys member support protobuf public key type apps attempt handle registered set public key tested provided signature verification ante handler decorator enforce cli rest currently rest cli handler encode decode type via amino json encoding concrete amino codec type dealt client interface similar described adr client logic take codec interface know handle type also know generate transaction signature message account sending first transaction account number must set due account created yet type accountretriever interface getaccountclientctx addr sdkaccaddress clientaccount error getaccountwithheightclientctx addr sdkaccaddress clientaccount int error ensureexistsclientctx clientcontext addr sdkaccaddress error getaccountnumbersequenceclientctx clientcontext addr sdkaccaddress uint uint error type generator interface newtx txbuilder newfee clientfee newsignature clientsignature marshaltxtx typestx byte error type txbuilder interface gettx sdktx setmsgssdkmsg error getsignatures sdksignature setsignaturessdksignature getfee sdkfee setfeesdkfee getmemo string setmemostring update new field codec txgenerator accountretriever update appmodulegettxcmd take field prepopulated client method one init method reinitialize prepopulated txgenerateorbroadcasttx generate broadcast transaction example import githubcomspfcobra import githubcomcosmoscosmossdkclient import githubcomcosmoscosmossdkclienttx func newcmddosomethingclientctx clientcontext cobracommand return cobracommand rune funccmd cobracommand args string error clientctx ctxinitwithinputcmdinorstdin msg newsomemsg txgenerateorbroadcasttxclientctx msg future improvement signmodetextual specification concrete specification implementation signmodetextual intended nearterm future improvement ledger app wallet gracefully transition away amino json signmodedirectaux documented httpsgithubcomcosmoscosmossdkissuesissuecomment could add mode signmodedirectaux support scenario multiple signature gathered single transaction message composer yet know signature included final transaction instance may multisig wallet want send txbody signer see sign first soon signature ahead build full transaction signmodedirect signer sign full authinfo includes full list signer signing mode making scenario hard signmodedirectaux would allow auxiliary signer create signature txbody publickey allows full list signer authinfo delayed signature collected auxiliary signer signer besides primary signer paying fee primary signer full authinfo actually needed calculate gas fee dependent many signer key type signing mode auxiliary signer however worry fee gas thus sign txbody generate signature signmodedirectaux step would followed encode signdocaux requirement field must serialized order protobuf typestypesproto message signdocaux byte bodybytes publickey included signdocaux special case multisig public key multisig public key signer toplevel multisig public key signing public key prevent form malleability signature could taken multisig key intended signed guard scenario configuration information encoded public key proposed two key generate signature different security property including composer authinfo cannot reference public key variant signer intend publickey publickey string chainid uint accountnumber sign encoded signdocaux byte send signature signerinfo primary signer sign broadcast final transaction signmodedirect authinfo added enough signature collected signmodedirectrelaxed documented httpsgithubcomcosmoscosmossdkissuesissuecomment variation signmodedirect multiple signer wouldnt coordinate public key signing mode advance would involve alternate signdoc similar signdocaux fee could added future client developer found burden collecting public key mode advance burdensome consequence positive significant performance gain support backward forward type compatibility better support crosslanguage client multiple signing mode allow greater protocol evolution negative googleprotobufany type url increase transaction size although effect may negligible compression may able mitigate neutral reference