increase message visibility timeout file check queue file uploaded tdr trigger series file check lambda function coordinated message sent sqs queue see adr full description workflow work well small consignment upload hundred file overload api many instance file download api update lambda start running parallel call api time failure queue bug file check sqs queue currently maxreceivecount set mean message processed lambda time succeeds every attempt fails queue configured send message dead letter queue called tdrbackendcheckfailureenv mostly working intended noticed message occasionally sent failure queue even lambda eventually succeded problem make hard distinguish file check completely failed file check succeeded retried could work answer specific file checking file check log mean failure queue useful monitoring general health backend check example message file check queue upload small file yellow red peak show api update download file message waiting processed antivirus checksum file format message dont appear picked lambda quickly see message processed number message failure queue grows look like file check message failed processed state failure queue isnt reflected database though file check result stored user taken file check result page normal cause bug completely sure cause far tell issue message sometimes retried lambda quickly earlier attempt finished retries actually triggered lambda failure sqs retries based property queue called visibility timeout consumer like lambda receives message queue sqs keep message queue temporarily mark visible consumer successfully handle message deletes queue lambda automatically exit error however consumer delete message visibility timeout eventually expires sqs sends message next time consumer request new message mean set visibility timeout least long lambda function timeout otherwise message become visible first lambda attempt running thought configured backend check handle current timeouts lambda sqs process lambda timeout visibility timeout download file min min checksum min min antivirus min min ffid min min api update sqs visibility timeouts least long lambda timeouts many message delivered failure queue come api update process visibility timeout second longer lambda timeout visibility timeout longer lambda timeout elapsed time take account soon message pulled queue visibility timeout clock start ticking lambda create execution environment initiaize function lambda code start running checked initialization time api update lambda cloudwatch insight field duration billedduration initduration sort initduration desc showed particular lambda take second initialize presumably java lambda runtime quite slow start adding second second lambda timeout still doesnt take second message visibility timeout best guess lambda provisioning add another second startup cause total time past message visibility unfortunately havent found way measure seems plausible lambda uneven traffic may well uploads hour burst file uploaded evidence problem come timestamps message end failure queue always come first minute batch uploads coincides lambda function cold symptom problem similar described blog post lambda concurrency limit key difference situation described blog post reason lambda take longer message visibility timeout delayed throttling checked throttle metric cloudwatch hitting throttle limit yet handling large burst traffic think seeing similar delay caused provisioning guide sqs lambdasqslamba aws actually recommend set visibility timeout time larger lambda timeout avoid message expiry lambda concurrency blog post mentioned quote aws advice also suggests time longer sufficient set visibility timeout time lambda timeout file check lambda including file download api update lambda initial testing enough fix invalid failure message change mean retries take much longer moment mitigate add extra error handling file check lambda call sqs changemessagevisibility api endpoint set visibility message processing failed mean message placed back queue immediately retried quickly error handling doesnt run lambda time message retried original timeout expires make easier test debug change set message batch size lambda new value start might tune later learn file check performance process lambda timeout visibility timeout batch size download file min min checksum min min antivirus min min ffid min min api update min