adr baseapp checkdelivertx middlewares changelog initial draft update txhandler interface adr abandoned middlewares deemed hard reason abandoned replacement discussed abstract adr replaces current baseapp runtx antehandlers design middlewarebased design baseapps implementation abci checkdelivertx simulate method call runtx method hood first run antehandlers executes msg however transaction tip refunding unused gas case require custom logic run msg execution currently way achieve naive solution would add postmsg hook baseapp however cosmos sdk team think parallel bigger picture making app wiring simpler includes making baseapp lightweight modular decide transform baseapps implementation abci checkdelivertx simulate method middlewarebased design two following interface base middleware design defined typestx type handler interface checktxctx contextcontext req request checkreq requestchecktx response responsechecktx error delivertxctx contextcontext req request response error simulatetxctx contextcontext req request response error type middleware funchandler handler define following argument return type type request struct sdktx txbytes byte type response struct gaswanted uint gasused uint msgresponses array containing msg service handler response type packed get protoserialized data field abci checkdelivertx response msgresponses codectypesany log string event abcievent type requestchecktx struct type abcichecktxtype type responsechecktx struct priority int please note checktx handle separate logic related mempool priotization signature different delivertx simulatetx baseapp hold reference txhandler type baseapp struct field txhandler txhandler baseapps abci checkdelivertx simulate method simply call apptxhandlercheckdeliversimulatetx relevant argument example delivertx func app baseapp delivertxreq abcirequestdelivertx abciresponsedelivertx var abcires abciresponsedelivertx ctx appgetcontextfortxruntxmodedeliver reqtx err apptxhandlerdelivertxctx txrequesttxbytes reqtx err nil abcires sdkerrorsresponsedelivertxerr uintresgasused uintresgaswanted apptrace return abcires abcires err converttxresponsetodelivertxres err nil return sdkerrorsresponsedelivertxerr uintresgasused uintresgaswanted apptrace return abcires converttxresponsetodelivertx convert txresponse abciresponsedelivertx func converttxresponsetodelivertxtxres txresponse abciresponsedelivertx error data err makeabcidatatxres err nil return abciresponsedelivertx nil return abciresponsedelivertx data data log txreslog event txresevents nil makeabcidata generates data field sent abci checkdelivertx func makeabcidatatxres txresponse byte error return protomarshalsdktxmsgdatamsgresponses txresmsgresponses implementation similar baseappchecktx baseappsimulate baseapptxhandlers three method implementation obviously monolithic function modularity propose middleware composition design middleware simply function take txhandler return another txhandler wrapped around previous one implementing middleware practice middlewares created function take argument parameter needed middleware return txmiddleware example creating arbitrary mymiddleware implement mytxhandler txhandler middleware note hold reference next txhandler stack type mytxhandler struct next next txhandler middleware stack next txhandler field relevant middleware added newmymiddleware return middleware func newmymiddlewarearg arg txmiddleware return func txh txhandler txhandler return mytxhandler next txh optionally set arg arg needed middleware assert mytxhandler txhandler var txhandler mytxhandler func mytxhandler checktxctx contextcontext req request checkreq requestchecktx response responsechecktx error checktx specific preprocessing logic run next middleware checkres err txhnextchecktxctx req checkreq checktx specific postprocessing logic return checkres err func mytxhandler delivertxctx contextcontext req request response error delivertx specific preprocessing logic run next middleware err txhnextdelivertxctx req delivertx specific postprocessing logic return err func mytxhandler simulatetxctx contextcontext req request response error simulatetx specific preprocessing logic run next middleware err txhnextsimulatetxctx req simulatetx specific postprocessing logic return err composing middlewares baseapp simply hold reference txhandler txhandler defined middleware stack cosmos sdk expose base innermost txhandler called runmsgstxhandler executes message app developer compose multiple middlewares top base txhandler middleware run preandpostprocessing logic around next middleware described section conceptually example given middlewares base txhandler stack look like text apre bpre cpre base txhandler example runmsgstxhandler cpost bpost apost define composemiddlewares function composing middlewares take base handler first argument middlewares outer inner order stack final txhandler txhandler middlewarecomposemiddlewaresh middleware set baseapp via settxhandler setter simappappgo txhandler middlewarecomposemiddlewares appsettxhandlertxhandler app developer define middlewares cosmos sdks predefined middlewares middlewarenewdefaulttxhandler middlewares maintained cosmos sdk app developer define compose middlewares choice cosmos sdk provides set middlewares caters ecosystem common case middlewares middleware description runmsgstxhandler base txhandler replaces old baseapps runmsgs executes transaction msg txdecodermiddleware middleware take transaction raw byte decodes sdktx replaces baseapptxdecoder field baseapp stay thin possible since middlewares read content sdktx txdecodermiddleware run first middleware stack antehandlers antehandler converted middleware middlewares perform signature verification fee deduction validation incoming transaction indexeventstxmiddleware simple middleware chooses event index tendermint replaces baseappindexevents unfortunately still exists baseapp index beginendblock event recoverytxmiddleware index recovers panic replaces baseappruntxs panic recovery described adr gastxmiddleware replaces setup antehandler set gasmeter sdkcontext note gasmeter set sdkcontext inside antehandlers mess around fact antehandlers panic recovery system gasmeter could read baseapps recovery system mess removed one middleware set gasmeter another one handle recovery similarity difference antehandlers middlewares middlewarebased design build upon existing antehandlers design described adr even though final adr simple decorator approach middleware design actually similar decorator pattern proposal also weave similarity antehandlers designed chainingcomposing small modular piece allow code reuse checkdelivertx simulate set appgo easily customizable app developer order important difference antehandlers antehandlers run msg execution whereas middlewares run middleware approach separate method checkdeliversimulatetx whereas antehandlers pas simulate bool flag sdkctxischeckrechecktx flag determine transaction mode middleware design let middleware hold reference next middleware whereas antehandlers pas next argument antehandle method middleware design standard contextcontext whereas antehandlers sdkcontext consequence backwards compatibility since refactor remove logic away baseapp middlewares introduces apibreaking change app developer notably instead creating antehandler chain appgo app developer create middleware stack diff antehandler err antenewantehandler antehandleroptions accountkeeper appaccountkeeper bankkeeper appbankkeeper signmodehandler encodingconfigtxconfigsignmodehandler feegrantkeeper appfeegrantkeeper siggasconsumer antedefaultsigverificationgasconsumer txhandler err authmiddlewarenewdefaulttxhandlerauthmiddlewaretxhandleroptions debug apptrace indexevents indexevents legacyrouter applegacyrouter msgservicerouter appmsgsvcrouter legacyantehandler antehandler txdecoder encodingconfigtxconfigtxdecoder err nil panicerr appsetantehandlerantehandler appsettxhandlertxhandler minor api breaking change also provided changelog usual cosmos sdk provide release migration document app developer adr introduce statemachine client clibreaking change positive allow custom logic run msg execution enables tip gas refund case possibly one make baseapp lightweight defer complex logic small modular component separate path checkdeliversimulatetx different return type allows improved readability replace sdkctxisrechecktx simulate separate method flexibility returning priority responsechecktx negative hard understand first glance state update would occur middleware run given sdkcontext middleware arbitrary number nested middleware called within function body possibly pre postprocessing calling next middleware chain thus understand middleware one must also understand every middleware along chain also order middlewares matter get quite complicated understand apibreaking change app developer neutral neutral consequence discussion decomposing baseapps abci method middlewares replace sdktx interface concrete protobuf type txhandler method signature test case update existing baseapp antehandlers test new middleware api keep test case logic avoid introducing regression existing cli test also left untouched new middlewares introduce unit test since middlewares purposefully small unit test suit well reference initial discussion httpsgithubcomcosmoscosmossdkissues implementation baseapp refactor antehandlers migration