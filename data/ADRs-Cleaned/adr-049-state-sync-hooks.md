adr state sync hook changelog jan initial draft apr safer extension snapshotter interface implemented abstract adr outline hooksbased mechanism application module provide additional state outside iavl tree state sync new client statesync download snapshot module state peer currently snapshot consists stream snapshotstoreitem snapshotiavlitem mean application module define state outside iavl tree cannot include state part statesync process note even though module state data outside tree determinism require hash external data posted iavl tree simple proposal based existing implementation add two new message type snapshotextensionmeta snapshotextensionpayload appended existing multistore stream snapshotextensionmeta acting delimiter extension chunk hash able ensure data integrity dont delimiter mark end snapshot stream besides provide snapshotter extensionsnapshotter interface module implement snapshotters handle taking snapshot restoration module could multiple snapshotters module additional state implement extensionsnapshotter extension snapshotters setting application snapshot manager call registerextensionsextensionsnapshotter register extension snapshotters protobuf snapshotitem item contained rootmultistore snapshot top existing snapshotstoreitem snapshotiavlitem add two new item message snapshotitem item specific type snapshot item oneof item snapshotstoreitem store snapshotiavlitem iavl gogoprotocustomname iavl snapshotextensionmeta extension snapshotextensionpayload extensionpayload snapshotextensionmeta contains metadata external snapshotter one module may multiple snapshotters module may multiple snapshotextensionmeta message snapshotextensionmeta name extensionsnapshotter registered snapshotter manager setting application name unique extensionsnapshotter alphabetically order snapshot get deterministic snapshot stream string name extensionsnapshotter decide format payload included snapshotextensionpayload message within snapshotternamespace global one module uint format snapshotextensionpayload contains payload external snapshotter message snapshotextensionpayload byte payload create snapshot stream multistore snapshot always placed beginning binary stream extension snapshot alphabetically ordered name corresponding extensionsnapshotter snapshot stream would look like follows multistore snapshot snapshotstoreitem snapshotiavlitem extension snapshot snapshotextensionmeta snapshotextensionpayload extension snapshot snapshotextensionmeta snapshotextensionpayload add extension field snapshot manager extension snapshotters multistore snapshotter special one doesnt name always placed beginning binary stream type manager struct store store multistore typessnapshotter extension mapstringtypesextensionsnapshotter mtx syncmutex operation operation chrestore chan ioreadcloser chrestoredone chan restoredone restorechunkhashes byte restorechunkindex uint extension snapshotters implement extensionsnapshotter interface name registered snapshot manager calling registerextensions setting application snapshotters handle taking snapshot restoration registerextensions register extension snapshotters manager func manager registerextensionsextensions typesextensionsnapshotter error top existing snapshotter interface multistore add extensionsnapshotter interface extension snapshotters three function signature snapshotformat supportedformats snapshotname added extensionsnapshotter extensionpayloadreader read extension payload return ioeof reached either end stream extension boundary type extensionpayloadreader func byte error extensionpayloadwriter helper write extension payload underlying stream type extensionpayloadwriter funcbyte error extensionsnapshotter extension snapshotter appended snapshot stream extensionsnapshotter unique name manages internal format type extensionsnapshotter interface snapshotname return name snapshotter unique manager snapshotname string snapshotformat return default format take snapshot snapshotformat uint supportedformats return list format restore supportedformats uint snapshotextension writes extension payload underlying protobuf stream snapshotextensionheight uint payloadwriter extensionpayloadwriter error restoreextension restores extension state snapshot payload reader return ioeof reached extension boundary restoreextensionheight uint format uint payloadreader extensionpayloadreader error consequence result implementation able create snapshot binary chunk stream state maintain outside iavl tree cosmwasm blob example new client able fetch sanpshots state module implemented corresponding interface peer node backwards compatibility adr introduces new proto message type add extension field snapshot manager add new extensionsnapshotter interface backwards compatible extension application state data outside iavl tree module snapshot stream backwardscompatible positive state maintained outside iavl tree like cosmwasm blob create snapshot implementing extension snapshotters fetched new client via statesync negative neutral module maintain state outside iavl tree implement extensionsnapshotter snapshot manager call registerextensions setting application discussion adr draft proposed stage section contain summary issue solved future iteration usually referencing comment pullrequest discussion later section optionally list idea improvement author reviewer found analysis adr test case optional test case implementation mandatory adrs affecting consensus change adrs choose include link test case applicable reference httpsgithubcomcosmoscosmossdkpull httpsgithubcomcosmoscosmossdkissues