freeing object resource deciders uniffi developer approved previous discussion issue problem statement uniffi object always hold reference released sometimes hold resource closed current design conflates two issue address concern better improve ergonomics dealing two separately adr written languageneutral term issue discussed general however clear kotlin implementation adr affect code see appendix proposed change releasing reference rust object passed foreign side foreign code store reference rust arc conversely foreign object passed rust callback trait implementation cause rust hold reference foreign object uniffi ensure generated object destroyed reference side ffi released acceptable release delayed andor nondeterministic long eventually happens particular acceptable handled garbage collection closing resource object hold significant resource scarce operatingsystem owned resource may acceptable couple resource lifetime foreign object case must possible close resource foreign object still alive reference released consideration apply direction across ffi garbagecollected foreign object store resource must way close resource garbage collection happens rust object hold resource must way close resource even may arc reference object container discussion focused individual object nontrivial application many object interact example consider simple enum dictionary usual case object hold reference nonresource holding object given discussion acceptable reference released standard memory management foreign language however enum dictionary vec hashmap etc may contain object contains resource component author able offer method close resource object able introduce method container object might hold object question whether uniffi try offer capability foreign sugar closing resource object hold significant resource offer capability closing resource even object remains alive example foreign language expose file object tend provide close method ensures handle released operating system almost language possible something like tryfinally pattern ensure object closed soon practical pattern common language offer syntactic sugar express purpose example python offer manager kotlin offer extension object implement closable etc ideally uniffi would offer way consumer optin implementing capability must optin optin process must tell uniffi exactly resource closed common via close method uniffi cant assume python manager doesnt insist particular technique driver uniffi present simple clear abstraction user uniffi let user explicitly decide want deal resource way uniffi automatically differentiate object hold significant resource versus thus component must opt somehow facility optin could anywhere fully manual closing supplying close method documenting must called asap something formal telling uniffi object uniffi supplying builtin support concept nothing uniffi ensure rust reference released foreign object destroyed responsibility must fall foreign language one way another seems unreasonable uniffi expected track object container propagate close operation would quickly become ergonomic technical quagmire would give object incase object might added future would user even uniffi know whether container actually held object etc considered uniffi handle releasing reference closing resource largely left user rely language strategy automatically closing resource longer reachable language something like destructor facility destructorlike semantics language capability binding forced implement special facility every object explicitly freed strategy unlikely useful practice dont automatically implement method close resource object resource closed object remains alive component author supply mechanism investigate providing facility object optin foreign sugar closing resource exact mechanic beyond scope adr offer general advice summarizing document like define close method document otherwise leave problem user solve dont anything special object container field record contains resource user responsibility properly close field resource object separate type require udl user label interface either resource object procmacro user derive either resource object object instance assumed contain significant resource rely foreign memory management releasing reference resource instance would formal mechanism closing resource releasing reference time optionally may also foreign memory management fallback close resource release reference user explicitly make object assume object get close method like treat object though significant resource freed pro con uniffi handle releasing reference closing resource largely left user good give user control object namespace uniffi doesnt define method assume method exist etc bad relies contractual agreement ensure resource leak avoided doesnt help obligation arent met bad requires closeable object deal extra state example object provides close method may called object destroyed object must deal possibility object continues capacity close object destroyed close may may called good general solution work rust holding foreign reference bad generating foreign sugar mean object must optin behaviour instead getting free good making resource closing user responsibility extends object container well library author decides make sense define enum variant contains resourceholding object library consumer responsibility ensure resource properly closed resource object separate type good user explicitly decide interface behavior good mean could infer foreign sugar situation automatically implement special interface like autocloseable kotlin manager python bad mean object must signature closing object whereas connection database object might prefer method called closeconnection might even allow parameter bad implicitly defines method close preventing user defining method name different semantics bad doesnt offer reasonable solution rust holding foreign reference good distinction make deciding handle object container easier example enums contain object field resource field make object assume object get close method good easiest implement good easily continue implement special trait like autocloseable bad reason bad bad clear handle object container case enums allowed contain object outcome chosen uniffi handle releasing reference closing resource largely left user appendix mean foreign binding quite abstract mean practice language binding python python binding already hooked del nothing change foreign sugar optin mechanism place generate manager object swift existing deinit implementation suitable nothing change kotlin uniffi implement mechanism automatically free rust reference corresponding foreign object destroyed effective java edition recommends never destructors recommends avoiding cleaner api say may appropriate freeing native peer like uniffi reference android doc recommend referencequeue api lowlevel class cleaner httpswwwandroiddoccomreferencejavalangobjecthtmlfinalize longer generate closable autoclosable interface object foreign sugar optin mechanism place generate closable interface object maybe autoclosable well although mostly useful java interoperability