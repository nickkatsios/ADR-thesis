nats message path tracing metadata value author ripienaar kozlovic implemented tag observability server revision author info ripienaar initial design problem statement nats network become complex super cluster leafnodes multiple account jetstream knowing path message take system hard predict thing wrong hard know message lost denied delayed describes feature nats server allows message traced throughout nats network prior work nats support tracking latency requestreply service interaction documented adr design tracing activated every subsystem touch message produce trace event event aggregated per server published destination subject single message published activating tracing therefor result potentially number trace message one server message traverse holding potentially multiple trace event present following trace type supported ingres first event indicates message enters server client connection route gateway etc subject mapping indicates message got transformed mapping changed target subject stream export indicates message traversed stream export different account service import indicates message traversed service import different account jetstream indicates message reached jetstream stream egress final event indicates message leaf server activation message traced flag enable message activation adding header message adhoc activation mode activation allows header added message declares deliver trace inhibit delivery final application header description natstracedest subject receive trace message natstraceonly prevents delivery final client report would delivered true acceptencoding enables compression trace payload gzip snappy natstraceonly header prevent sending badly formed message subscriber server trace message final destination report client would delivered without actually delivering additionally set message also traverse route gateway leafnode support tracing feature trace activation message holding standard traceparent header defined trace specification trigger tracing based sampled flag case natstracedest header set indicate message flow requires enabling account setting account user user password pwd msgtrace dest atracesubj sampling set msgtrace configuration account enables support trace deliver message traceparent header sampled flag set true note sampling set default trigger trace sampled value traceparent header allow specifically sample subset message traversing nats micro service sample feature enabled message holding natstracedest header previous section behave traceparent header set essence adhoc mode precedence cross account tracing default trace end account boundary crossing import export security measure restrict visibility foreign account require optin allow account export service direction flow exporting account exporter allow tracing service natsadd allowtrace true import stream import direction flow exporter importer importer allow tracing stream account subject ticker allowtrace true nats cli current main nightly build nats includes nats trace command built upon feature helper package receive parse sort present series related trace source found githubcomnatsiojsmgoapiservertracing nats trace demo tracing message route subject demo client nats cli version development cid clustersfo servernsfo versiondev gateway nlon gid gateway nsfo gid clusterlon servernlon versiondev leafnode leaf lid leafnode nlon lid serverleaf versiontracing client nats cli version development cid subjectdemo legend client router gateway leafnode jetstream error egress count gateway leafnode client see message entered sfo cluster via client server nsfo server nsfo published gateway called nlon connection gid server nlon received gateway called nsfo connection gid server nlon published leafnode connection leaf connection lid server leaf received leafnode called leaf connection lid server leaf published message client connection name nats cli version development connection cid set trace message holding trace event total trace message format full detail trace message type best found nats server source code servermsgtracego well call specific message given sample message msgtraceevent json server name nlon host nlonjsdevconet nccpzohdjkzqfuedfnpwxilauvjauwpgifdwuaddannvowkrv cluster lon domain hub ver dev tag lon jetstream true flag seq time request header natstracedest demo msgsize hop event type kind cid name nats cli version development acc one subj type kind cid name nats cli version development sub type kind cid name nlon hop let quick look key field keynote serverthis standard server info structure see many advisory indicates server sent event requestdetails message traced detail natstracehop hopshow many remote destination route gateway leafnodes server sending message eventsa list msgtraceevents happened within server related message see sorting event form directed acyclic graph sort hop information server sends message another route gateway leafnode indicate publish number hop server receives message natstracehop header set request origin server server receives initial message natstracedest header hop count indicating many server route leaf gateway forwarded message necessarily total number server message traverse time server forward message remote server appends number natstracehop header value since origin server one forward message say route remote server would receive message new header natstracehop value origin server forward gateway server would receive message natstracehop value set server turn forwarding message another server would add incremental number existing natstracehop value would result etc take simple example origin server leaf server turn another leaf server daisy chained message tracing forwarded trace message emitted origin server would hop since origin server forwarded directly first leaf remote server trace emitted first leaf would natstracehop header value would also hop set assuming interest last leaf server finally last leaf server would natstracehop would hop field since value would would associate message either unique natstracedest subject parsing traceparent get trace span trace event event list contains event happened given server see different type event according table type server data type description msgtraceingress ingres msgtracesubjectmapping subject mapping msgtracestreamexport stream export msgtraceserviceimport service import msgtracejetstream jetstream msgtraceegress egress also see kind field hold nats server client kind present value kind server constant description serverclient client connection serverrouter router connection servergateway gateway connection serversystem nats system serverleaf leafnode connection serverjetstream jetstream serveraccount account may see kind trace complete current list kind type understand json data ingres client connection cid egress client connection cid egress router connection rid called nlon indicates client connected server nlon published message received client connected server finally sent route client another server nlon specific trace type trace type self explanatory ill call specific name match msgtracego server source msgtraceegress msgtraceingress message indicates message entering leaving server via kind connection includes acc sent subscription sub queue group queue egress note non client egress subscription queue group omitted nats server optimize send single message across server based known interest let remote server match local subscriber would misleading report first match caused server forward message across route egress subscription case acls denying publish error filled json event type kind cid name nats cli version development acc one subj denyx error permission violation publish denyx msgtracejetstream value quite obvious nointerest boolean indicates interest type stream persist message interest