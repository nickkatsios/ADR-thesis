adr light client core verification changelog part adr factored realignment latest code finalize factor new adr adr reduce core verification component approved implemented high level light client described adr reference schematic light node focus core verification library reflected diagram light client verifier bisector light node subjectively initialized attempt sync recent height skipping straight verifier core logic check header trusted skip validator set changed much header cant trusted well request intermediate header necessary sync validator set change note verifier also work ibc though ibc bisection cant performed directly since blockchains cant make http request bisection expected done external relayer process make request full node submit result ibc enabled chain library lend smoothly case difficult incorrectly core verification operates primarily data type already implemented tendermintrs header public key signature vote etc crux verifying validator set computing merkle root verifying commits checking validator signature particular data structure tendermint considerably featuresfunctionality needed hence core verification library abstract describe core verification library including trait public function ibc light node implementation trait existing tendermint datastructures implementation core verification involves two component new light crate containing trait function defining core verification logic lightimpl module within tendermint crate containing implementation trait tendermint specific data structure light crate minimal dependency depend tendermint way kept clean easy test easily variation tendermint different header vote data type light crate expose trait block header validator set commit minimum information necessary support general light client logic according specification key functionality light client verification requires determine set signer commit determine voting power signer another validator set hence abstract lowerlevel detail signature validated header header must contain height time hash current next validator set uniquely identified hash rust pub trait header heightself height bfttimeself time validatorshashself hash nextvalidatorshashself hash hashself hash commit commit blockchain contains underlying signature validators typically form vote perspective light client dont care signature interested knowing total voting power given validator set signed given block hence abstract underlying vote signature expose votingpowerin per spec rust pub trait commit type validatorset validatorset headerhashself hash validateself selfvalidatorset result error votingpowerinself vals selfvalidatorset resultu error theheaderhashis header committed andvalidate performs commitstructurespecific validation instance checking number vote correct right block computing votingpowerin require access validator set get public key verify signature specific relationship validators commit structure isnt business light crate rather kind tendermint commit structure implement light trait making validatorset associated type commit light crate doesnt know much validators relate commits validatorset trait much smaller never even define concept individual validator note mean commit expected access validators signed look validatorset implementation presently true since commits contain validator address along signature address removed instance save space commit trait would access relevant validator set get validator set may different one passed votingpowerin abstracting underlying vote type trait support optimization like batch verification signature aggregate signature instead individual vote long determined voting power given validator set signed correctly commit method votingpowerin performs underlying signature verification return error fail wrong header hash note specification introduces signerscommit validators method return list validators signed commit however method would require access underlying validator set order verify commits ever computing votingpowerin hence dispense favour votingpowerin operates commit validatorset however also mean validatorset expose facility determining whether validator signed correctly order implementation make compute votingpowerin note also tendermint commits particular block includes header hash part set hash latter completely irrelevant light client verified downloading full block hence effectively ignored would great tendermint could disentangle commits proposal block part gossip part set hash commits header header hash thats left future background implementation tendermint commits vote see adr validator signing spec tendermint consensus specification validator set validator set unique hash must match whats header also total power determining result votingpowerin greater fraction total power validatorset implemented associated type commit necessary compute votingpowerin underlying implementation must way determine voting power validators signed since voting power found commit note dont define individual validators since detail validators relates commits encapsulated commit rust pub trait validatorset hashself hash totalpowerself state according spec light client expected store persist trusted header validators necessary fetch last trusted validators verifying new header also needed case conflicting commits discovered published blockchain said needed core verification dont include user light crate like light node decide manage state include convenience structs rust pub struct signedheader commit header commit header pub struct trustedstate commit header lastheader signedheader validators cvalidatorset trusted state combine signed header validator set ready persisted external store trustthreshold amount validator set change occur skipping higher height depends trust threshold per spec define trait encapsulated math percent validators sign rust pub trait trustthreshold copy clone isenoughpowerself signedvotingpower totalvotingpower bool provide conenvient implementation take numerator denominator default course requester light node make request full node bisection intermediate signed header validator set rust pub trait requesterc commit header signedheaderself height resultsignedheaderc error validatorsetself height resultcvalidatorset error practice implemented tendermint rpc client making request commit validators endpoint full node testing requester implemented json file verification ibc full node syncing perform common set check validate hash header sequential validate next validator set header sequential check trust threshold reached votingpowerin validator set may different one actually created commit check validators signed votingpowerin actual validator set implemented common function verifysingleinner rust verifysingleinnerh trustedstate trustedstatec untrustedsh signedheaderc untrustedvals cvalidatorset untrustednextvals cvalidatorset trustthreshold result error note however light client security model highly sensitive time public function exposed ibc bisection call verifysingleinner must take current time check havent expired ibc since cant make request public function take untrusted state full return trustedstate verifies rust pub verifysingleh trustedstate trustedstatec untrustedsh signedheaderc untrustedvals cvalidatorset untrustednextvals cvalidatorset trustthreshold trustingperiod duration systemtime resulttrustedstatec error light node pas requester specify height want sync fetch header try verify skipping method run bisection algorithm recursively request header lower height needed return list header verified along way rust pub verifybisectionc trustedstate trustedstatec untrustedheight height trustthreshold trustingperiod duration systemtime req resultvectrustedstatec error implementing trait core light trait implemented tendermint data structure variation instance tendermint core introduced breaking change commit structure make much smaller implement light trait version commit structure light abstraction also facilitate testing complete tendermint data structure required test light client logic element care mean implement mock commits validators validators numbered commits validators simply list integer representing validators signed validator set aligns closely structure represented tla spec provides lot flexibility mocking type must careful ensure match semantics actual tendermint type still test verification logic sufficiently actual type validation field header left explicitly unvalidated minimal bearing correctness light client include lastcommithash skipping case possible verify header refers correct previous block without reverting sequential case sequential case dont validate either incorrect indicates validators misbehaving though detect light client there fork blockid mentioned includes merkle root entire block verifiable without downloading whole block would defeat purpose light client time verifying time would require download commit previous block take median timestamps commit would add significant overhead light client extra commit validate every block time incorrect indicates validators explicitly violating protocol rule detectable way full node detect first place shouldnt forward light client would probably bigger issue foot likely instance thing light client validating theory could likely indicate larger problem afoot client cant anything anyways hence really focus correctness commits validator set detecting fork consequence positive clear separation verification logic actual data type trait easily mocked without real keyssignatures public interface hard misuse negative abstract trait requires coding opportunity bug trait implementation neutral certain validity check omitted since little bearing