cassandra message inconsistency lazy consensus implemented message denormalized cassandra order access unique identifier messageid example jmap protocol access mailbox identifier unique identifier within mailbox mailboxid uid example imap protocol table organisation messageidtable hold mailbox flag message lookup mailbox uid imapuidtable hold mailbox flag message lookup message failure denormalization process lead inconsistency two table lead following user experience bob receives message denormalization process fails bob read message via jmap bob cannot read message via imap bob mark message seen denormalization process fails message seen jmap message unseen imap current operation adding message cassandramessagemapper first reference message messageidtable imapuidtable cassandramessageidmapper first reference message imapuidtable messageidtable deleting message cassandramessagemapper first delete message imapuidtable messageidtable cassandramessageidmapper read message metadata imapuidtable first delete message imapuidtable messageidtable copying message cassandramessagemapper read message first first reference message messageidtable imapuidtable moving message cassandramessagemapper logically copy delete failure chain migh lead duplicated message present source destination mailbox well different view imapjmap cassandramessageidmapper first reference message imapuidtable messageidtable updating message flag cassandramessagemapper first update conditionally message imapuidtable messageidtable cassandramessageidmapper first update conditionally message imapuidtable messageidtable adopt imapuidtable source truth messageid allows tracking change message accross mailbox upon copy move furthermore table conditional flag update performed writes performed imapuidtable performed messageidtable successful thus modify cassandramessagemapper add copy first write source truth imapuidtable adopt retry policy messageidtable projection update mitigation strategy imapuidtable table source truth rebuild messageidtable projection iterating imapuidtable entry rewrite entry messageidtable iterating messageidtable remove entry referenced imapuidtable adding delay recheck actual fix decrease occurrence concurrency issue expose webadmin task consequence user action concurrent inconsistency fixing task could result concurrency issue new inconsistency could created however table truth would impacted hence rerunning inconsistency fixing task eventually fix issue task could run safely online scheduled recurring basis outside peak traffic admin ensure cassandra message consistency reference plan fixing cassandra acl inconsistency general mailing list discussion inconsistency pull request james concurrency testing fixing cassandra mailbox inconsistency delay strategy decrease concurrency issue occurrence described