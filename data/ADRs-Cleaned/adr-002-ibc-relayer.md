adr ibc relayer rust changelog first draft configuration update definition definition specific document may consistent ibc specification ibc transaction transaction includes ibc datagrams including packet constructed relayer sent physical network chain according chain rule example tendermint chain broadcasttxcommit request sent tendermint rpc server ibc datagram element transaction payload sent relayer includes client connection channel ibc packet data multiple ibc datagrams may included ibc transaction ibc packet particular type ibc datagram includes application packet commitment proof onchain ibc client ibc client client code running chain typically light client verification related functionality relayer light client full light client functionality including connecting least one provider full node storing verifying header etc source chain chain relayer read data fill ibc datagram destination chain chain relayer submits transaction include ibc datagram chain connection protocol initiating chain msgconnectionopeninit initially processed eventually msgconnectionopenack chain msgconnectionopentry msgconnectionopenconfirm processed similar channel handshake protocol relayer offchain process responsible relaying ibc datagrams two chain scanning state submitting transaction ibc architecture module directly sending message networking infrastructure instead create store data retrieved relayer build ibc datagrams document provides initial rust implementation specification relayer interconnects cosmossdk tendermint chain diagram show high level view relayer interaction source destination chain next section detail different interaction assumption dependency section cover assumption dependency chain ibc implementation first implementation focus tested cosmossdk tendermint chain addition functionality required relayer outside scope document availability implementation considered data availability relayer monitor chain state determine packet forwarding required relayer must able retrieve data within time bound referred data availability data legibility ibc protocol defines minimal data set must made available relayers correct operation protocol relayer expects data legible data serialized according ibc specification format includes consensus state client connection channel packet information auxiliary state structure necessary construct proof inclusion exclusion particular keyvalue pair state query functionality ibc host state machine must expose interface inspecting state cosmostendermint chain mean ibc module chain correctly implement respond query ibcmodulesrust implementation query currently exist cosmossdk implemented rust full requirement detailed section relayer query relayer ability send rpchttp abci query receive reply tendermintcosmossdk abci rust abci rust implementation ibcmodulesrust identifier validation required ibcmodulesrust requires rust type query response merkleproofsrust candidate implementation query response include proof included ibc transaction relayer may validated tbd ibc message relayer creates transaction include ibc message manage client connection channel send application packet destination chain message must defined ibc rust implementation ibcmodulesrust ibc logging system ibc packet data timeouts stored directly chain state storage presumed expensive instead committed succinct cryptographic commitment commitment stored consequence ibc requires host state machine must provide event logging system log data course transaction execution log must queryable relayers read ibc packet data timeouts logging system must provide following function ibcmodulesgo emitlogentry emitting log entry called state machine transaction execution type emitlogentry topic string data byte void example emitlogentrysendpacket sequence packetsequence data packetdata timeout packettimeout ibcmodulesgo querybytopic querying past log matching given topic type querybytopic height uint topic string array byte keyring relay process must access account token destination chain sufficient balance pay transaction fee account key information must stored managed securely keyring implementation required crud key operation keyringrust investigation existing rust implementation needed hwchenkeyring chain transaction signing relayer must create chain specific signed transaction cosmostxrust first release cosmossdk transaction signing required one possible implementation iqlusions sdtx crate implementation ibc routing module default ibc handler receiver call pattern module must individually call ibc handler order bind port start handshake accept handshake send receive packet etc provides flexibility module imposes extra work part relayer process track state multiple module ibc specification describes ibc routing module route packet simplify task relayers routing module accepts external datagrams call ibc handler deal handshake packet relay routing module keep lookup table module look call module packet received external relayers ever relay packet routing module ibcroutingmodulego initial version relayer assumes chain implement routing module batching relayer may batch ibc datagrams single transaction supported destination chain allowed configuration case relayer amortise overhead cost signature check fee payment initial version relayer assumes batching supported chain may later included configuration file relayer requirement correct relayer must rconfigstart read parse validate configuration file upon start configure specified chain path rtransport access networking protocol tcpip udpip quicip physical transport required read state one blockchain machine submit data another rprovider maintain transport connection least one full node per chain rquery query ibc data source destination chain rlightclient run light client source chain ribcclient create update ibc client destination chain raccounts account destination chain sufficient balance pay transaction fee rtransact create sign forward ibc datagram transaction rrelay perform correct relaying required message according ibc subprotocol constraint rrestart resume correct functionality restarts rupgrade resume correct functionality upgrade rproofs perform proof verification done destination chain forward message proof verification fails relayer may rconfigcli provide way change configuration runtime rbisection perform bisection optimize transaction cost computation destination chain rrelayprio filter order transaction based criterion accordance fee payment model implementation initial implementation heavily borrow relayer implementation naive algorithm relaying message structure configuration file similar one see gorelayer configuration wip upon start relayer read configuration file includes global per chain parameter file format toml example configuration file toml global loglevel error mode modeclients enabled true refresh true misbehaviour true modeconnections enabled false modechannels enabled false modepackets enabled true clearinterval clearonstart true txconfirmation true chain chaina rpcaddr httplocalhost grpcaddr httplocalhost websocketaddr wslocalhostwebsocket rpctimeout accountprefix cosmos keyname testkey storeprefix ibc clientids cla cla gas gasadjustement gasprice stake trustingperiod chain chainb rpcaddr httplocalhost grpcaddr httplocalhost websocketaddr wslocalhostwebsocket rpctimeout accountprefix cosmos keyname testkey storeprefix ibc clientids clb gas gasadjustement gasprice stake trustingperiod main section configuration file global relaying done periodically frequency dictated thetimeoutparameter thestrategyparameter configures relayer run particular relaying algorithm chain chain level information including account key name gas information trusting period etc source destination chain must listed path connectionsconnectionspaths relayer may configured relay application port number connection channel unidirectional bidirectional mode initialization relayer performs initialization based content configuration file file parsed semantically validated chain connection port channel relaying enabled stored config structure rust pub struct config pub global globalconfig pub chain vec pub connection pub struct globalconfig valid log level defined tracing httpsdocsrstracingcoretracingcorestructlevelhtml pub loglevel string pub struct chainconfig pub chainid pub rpcaddr tendermintrpcurl pub websocketaddr tendermintrpcurl pub grpcaddr tendermintrpcurl pub rpctimeout duration pub accountprefix string pub keyname string pub clientids vec pub gas pub trustingperiod duration pub struct connection pub src source pub dest destination pub path port direction bidirectional pub struct connectionend pub clientid string pub connectionid connection client pub enum direction unidirectional bidirectional pub struct relaypath pub srcport default source port pub destport default dest port pub srcchannel default source port pub destchannel default dest port pub direction direction default bidirectional alloptionfields withnonevalues mean value fordirection default bidirectional nonoption field mandatory must appear configuration file relayer started invalid configuration file error displayed realyer process exit relayer command validate validate configuration file relayer configfile config validate command verifies specified configuration file par semantically correct start start relayer relayer configfile start command performs validation described start relayer query query performed relaying also available cli relayer configfile query client state chain clientid chainheight proofrequired command query full client state clientid chain height without proof depending proofrequired flag default height latest state proofrequired true relayer configfile query client consensus chain clientid consensusheight chainheight proofrequired command query consensus state clientid height consensusheight chain height without proof depending proofrequired flag default height latest state proofrequired true relayer query relayer query chain state order build ibc message expected chain type provides implementation query initial rust relayer implementation tested cosmossdktendermint chain ibcmodules functionality rust required handler function query crate available relayer tendermint query abcirequestquery rpchttp retrieve data format public provable state query parameter response chain independent also defined crate following query required querystoreprefixchain return commitment prefix chain return chain specific byte ibc tendermint queryallclientstateschain return ibc light client instantiated chain queryclientconsensusstatechain clientid height return consensus state proof light client given height height else return latest height queryconnectionschain return connection created chain queryclientconnectionschain clientid return connection associated light client added relayer concurrency architecture following thread spawned execute within relayer process one tendermint full light client thread per configured configured source chain example path enabled two light client thread one one thread download light client header block header commits verify store trusted header per chain store one thread main relaying functionality aka relay thread one thread relay notification source chain generate ibc event relay thread figure show interaction last two thread start communication channel relay notification thread established notification thread register ibc event relay thread creates ibc datagrams configuration triggered event client msgcreateclient msgupdateclient connection channel msgconnopeninit msgchannopeninit sent chain initiate connection channel handshake required wait event notification thread notification thread query source chain latest height sends ibc event relay thread wait notification event related connection channel packet relay thread query client state destination state source chain information collected previous step relay thread creates buffer message destined destination notification thread receives ibc notification sends relay thread step initial version single relay thread configured path temporary thread may created source destination query required future version may create multiple relay thread one possibility create one destination chain responsible relaying path thread pool selecting available thread relaying given destination notification thread route ibc event proper thread multiple notification thread per source also considered relayer algorithm relayer algorithm described relayer algorithm described ibc specification relayer implementation section describes detail really thread algorithm rust implementation input ibc event event interest described appendix high level event source chain relayer query client connection channel andor packet related state source destination chain creates new datagrams needed batch multiple datagrams single transaction sign submits transaction destination proof relayer must include proof datagrams required ibc handler two type proof proof local state source chain example proof correct connection state proofinit prooftry proofack included connection handshake datagrams connopentry message includes proofinit obtained chain connection init state certain local counterparty identifier message specific section detail proof chain ibc client clb updated consensus state height stored chain proof verified chain consensus state stored client proofheight note proof check require handler recreate state expected chain verify proof work store prefix added prefix proof path standardized currently query endpoint cosmossdktendermint initial relayer version includes per chain store prefix configuration verification requires presence consensus state client height proofheight light client message initialization relayer light client created destination chain already present successful relay ibc packet ibc client must instantiated source destination chain potentially different relayers client creation permissionless relayer may create client already present rust let msg msgcreateclientnewclientid header trustingperiod bondingperiod signer relayer run light client thread periodically retrieves verifies header relay thread stored header update aclient chain new header required rust let msg msgupdateclientnewclientid header signer possible relay thread recent trusted header case would mechanism signal client thread retrieve header since relayer must pay transaction including msgclientcreate msgclientupdate incentive optimization example light client implementation tendermint support bisection relayer may choose send skipping header aclient periodically required new ibc datagrams ibc client consensus state relayer light client state chain state number ibc datagrams contain proof obtained chain height proof verified commitment root tendermint client included client consensus state tendermint chain application hash applying transaction block included block height relayer therefore ensure consensus state proofheight exists chain one proposal shown described rest section relayer creates light client update required processing different ibc event let last consensus state client ibc event connection channel packet received includes height let event occurred according proposal relayer get latest consensus state height client let maxhx query item height get proof height wait block height received evblock get minimal set header light client verifies send zero msgupdateclient datagrams msgxx transaction transaction successful msgx failed consume evx msgx fails nothing done another relayer must submitted first else raise event one already effect new query made since consensus state exists msgx sent connection message relayer query source destination chain relaying path order determine connection handshake datagrams sent destination chain connection query following structure pertain connection query detailed ibcmodulesrustadr structure shown reference rust pub struct counterparty pub clientid clientid pub connectionid connectionid pub prefix commitmentroot pub struct connectionend pub state connectionstate pub connectionid pub clientid clientid pub counterparty counterparty pub version vec pub enum connectionstate uninit init tryopen open connectionresponse defines query response connection includes proof height proof retrieved pub struct connectionresponse pub connection connectionend pub proof pub proofpath commitmentpath pub proofheight height connection relaying figure show four connection handshake message type created relay cycle see relayer box four action message query light grey arrow expected state shown example connection open state tryopen relayer send transaction including connopenconfirm datagram processed state connection change tryopen open msgconnectionopeninit msgconnectionopeninit message initialize connection done relay thread start loading configuration includes connection information entering event loop section assumed message relayed rust pub struct msgconnectionopeninit pub connectionid connectionid connatob pub clientid clientid clb pub counterparty counterparty clientid cla connectionid connbtoa prefix bstore pub signer accaddress comment show value field diagram relayer creates forward message explicitly configured connection information see connectionssrc connectionsdestsections configuration file order create msgconnectionopeninit relayer recreates connectionend configuration stored step create connectionend path rust let connectiona getconfiguredconnectiona query connection state chain already exist continue next event rust let existinga ibcqueryconnectionchaina connectiona existingastate uninit continue create message rust let initmsg msgconnectionopeninit connectionid connectionaconnectionid clientid connectionaclientid counterparty counterparty clientid connectionacounterpartyclientid connectionid connectionacounterpartyconnectionid prefix configbstoreprefix signer configasigner send initmsg transaction msgconnectionopentry msgconnectionopentry defines message sent relayer try open connection section assumed relayed rust pub struct msgconnectionopentry pub connectionid connectionid connbtoa pub clientid clientid cla pub counterparty counterparty clientid clb connectionid connatob prefix astore pub counterpartyversions vecstring pub proofinit commitmentproof proof connatob connection end stored chain pub proofconsensus commitmentproof proof proofheight client stored consensus state consensusheight pub proofheight height height relayer retrieved proofinit pub consensusheight height pub signer accaddress comment show value field diagram note proofheight height chain relayer created proofinit diagram consensusheight latest height chain chain stored client clb time relayer queried client diagram relayer creates msgconnectionopentry relay path ibc event notification received step let connatob connection identifier ahx height event occurred cla client query last client state height rust let haprime ibcqueryclientstatechainb height create updateclientmsgs cla chain required higher latest height cla rust let maxhx haprime let header getminimalseth haprime let clientmsgs updateclientmsgscla header signer send clientmsgs query latest height wait rust todo query connection proof chain proper state continue next event rust let queryresponse ibcqueryconnectionwithproofchaina connatob queryresponseconnectionstate init continue let connectiona queryresponseconnection let proofinit queryresponseproof let proofheight queryresponseproofheight assertproofheight query consensus state stored client clb rust let consensusresponse ibcqueryconsensuswithproofchaina connectionaclientid let proofconsensus consensusresponseproof let consensusheight consensusresponseproofheight create msgconnectionopentry message information collected rust let trymsg msgconnectionopentry connectionid connbtoa clientid cla counterparty counterparty clientid connectionaclientid connectionid connatob prefix configastoreprefix proofinit proofconsensus proofheight consensusheight signer configbsigner send trymsg msgconnectionopentry processed message handler check consensusheight valid smaller equal chain current height within trusting period client cla verifies proofconsensus consensus state consensusheight client cla verifies proofinit connectionendobject expects present proofheight relayer may also perform verification submitting transaction msgconnectionopenack wip updated correct query sequence msgconnectionopenack defines message sent relayer chain acknowledge change connection state tryopen chain rust pub struct msgconnectionopenack pub connectionid connectionid connatob pub prooftry commitmentproof proof connbtoa chain tryopen state pub proofconsensus commitmentproof proof proofheight client stored consensus state consensusheight pub proofheight height height relayer retrieved prooftry pub consensusheight height pub version string pub signer accaddress comment show value field diagram note proofheight height chain relayer created prooftry diagram consensusheight latest height chain chain stored client cla time relayer queried client diagram relayer creates msgconnectionopenack relay path ibc event notification received chain scanned step let connbtoa connection identifier query connection proof chain proper state continue next event rust let queryresponse ibcqueryconnectionwithproofchainb connbtoa queryresponseconnectionstate tryopen continue let connectionb queryresponseconnection let prooftry queryresponseproof let proofheight queryresponseproofheight query connection chain validate state rust let connatob connectionbcounterpartyconnectionid let connectiona ibcqueryconnectionchaina connatob connectionastate init connectionastate tryopen continue create updateclientmsg clb chain required proofheight higher latest height clb rust let clientmsg msgupdateclientnewconnectionaclientid header signer query consensus state stored client cla rust let consensusresponse ibcqueryconsensuswithproofchainb connectionbclientid let proofconsensus consensusresponseproof let consensusheight consensusresponseproofheight create msgconnectionopenack message information collected rust let ackmsg msgconnectionopenack connectionid connatob prooftry proofconsensus proofheight consensusheight signer configasigner send clientmsg ackmsg transaction msgconnectionopenconfirm wip updated correct query sequence msgconnectionopenconfirm defines message sent relayer chain confirm opening connection chain rust pub struct msgconnectionopenconfirm pub connectionid connectionid connbtoa pub proofconfirm commitmentproof proof connatob chain open state pub proofheight height height relayer retrieved proofconfirm pub signer accaddress relayer creates msgconnectionopenconfirm relay path ibc event notification received chain scanned step let connatob connection identifier query connection proof chain proper state continue next event rust let queryresponse ibcqueryconnectionwithproofchaina connatob queryresponseconnectionstate open continue let connectiona queryresponseconnection let proofconfirm queryresponseproof let proofheight queryresponseproofheight query connection chain validate state rust let connbtoa connectionacounterpartyconnectionid let connectionb ibcqueryconnectionchainb connbtoa connectionbstate init connectionbstate tryopen continue create updateclientmsg cla chain required proofheight higher latest height cla rust let clientmsg msgupdateclientnewconnectionbclientid header configbsigner create msgconnectionopenconfirm message information collected rust let confirmmsg msgconnectionopenack connectionid connbtoa proofconfirm proofheight signer configbsigner send clientmsg confirmmsg transaction channel wip channel handshake message relayed similar way connection one addition check state underlying connection performed packet timeouts acknowledgment wip application packet stored chain state cryptographic commitment stored relayer query chain logging system get packet data given source port channel result query includes among others source port channel identifier sequence number create packet commitment path state query get packet commitment interrelayer coordination multiple relayers may run parallel expected relay disjoint path could case may submit transaction chain case first transaction succeeds subsequent fail causing loss fee ideally coordination would place avoid scope document relayer restarts upgrade section explains detail proposed solution including implementation detail also describe affect corollary item may changed part proposed change large please also indicate way change maximize ease review optimal split thing separate may proposed hasnt agreed upon yet agreed upon later adr change revers may marked deprecated superseded reference replacement deprecatedproposedaccepted consequence section describes consequence applying consequence summarized positive one positive negative neutral appendix ibc event input relay thread described createclient clientid clienttype updateclient clientid clienttype connectionopeninit connectionid clientid counterpartyconnectionid counterpartyclientid connectionopentry connectionid clientid counterpartyconnectionid counterpartyclientid connectionopenack connectionid connectionopenconfirm connectionid channelopeninit portid channelid counterpartyportid counterpartychannelid connectionid channelopentry portid channelid counterpartyportid counterpartychannelid connectionid channelopenack portid channelid channelopenconfirm portid channelid channelcloseinit portid channelid channelcloseconfirm portid channelid sendpacket packetdata string packettimeoutheight string packettimeouttimestamp string packetsequence string packetsrcport packetsrcchannel packetdstport packetdstchannel recvpacket packetdata string packetack string packettimeoutheight string packettimeouttimestamp string packetsequence string packetsrcport packetsrcchannel packetdstport packetdstchannel reference relevant comment issue led article referenced made given design choice link reference link