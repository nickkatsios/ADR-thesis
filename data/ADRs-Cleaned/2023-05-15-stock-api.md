title stock manipulation api area core tag stock stock handling shopware currently flexible support many common case possible easily replace loading stock custom implementation example one communicates erp possible easily modify stock increaseddecreased throughout order lifecycle available stock calculation slow large catalog stock stored two distinct value stock available stock due fact stock reduced order set completed therefore available stock calculated stock minus open order unnecessarily complex one field stock product definition always real time calculated value stock value correctly updated order line item transition various state stock decremented order placed cancelled stock increased clear api manipulating stock extended support arbitrary data could example support feature multi warehouse inventory way disable stock handling behavior shopware new feature flag introduce new feature flag stockhandling allow people opt new stock handling behavior immediately flag removed new stock handling activated default abstract stock storage introduce new abstractstockstorage api follows php namespace shopwarecorecontentproductstock shopwarecoreframeworkcontext shopwarecoreframeworklogpackage shopwarecoresystemsaleschannelsaleschannelcontext packageinventory abstract class abstractstockstorage abstract public function getdecorated self method provides extension point augment stock data loaded method called loading product via shopwarecorecontentproductsaleschanneldetailavailablecombinationloader shopwarecorecontentproductstockloadproductstocksubscriber data set directly product overwriting existing value furthermore key specified extra data added array extension product key stockdata abstract public function loadstockloadrequest stockrequest saleschannelcontext stockdatacollection method update stock value product given order item change param liststockalteration change abstract public function alterarray change void method executed product created updated perform calculation update available flag based new stock level param liststring productids abstract public function indexarray productids void dtos php namespace shopwarecorecontentproductstock shopwarecoreframeworklogpackage packageinventory class stockdatacollection public function addstockdata stock void public function getstockforproductidstring productid stockdata return arraystockdata public function array php namespace shopwarecorecontentproductstock shopwarecoreframeworklogpackage shopwarecoreframeworkstructstruct packageinventory final class stockdata extends struct public function construct public readonly string productid public readonly int stock public readonly bool available public readonly int minpurchase null public readonly int maxpurchase null public readonly bool iscloseout null public static function fromarrayarray info self php namespace shopwarecorecontentproductstock shopwarecoreframeworklogpackage packagecore final class stockalteration public function construct public readonly string lineitemid public readonly string productid public readonly int quantitybefore public readonly int newquantity public function quantitydelta int alter method receives list change change corresponds line item change contains line item product quantity line item api encapsulates scenario order may transition introduce new beforewriteevent event introduce new event entitywritegateway service much like beforedeleteevent dispatched command written allows subscriber add success error callback via method public function addsuccessclosure callback void public function adderrorclosure callback void callback executed writes written database ifwhen error occurs respectively update shopwarecorecontentproductdataabstractionlayerproductindexer update shopwarecorecontentproductdataabstractionlayerproductindexer depend shopwarecorecontentproductdataabstractionlayerabstractstockstorage well shopwarecorecontentproductdataabstractionlayerstockupdater stockhandling enabled call shopwarecorecontentproductdataabstractionlayerabstractstockstorageindex method product changed otherwise call shopwarecorecontentproductdataabstractionlayerstockupdaterupdate deprecate shopwarecorecontentproductdataabstractionlayerstockupdater removed introduce shopwarecorecontentproductstockorderstocksubscriber introduce new subscriber listens various required event interacts shopwarecorecontentproductdataabstractionlayerabstractstockstorage via new api alter shopwares internal business rule handling stock located subscriber subscriber listens various event call shopwarecorecontentproductdataabstractionlayerabstractstockstoragealter appropriate changesets following scenario order placed item quantity new quantity reflective amount ordered order cancelled item quantity amount ordered new quantity order reopened item quantity new quantity reflective amount ordered order item added quantity new quantity reflective amount ordered order item removed quantity amount ordered new quantity order item quantity updated new quantity represent old new quantity order item product changed two change first old product quantity amount ordered new quantity second new product quantity new quantity reflective amount ordered possible disable shopwares internal stock handling setting configuration shopwarestockenablestockmanagement false introduce new core stock storage implementation introduce new implementation shopwarecorecontentproductdataabstractionlayerabstractstockstorage managing stock level responsible incrementingdecrementing stock value based provided changesets new apis directly increment decrement stock column product table rather availablestock therefore stock value always realtime representation available stock alter method directly update stock value based given delta changesets new implementation solves issue current slow stock calculation process work like stock availablestock difference order progress completed order availablestock calculated stock value minus open order quantity calculation preformed shopwarecorecontentproductdataabstractionlayerstockupdaterupdateavailablestockandsales slow sum may run million row deprecate stockupdater filter deprecate stock update filter removed behaviour implemented decorator following class deprecated shopwarecorecontentproductdataabstractionlayerstockupdateabstractstockupdatefilter shopwaretestsunitcorecontentproductdataabstractionlayerstockupdateteststockupdatefilter shopwarecommercialmultiwarehousedomainorderexcludemultiwarehousestockupdatefilter shopwarecorecontentproductdataabstractionlayerstockupdatestockupdatefilterprovider productdefinition update shopware version stockhandling feature flag enabled availablestock field made write protected updated directly mirror stock value decide remove availablestock field simply deprecating plan remove many integration rely field simple maintain mirror stock mirror value implement new listener availablestockmirrorsubscriber beforewriteevent event simply update payload copying stock value update availablestock field update stock loading abstractstockstorageload update various location shopware stock loaded augment product stock information loaded stock storage includes shopwarecorecontentproductsubscriberproductsubscribersaleschannelloaded shopwarecorecontentproductsaleschanneldetailavailablecombinationloaderload pseudocode setting value product look like php productsetstockstockstock productsetavailablestockavailable optional value productsetminpurchasestockminpurchase productgetminpurchase productsetmaxpurchasestockmaxpurchase productgetmaxpurchase productsetiscloseoutstockiscloseout productgetiscloseout really flexible project productaddextensionstockdata stock however order support api must update shopwarecorecontentproductsaleschanneldetailavailablecombinationloaderload currently pas along saleschannelcontext necessary abstractstockstorageload therefore deprecate load abstractavailablecombinationloader introduce public function loadcombinationsstring productid saleschannelcontext saleschannelcontext availablecombinationresult introduced abstract throw deprecation error called method implemented concrete implementation otherwise forward load made abstract availablecombinationloader implement new loadcombinations method load deprecated finally productconfiguratorloader updated call loadcombinations instead load stock changing scenario following table contains scenario trigger stock change implementation abstractstockstorage able handler scenario scenario item item stock value stock value diff order placed product product product product product product product product order cancelled product product product product product product product product product product cancelled order open product product product product product product product product product product line item added product product product product product product product product product product product product product product line item removed product product product product product product product product product product product product product line item updated product qty increased product product product product product product product product product line item updated product qty decreased product product product product product product product product product line item updated changed product product product product product product product product product product product product non cancelled order deleted product product product product product product product product product product role shopwarecorecontentproductstockorderstocksubscriber listen required shopware event scenario interact stock storage implementation order placed product stock reduced order line item qties beforewriteevent item exist pre insertion know decrement operation order cancelled product stock increased order line item qties statemachinetransitionevent eventgettoplacegettechnicalname orderstatesstatecancelled order reopened product stock reduced order line item qties statemachinetransitionevent eventgetfromplacegettechnicalname orderstatesstatecancelled order item added product stock reduced new order line item qty beforewriteevent filter order line item writes diff old new state order item removed non cancelled product stock increased old order line item qty beforewriteevent filter order line item writes diff old new state order item qty increased non cancelled product stock decreased difference old new qty beforewriteevent filter order line item writes diff old new state order item qty decreased non cancelled product stock increased difference old new qty beforewriteevent filter order line item writes diff old new state order item product changed non cancelled old product stock increased old qty new product stock decreased new qty beforewriteevent filter order line item writes diff old new state consequence creating abstract class maintain consistent interface stock updating allowing different implementation new inventory management strategy easily added creating new concrete class extend abstractstockstorage developer working inventory management system confident concrete implementation abstractstockstorage provide required method handling stock update developer wanting completely remove rewrite inventory management logic completely disable orderstocksubscriber implement solution