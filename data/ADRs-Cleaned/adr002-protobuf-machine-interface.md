design goal split server part machine process responsible driving gcode spooling loop combinator process responsible storing job queue configuration data relaying webcam footage presenting public graphql api machine combinator must able crash independently without effecting operation machine must able relay change back new combinator process combinator crash combinator mark job errored event machine crash remote machine combinators must designed gracefully handle network disconnect case running machine possible idempotent communication reduce implementation difficulty deduplicating data architecture webrtc remote machine unix socket local machine depricated httpsgithubcomnickdesaulniersnodenanomsg machine pair ipc socket connecting localhost combinator combinator attach many pair ipc socket localhost machine combinator serve many webrtc client act reverse proxy localhost machine combinator connect many remote combinators webrtc access proxied remote machine combinator handle load balancing javascript allow flexibility deciding machine run print scenario unix socket disconnected either localhost combinator machine crashed newsocket action indicate unix socket connection reestablished socket assumed reliable newsocket action received newsocket action received combinator sent newsocket assumed available data sent combinator lost resent machine sent newsocket assumed state machine wiped reset localhost combinator sending combinator message machine action combinator wait ack sending next action newsocket action machine wait ack sending next action action combinators ack setconfig spooltask estop deletejobhistory sending machine message combinators action machine ack event printerstatuschange printer connect disconnect estopped reset action sent localhost combinators feedback settasklinenumber rate limited update current line number task note since graphql api must provide gcodehistory reliably gcodefeedback sent reliable channel one action must gcode executed job history event pushed reliable socket case temporary network disconnect back pressure socket combinator guaranteed receive job history event startup workflow startup local combinator machine connect pair socket machine bind socket combinator connects machine socket note combinators initial call connect block machine bound end socket machine crash combinator maintain smart socket machine restarts machine start send machinestartup action combinator combinator listening reset connection machine combinator yet listening startup process well new connection established combinator initialized combinator reset connection machine start new connection sends resetconnection upon startup machine ignores message resetconnection received upon receiving resetconnection machine sends complete job history event action always include machinestartup event printerror may included well machinestartup event event machine fatal error saved disk crashed rehydrated startup event event payload machinestartup event local combinator cancel pending request set internal state machine startup sends setconfig action initializing machine configuration state set startup user verify build platform clear resetting machine resetting machine set state idle internally combinator effect machine way since startup state exists prevent user mistake clearing build platform stating print resetting state startup delay machine received initial configuration configuration workflow upon changing configuration combinator validates new config json schema form defers relaying machine machine printing job state printing indicate change may applied current print configuration form machine idle combinator send setconfig event new configuration mark configuration longer pending job workflow upon starting job combinator sends spooltask action machine upon receiving spooltask action machine sends event action spoolprint event machine may also send startprint event ready start print immediately send another event action later ready start print upon canceling erroing finishing job combinator sends event cancelprint printerror finishprint respectively fatal error may cause error send machinestartup event print ongoing machinestartup event treated print failure upon receiving event action combinator filter job history event relevant combinator machine local host therefore also acting reverse proxy machine networked combinators keep job history event forwarded proxy upon receiving job history event indicates completion print successful machine first persists job history sends deletejobhistory action machine jobid completed machine error machine start sends machinestartup job history event allows combinator treat situation machine shuts mid job without able record anything previous state machine power outage job failure every machinestartup event set state startup treated similar error print started combinator aware example another combinator combinator crashed persisting jobstart event combinator collide existing object build platform forgotten print machinestartup error relayed user message machine restarted may object build platform please verify build platform clear clicking reset case nonfatal error machine expected send error job history event combinator treat error event job failure relay error message user error event sent machinestartup event error message presented user one provided error event machine able record fatal error process crashing send error job history event followed machinestartup job history event upon starting back combinator error combinator error displayed top job queue combinator error able cleared user networking machine proxying machine combinators combinators proxy machine nanomsg data webrtc combinators many machine may controlled across network single job queue webrtc connection label seperate graphql server machine nanomsg data seperate channel client determines channel connect web user receive unecessary nanomsg spam webrtc connection must following label graphql graphql server nanomsgmachineid machine proxy machineid globally unique machine listed configuration example machine proxy label might look like nanomsgeebda thought might useful able set state networkdisconnected network disconnect occurred