robust data migration january team became aware data migration needed executed along prior production deployment never run production order rectify team ran required data migration evening january since task cpu perhaps memory intensive task ran hour overnight required constant monitoring team ensure task wasnt affecting regular performance simple server task completed noted simple server impacted task reference slack conversation problem adr aim tackle following required data migration run corresponding production deployment data migration require constant supervision monitor server performance correct failure simple server performance degraded execution data migration enforcing data migration execution order better enforce execution data migration invoke datamigrate gem ensure data migration run reliability database migration still allowing database migration run rolled back independently necessary example may ship data migration look like ruby class updatenilensobps activerecordmigration def bpupdaterperformfacility nilenso associated service class performs data migration end def railsloggerinfothis data migration reversed good luck end end take care file management see reliable handsoff execution background job execute data migration asynchronous atomic repeatable fashion ideally data migration split small atomic part possible part executed background job example task update record executed sidekiq job one record ruby good affectedrecordseach record updatejobperformlaterrecord end bad atomic bulkupdatejobperformlateraffectedrecords bad asynchronous updaterperformrightnowaffectedrecords atomic background job several advantage failed job retried automatically sensible exponential backoff avoid verylongrunning process server could also result verylongrunning database connection becomes easier monitor progress migration sidekiq dashboard execution data migration easily throttled paused halted take care sidekiq queue see beneficial trait idempotence ideally data migration task repeatable indefinitely without changing end result idempotent task ensure even abandon migration halffinished state redis fall background job lost able rerun data migration without requiring code change ruby good bloodpressurewhererecordedat nileach bptouchrecordedat end bad idempotent bloodpressurewhereid affectedidseach bpupdatesystolic bpsystolic end consequence regarding database migration take care manage data migration service class like bpupdater care may able simply remove codebase execution would invalidate migration file causing rail dbmigrate start failing local production instance far behind propose libdatamigrations libservicesdata directory permanently house datamigrationrelated service class even oneoff task regarding background job notable risk sidekiq executed data migration listed along measure mitigate eliminate risk redis could run memory causing regular job dropped validate much memory required nonproduction environment based finding either provision enough memory redis instance split data migration appropriate batch ensure encounter redis oom error influx migration job could overwhelm regular job execution ensure data migration background job executed separate sidekiq queue allow throttle separately regular background job executed simple server