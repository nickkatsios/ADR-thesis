cassandra mailbox object consistency lazy consensus implemented mailbox denormalized cassandra order access immutable identifier mailbox path name mailbox table store mailbox immutable identifier mailboxpathv table store mailbox mailbox path furthermore maintain two invariant top table mailboxpath unicity mailbox path maximum ensured writing mailbox path first lightweight transaction mailboxid unicity mailbox identifier single path real way ensure given mailbox referenced two path failure denormalization process lead inconsistency two table lead following user experience bob creates mailbox denormalization fails error returned bob retries mailbox creation bob told mailbox already exist bob try access mailbox bob told mailbox exist provide offline meaning absence user traffic via exemple smtp imap jmap webadmin task solve mailbox object inconsistency task read mailbox table adapt path registration mailboxpathv missing registration added orphan registration removed mismatch content two table require merging two mailbox together consequence administrator user report bug mentioned way sanitize cassandra mailbox database however due two invariant mentioned identify clear source trust based existing table mailbox object task previously mentioned subject concurrency issue might cancel legitimate concurrent user action hence task must run offline meaning absence user traffic via exemple smtp imap jmap achieved via reconfiguration disabling given protocol restarting james via firewall rule due risk confirmation header iknowwhatimdoing positioned allservicesareoffline order prevent accidental call future revisit mailbox object datamodel restructure identify source truth base inconsistency fixing task event sourcing good candidate reference james webadmin task solve cassandra mailbox inconsistency pull request mailboxcassandra utility solve mailbox inconsistency pull request james concurrency testing fixing cassandra mailbox inconsistency thread provides significant discussion leading architecture record discussion mailing list