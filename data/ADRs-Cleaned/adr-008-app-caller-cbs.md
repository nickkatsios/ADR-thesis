adr callback ibc actor changelog initial draft merged updated made implementation middleware implemented ibc designed callback core ibc ibc application ibc apps would send packet core ibc result packet lifecycle eventually resolved either acknowledgement timeout core ibc called callback ibc application ibc application could take action basis result unescrow token setup worked well offchain user interacting ibc application seeing desire secondary application smart contract module call ibc apps part state machine logic action basis packet result receive packet ibc logic upon receipt example usecases send packet successful send icapacket swap token return fund sender execute logic upon receipt token transfer smart contract address requires second layer callback ibc application already get result packet core ibc currently standardized way pas information actor modulesmart contract definition actor actor onchain module may hardcoded module chain binary smart contract wish execute custom logic whenever ibc receives packet flow either sent received must addressable string value create middleware interface ibc application smart contract vms ibc application smart contract vms implement respective interface composed together callback middleware allow smart contract compatible interact programmatically ibc application data structure callbackpacketdata struct get constructed custom callback data application packet callbackaddress ibc actor address callback called senderaddress also provided optionally allow ensure sender callback address struct also defines commitgaslimit maximum gas callback allowed callback exceeds limit callback panic commit without callback state change executiongaslimit practical limit execution set gas meter minimum commitgaslimit gas left gas meter determined relayers choice gas limit executiongaslimit commitgaslimit outofgas error revert entire transaction without committing anything allowing different relayer retry larger gas limit middleware targeting interface callback handling define global limit cap gas callback allowed take especially acknowledgepacket timeoutpacket custom callback prevent packet lifecycle completing however since global cap likely large thus user may specify smaller limit cap amount fee relayer must pay order complete packet lifecycle user behalf implemented packet data type want support packetactor callback packetactors unable act packet data type implement interface type callbackpacketdata struct callbackaddress string executiongaslimit uint senderaddress string commitgaslimit uint ibc apps middleware call ibcactor callback like callback callback middleware callbackmiddleware wrap underlying ibc application along contractkeeper delegate callback virtual machine allows callback middleware interface compatible ibc application compatible evm wasm long application implement callbackscompatiblemodule interface implement contractkeeper interface ibcmiddleware implement callback ibccallbacks middleware given underlying application type ibcmiddleware struct app typescallbackscompatiblemodule icswrapper porttypesicswrapper contractkeeper typescontractkeeper maxcallbackgas defines maximum amount gas callback actor ask relayer pay callback fails due insufficient gas entire reverted relayer hadnt provided minimumuserdefinedgas maxcallbackgas actor hasnt defined gas limit assumed maxcallbackgas maxcallbackgas uint callbackcompatible ibc application callbackscompatiblemodule extends porttypesibcmodule include unmarshalpacketdata function allows middleware request underlying app unmarshal packet data allow middleware retrieve callback specific data arbitrary set ibc application packet callbackscompatiblemodule interface combine ibcmodule packetdataunmarshaler interface assert underlying application support type callbackscompatiblemodule interface porttypesibcmodule porttypespacketdataunmarshaler packetdataunmarshaler defines optional interface allows middleware request packet data unmarshaled base application type packetdataunmarshaler interface unmarshalpacketdata unmarshals packet data concrete type unmarshalpacketdatabyte interface error application packet data must additionally implement following interface packetdata defines optional interface application packet data structure may implement type packetdata interface getpacketsender return sender address packet data packet sender unknown undefined empty string returned getpacketsendersourceportid string string packetdataprovider defines optional interface retrieving custom packet data stored behalf another application existing problem ibc middleware design inability middleware define packet data type insert packet sender provided information short term solution introduced several application packet data utilize memo field carry information behalf another application interface standardizes behaviour upon realization ability middlewares define packet data type interface deprecated removed time type packetdataprovider interface getcustompacketdata return packet data held behalf another application name information stored provided key custom packet data exists key nil returned getcustompacketdatakey string interface callback data embedded application packet providing custom packet data source destination callback custom packet data appropriate key jsonc custom packet data embedded json object packet data src callback custom data srccallback address callbackaddressstring optional gaslimit userdefinedgaslimitstring dest callback custom data destcallback address callbackaddressstring optional gaslimit userdefinedgaslimitstring src dest callback custom data embedded together srccallback address callbackaddressstring optional gaslimit userdefinedgaslimitstring destcallback address callbackaddressstring optional gaslimit userdefinedgaslimitstring contractkeeper contractkeeper interface must implemented want support ibc callback allows separation concern middleware handling logic intended vms setting gas meter extracting callback data emitting event contractkeeper handle specific detail calling question contractkeeper may impose additional check ensuring contract address packet sender source callback may also disable certain callback method simply performing noop contractkeeper defines entry point exposed module invokes smart contract type contractkeeper interface ibcsendpacketcallback called source chain packetsend executed packetsenderaddress determined underlying module may empty sender unknown undefined contract expected handle callback within user defined gas limit handle error panic gracefully entry point called cached error returned change persisted error propagated underlying ibc application resulting packet send failure implementation provided packetsenderaddress may choose perform validation origin given packet recommended perform validation source chain callback sendpacket acknowledgementpacket timeoutpacket defensively guard exploit due incorrectly wired sendpacket ordering ibc stack ibcsendpacketcallback cachedctx sdkcontext sourceport string sourcechannel string timeoutheight clienttypesheight timeouttimestamp uint packetdata byte contractaddress packetsenderaddress string error ibconacknowledgementpacketcallback called source chain packet acknowledgement received packetsenderaddress determined underlying module may empty sender unknown undefined contract expected handle callback within user defined gas limit handle error panic gracefully entry point called cached error returned change persisted packet lifecycle blocked implementation provided packetsenderaddress may choose perform validation origin given packet recommended perform validation source chain callback sendpacket acknowledgementpacket timeoutpacket defensively guard exploit due incorrectly wired sendpacket ordering ibc stack ibconacknowledgementpacketcallback cachedctx sdkcontext packet channeltypespacket acknowledgement byte relayer sdkaccaddress contractaddress packetsenderaddress string error ibcontimeoutpacketcallback called source chain packet received timeout height packetsenderaddress determined underlying module may empty sender unknown undefined contract expected handle callback within user defined gas limit handle error gas panic gracefully entry point called cached error returned change persisted packet lifecycle blocked implementation provided packetsenderaddress may choose perform validation origin given packet recommended perform validation source chain callback sendpacket acknowledgementpacket timeoutpacket defensively guard exploit due incorrectly wired sendpacket ordering ibc stack ibcontimeoutpacketcallback cachedctx sdkcontext packet channeltypespacket relayer sdkaccaddress contractaddress packetsenderaddress string error ibcreceivepacketcallback called destination chain packet acknowledgement written contract expected handle callback within user defined gas limit handle error gas panic gracefully entry point called cached error returned change persisted packet lifecycle blocked ibcreceivepacketcallback cachedctx sdkcontext packet ibcexportedpacketi ack ibcexportedacknowledgement contractaddress string error packetcallbacks packet callback implemented middleware first call underlying application route ibc actor callback postprocessing step extract callback data application packet set callback gas meter depending global limit user limit gas left transaction gas meter callback routed callback keeper either panic return result success failure event nonoog panic error callback state change discarded transaction committed relayerdefined gas limit exceeded userdefined gas limit global callback gas limit exceeded entire transaction reverted allow resubmission chaindefined userdefined gas limit reached callback state change reverted transaction committed sendpacket callback revert entire transaction kind error panic packet lifecycle yet started revert completely avoid starting packet lifecycle callback successful sendpacket implement source callback sending packet defers underlying application call contract callback contract callback return error panic run gas packet send rejected func ibcmiddleware sendpacket ctx sdkcontext chancap capabilitytypescapability sourceport string sourcechannel string timeoutheight clienttypesheight timeouttimestamp uint data byte uint error run underlying app logic first ibcactor logic postprocess seq err imicswrappersendpacketctx chancap sourceport sourcechannel timeoutheight timeouttimestamp data err nil return err underlying app get source callback information packet data callbackdata err typesgetsourcecallbackdataimapp data sourceport ctxgasmetergasremaining immaxcallbackgas sendpacket blocked packet optin callback err nil return seq nil callbackexecutor funccachedctx sdkcontext error return imcontractkeeperibcsendpacketcallback cachedctx sourceport sourcechannel timeoutheight timeouttimestamp data callbackdatacallbackaddress callbackdatasenderaddress err improcesscallbackctx typescallbacktypesendpacket callbackdata callbackexecutor contract keeper allowed reject packet send err nil return err typesemitcallbackeventctx sourceport sourcechannel seq typescallbacktypesendpacket callbackdata nil return seq nil writeacknowledgement implement receivepacket destination callback ibccallbacks middleware asynchronous packet acknowledgement defers underlying application call contract callback contract callback run gas may retried higher gas limit state change reverted via panic func ibcmiddleware writeacknowledgement ctx sdkcontext chancap capabilitytypescapability packet ibcexportedpacketi ack ibcexportedacknowledgement error run underlying app logic first ibcactor logic postprocess err imicswrapperwriteacknowledgementctx chancap packet ack err nil return err underlying app get destination callback information packet data callbackdata err typesgetdestcallbackdata imapp packetgetdata packetgetsourceport ctxgasmetergasremaining immaxcallbackgas writeacknowledgement blocked packet optin callback err nil return nil callbackexecutor funccachedctx sdkcontext error return imcontractkeeperibcreceivepacketcallbackcachedctx packet ack callbackdatacallbackaddress callback execution error allowed block packet lifecycle event emission err improcesscallbackctx typescallbacktypereceivepacket callbackdata callbackexecutor emit event typesemitcallbackevent ctx packetgetsourceport packetgetsourcechannel packetgetsequence typescallbacktypeacknowledgementpacket callbackdata err return nil call ibcactor recvpacket callback processing packet recvpacket callback exists callback return error return error ack revert packet data processing func ibcmiddleware onrecvpacket ctx sdkcontext packet channeltypespacket relayer sdkaccaddress ack exportedacknowledgement run underlying app logic first ibcactor logic postprocess ack imapponrecvpacketctx packet relayer ack nil asynchronous acknowledgement callback handled writeacknowledgement ack successful state change reverted packet cannot received execute callback receiving chain ack nil acksuccess return ack underlying app get destination callback information packet data callbackdata err typesgetdestcallbackdata imapp packetgetdata packetgetsourceport ctxgasmetergasremaining immaxcallbackgas onrecvpacket blocked packet optin callback err nil return ack callbackexecutor funccachedctx sdkcontext error return imcontractkeeperibcreceivepacketcallbackcachedctx packet ack callbackdatacallbackaddress callback execution error allowed block packet lifecycle event emission err improcesscallbackctx typescallbacktypereceivepacket callbackdata callbackexecutor typesemitcallbackevent ctx packetgetdestport packetgetdestchannel packetgetsequence typescallbacktypereceivepacket callbackdata err return ack call ibcactor acknowledgementpacket callback processing packet ackpacket callback exists return error return error upstream acknowledgement must complete packet lifecycle end custom callback cannot block completion instead emit error event set error state user onchain logic handle appropriately func ibcmodule onacknowledgementpacket ctx sdkcontext packet channeltypespacket acknowledgement byte relayer sdkaccaddress error first call underlying app handle acknowledgement ibcactor logic postprocess err imapponacknowledgementpacketctx packet acknowledgement relayer err nil return err underlying app get source callback information packet data callbackdata err typesgetsourcecallbackdata imapp packetgetdata packetgetsourceport ctxgasmetergasremaining immaxcallbackgas onacknowledgementpacket blocked packet optin callback err nil return nil callbackexecutor funccachedctx sdkcontext error return imcontractkeeperibconacknowledgementpacketcallback cachedctx packet acknowledgement relayer callbackdatacallbackaddress callbackdatasenderaddress callback execution error allowed block packet lifecycle event emission err improcesscallbackctx typescallbacktypeacknowledgementpacket callbackdata callbackexecutor typesemitcallbackevent ctx packetgetsourceport packetgetsourcechannel packetgetsequence typescallbacktypeacknowledgementpacket callbackdata err return nil call ibcactor timeoutpacket callback processing packet timeoutpacket callback exists return error return error upstream timeout must complete packet lifecycle end custom callback cannot block completion instead emit error event set error state user onchain logic handle appropriately func ibcmodule ontimeoutpacket ctx sdkcontext packet channeltypespacket relayer sdkaccaddress error applicationspecific ontimeoutpacket logic err imappontimeoutpacketctx packet relayer err nil return err underlying app get source callback information packet data callbackdata err typesgetsourcecallbackdata imapp packetgetdata packetgetsourceport ctxgasmetergasremaining immaxcallbackgas ontimeoutpacket blocked packet optin callback err nil return nil callbackexecutor funccachedctx sdkcontext error return imcontractkeeperibcontimeoutpacketcallbackcachedctx packet relayer callbackdatacallbackaddress callbackdatasenderaddress callback execution error allowed block packet lifecycle event emission err improcesscallbackctx typescallbacktypetimeoutpacket callbackdata callbackexecutor typesemitcallbackevent ctx packetgetsourceport packetgetsourcechannel packetgetsequence typescallbacktypetimeoutpacket callbackdata err return nil processcallback executes callbackexecutor reverts contract change callbackexecutor fails error precedence return oogerr take highest precedence callback run gas error wrapped typeserrcallbackoutofgas returned panicerr take secondhighest precedence panic occurs propagated error wrapped typeserrcallbackpanic returned callbackerr callbackexecutor return error returned asis panic contractexecutor panic reason callbacktype sendpacket contractexecutor run gas relayer reserved gas grater equal commitgaslimit func ibcmiddleware processcallback ctx sdkcontext callbacktype typescallbacktype callbackdata typescallbackdata callbackexecutor funcsdkcontext error err error cachedctx writefn ctxcachecontext cachedctx cachedctxwithgasmeterstoretypesnewgasmetercallbackdataexecutiongaslimit defer func consume minimum gconsumed glimit ctxgasmeterconsumegascachedctxgasmetergasconsumedtolimit fmtsprintfibc callback callbacktype recover panic except sendpacket callback recover nil callbacktype typescallbacktypesendpacket panicr err errorsmodwrapftypeserrcallbackpanic ibc callback panicked callbacktype callback ran gas relayer reserved enough gas revert state cachedctxgasmeterispastlimit callbackdataallowretry panicstoretypeserroroutofgasdescriptor fmtsprintfibc callback gas commitgaslimit callbacktype callbackdatacommitgaslimit err errorsmodwrapftypeserrcallbackoutofgas ibc callback gas callbacktype allow transaction committed continuing packet lifecycle err callbackexecutorcachedctx err nil writefn return err chain expected specify maxcallbackgas ensure callback consume arbitrary amount gas thus always possible relayer complete packet lifecycle even actor callback cannot run successfully consequence positive ibc actor programmatically execute logic involves sending packet performing additional logic packet lifecycle complete middleware implementing adr generally application leverage similar callback architecture one core ibc ibc application negative callback may unbounded gas consumption since actor may execute arbitrary logic chain implementing feature take care place limitation much gas actor callback consume relayer pay callback gas instead ibcactor neutral application packet want support adr must additionally packet data implement packetdataprovider packetdata interface application must implement packetdataunmarshaler interface callback receiving module must implement contractkeeper interface reference original issue callbackpacketdata interface implementation implementation callbackpacketdata interface