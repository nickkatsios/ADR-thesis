locking approach mallocfreelist freelist implementation malloc threadsafe fine singlethreaded baremetal application library may multithreaded application locking available locking implementation satisfy following requirement provide singlethreaded support default mean user must optin locking behavior support optional locking behavior way couple library specific locking strategy handle lockingunlocking internally require user managing lockingunlocking around mallocfree call application implement malloclock mallocunlock function default weaklylinked noop stub library attributeweak void malloclock intentional noop attributeweak void mallocunlock intentional noop user support thread safety stub implemented application code providing desired locking behavior mutext mallocmutex void malloclock mutexlockmallocmutex void mallocunlock mutexunlockmallocmutex consequence user responsible knowing function reading documentation reviewing code supplying proper implementation system worry locking implementation since vary widely one system another assume particular underlying system help retain flexibility implementation