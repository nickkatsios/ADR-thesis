northsouth messaging approved tsc vote proposed design today data flowing sensorsdevices southside edgex enterprise application database cloudbased system northside accomplished via rest message bus sensor device data collected device service sent via rest message bus core data core data relay data application service via message bus sensor data also sent directly device service application service via message bus bypassing core data message bus implemented via redis pubsub default via mqtt application service data sent northside endpoint number way including via mqtt summary data collected sensor device sent southside northside entirely message bus technology desired today communication party system enterprise application cloud application etc edgex order acuate device get latest information sensor accomplished via rest party system make rest call command service relay request device service also rest built mean make messagebased request edgex devicessensors manages note rest call optionally made via api gateway order provide access control future release edgex desire allow party system make request southside via message bus specifically party system send command request command service via external message broker command service would relay request via message bus managing device service via one allowed internal message bus implementation could mqtt redis pubsub today device service would message trigger action devicesensor receives rest request respond via message bus back command service turn command service would relay response party system via external message bus summary adr proposes core command service add support external mqtt connection manner app service provide external mqtt connection allow act bridge internal message bus implemented via either mqtt redis pubsub external mqtt message bus note purpose initial northtosouth message bus communication external party communication command service limited mqtt core command message bus bridge core command service serve edgex entry point external northtosouth message bus request south side party system granted access edgex internal message bus therefore order implement north south communication via message bus specifically mqtt command service take message party external mqtt topic pas internally onto edgex internal message bus eventually routed device service devicessensors southside reverse response message southside also sent internal edgex message bus command service bridged external mqtt topic respond party system requester note note ekuiper allowed access directly internal edgex message bus special circumstance party external system communication ekuiper sister project deemed edgex reference implementation rule engine future release edgex even ekuiper may routed external internal message bus bridge better decoupling security message bus subscription publishing command service require mean publish message device service via edgex message bus internal message bus would messaging client gomodmessaging create new messageclient connect message bus publish designated request message topic see topic configuration command service also connect edgex message bus internal message bus order receive response device service request message bus made core command gomodmessaging messageclient subscribe receive response message device service similar fashion device service subscribe publish edgex message bus internal message bus get command request push back response command service lang device service like command service gomodmessaging module messagingclient get command request send command response edgex message bus based device service subscribe publish edgex message bus internal message bus note device service already gomodmessaging publishing eventsreadings message bus internal message bus command service also subscribe party mqtt topic external message bus order get command request party system command service relay command request appropriate device service via internal message bus forming message bus message bus bridge likewise command service accept response device service edgex message bus internal message bus publish response party system via party mqtt topic external message bus command query via command service today party system make rest call core command get possible command executed two query rest api endpoint deviceall get command device devicenamename get command specific device name stand reason party system want send command via messaging would also want get understanding command available via messaging reason core command service also allow message request get command get command particular device name word core command service must support command query via messaging support command request via messaging case command query rest response include actual rest command endpoint example rest query would return core command path url parameter construct rest command request shown example json corecommands name coolingpoint get true path apivdevicenametestdevicecommandcoolingpoint url httplocalhost parameter resourcename resource valuetype int messaging make query response message must return information pas message appropriate topic make command request therefore query response messaging would include something like following json corecommands name coolingpoint topic edgexcommandrequesttestdevicecoolingpointget parameter resourcename resource valuetype int name coolingpoint topic edgexcommandrequesttestdevicecoolingpointset parameter resourcename resource valuetype int note per core meeting json serf general example implementation address getset readwrite differentiation considered implementation detail resolved developer note query response contain url since assumed broker address must already known order make query message structure rest based command request response http request line contains important information path target request http method type indicating get put request http line provides information response code body payload http message contains request detail parameter device put call response information event associated reading get call since message bus protocol lack generic message header mechanism http providing requestresponse metadata accomplished defining message envelope object associated requestresponse therefore message described adr must provide json envelope payload object requestresponse message topic name act like http path method rest request topic name specify device receiver command request path http request message envelope message defined adr json formatted request response share common base structure outer json object represents message envelope convey metadata requestresponse correlation identifier added relayed request message well response message envelope party system know associate response original request note correlation see article detailed description unique value added every request response involved transaction could include multiple requestsresponses one microservices meant correlate request response meant label every message involved potentially multirequest transaction request identifier returned response request providing traceability single requestresponse envelope also contain api version something provided http path rest command request http may also contain dspushevent dsreturnevent query parameter get command optionally provided keyvalue pair represented message envelope query parameter optionally allows parameter future json correlationid aeaccbcdabfe apiv queryparams dspusheventtrue dsreturneventtrue note rest request dsreturnvent message envelope would returned payload would event return command message payload request message payload command service relayed device service would mimic httprest request body payload provides detail needed executing command south side example get put message note envelope wrap encases message payload payload may empty typical get request json correlationid aeaccbcdabfe apiversion requestid eeafebeb queryparams dspusheventtrue dsreturneventtrue correlationid aeaccbcdabfe apiversion requestid eeafebeb payload ahutargettemperature ahutargetband ahutargethumidity accuracy value note payload could empty therefore optional message structure exemplified top example response message payload would contain response south side typically edgex eventreading object case get request would also include error message detail example response message get put request shown note message envelope wrap response payload json correlationid aeaccbcdabfe apiversion requestid eeafebeb errorcode payload event apiversion fafbfccfafa devicename string profilename string created origin reading string tag gatewayid houstonstore latitude longitude correlationid aeaccbcdabfe apiversion requestid eeafebeb errorcode payload message string note get command response may include cbor data message envelope content type indicator indicate payload either cbor json message envelope content type indicator rest communication message bus communication alert open discussion per working group meeting review validating message version case per lennyintel validate incoming rest request particular version apis per monthly architect meeting yes validating done rest either implement validation message communication also add validation rest communication future levski release add future planning meeting topic api version response per iainanderson would api version implied request would mean response per monthly architect meeting dto already api version payload automatically additionally decided add message envelope reason rest path request includes version message communication lack urlpath beneficial also include version envelope addition payload part dto easily determined envelope without dig around payload per core meeting discussion really request redundant based already correlation per monthly architect meeting request correlation two different thing request returned response request providing traceability single requestresponse correlation track across entire transaction many service requestresponses providing traceability across transaction often across many service needed kept request payload per monthly architect meeting kept message envelope message payaload per core meeting discussion code mimic resthttp code response really want mimic http message bus approach suggested farshidtz maybe error boolean message indicate error condition per monthly architect meeting errorcode provide indication error errorcode error indicating error two enums error condition today future determine additional error add enums error code number error errorcode set payload contains message string indicating information error error errorcode message string payload code error code belong payload envelope would header rest reference iotaap mqtt rest bridge provides code message string translation example mean handle problem something similar per monthly architect meeting errorcode message envelope payload error payload contains single message string query message payload request message payload query command service would mimic httprest request body payload provides detail needed executing command south side example query get command note envelope wrap encases message payload payload empty query parameter include offset limit per rest counter part json correlationid aeaccbcdabfe apiversion requestid eeafebeb queryparams offset limit example query get command specific device name device name would topic query message would without information removed message queryparams optional correlationid aeaccbcdabfe apiversion requestid eeafebeb response message payload query would contain information necessary make messagebased command request example response message shown note message envelope wrap response payload json correlationid aeaccbcdabfe apiversion requestid eeafebeb errorcode payload apiversion devicecorecommands devicename testdevice profilename testprofile corecommands name coolingpoint get true topic edgexcommandrequesttestdevicecoolingpointget url brokeraddress parameter resourcename resource valuetype int devicename testdevice profilename testprofile corecommands name coolingpoint set true topic edgexcommandrequesttestdevicecoolingpointset url brokeraddress parameter resourcename resource valuetype string resourcename resource valuetype bool topic naming party system topic party system application must publish command request message edgex specified mqtt topic external message bus subscribe response message topic follow following pattern publishing command request topic edgexcommandrequestdevicenamecommandnamemethod subscribing command response topic edgexcommandresponse query following topic publishing query command request topic edgexcommandqueryrequest subscribing query command response topic edgexcommandqueryresponse command service topic command service must subscribe request topic party mqtt topic external message bus get command request publish topic send device service via edgex message bus internal message bus subscribe response message topic device service internal publish response message topic party mqtt broker external message topic command service would follow following standard subscribing party command request topic edgexcommandrequest publishing device service request topic edgexcommandrequestdeviceservicedevicenamecommandnamemethod subscribing device service command response topic edgexcommandresponse publishing party command response topic edgexcommandresponsedevicenamecommandnamemethod query following topic subscribing party command query request topic edgexcommandqueryrequest publishing party command query response topic edgexcommandqueryresponse device service topic device service must subscribe edgex command request topic internal message bus publish response message edgex command response topic following naming standard applied topic name subscribing command request topic edgexcommandrequest publishing command response topic edgexcommandresponsedeviceservicedevicenamecommandnamemethod configuration edgex command service device service must contain configuration needed connect publishsubscribe message topic edgex message bus internal includes configuration access message bus secure insecure command service must also provided configuration connect party mqtt broker topic external communication may done secure insecure fashion core command service provided access party mqtt broker external similar edgex application service command service access external mqtt broker get command request send party response require command service two message queue configuration setting internal external command service configuration example command service configuration provided toml messagequeue internalmessagequeue protocol redis host localhost port type redis requesttopicprefix edgexcommandrequest publishing request device service deviceservicedevicenamecommandnamemethod added publish topic prefix responsetopic edgexcommandresponse subscribing device service response authmode usernamepassword required redis messagebus secure insecure secretname redisdb externalmqtt protocol tcp host localhost port requestcommandtopic edgexcommandrequest subscribing party command request responsecommandtopicprefix edgexcommandresponse publishing response back party system devicenamecommandnamemethod added publish topic prefix requestquerytopic edgexcommandqueryrequest responsequerytopic edgexcommandqueryresponse note core command contains messagequeue configuration today additivenew configuration therefore backward compatible edgex implementation device service configuration example device service configuration provided toml messagequeue already existing message queue configuration sending eventsreadings message bus protocol redis host localhost port type redis authmode usernamepassword required redis messagebus secure insecure secretname redisdb publishtopicprefix edgexeventsdevice added publish topic prefix messagequeueoptional default mqtt specific enable environment variable override client identifier clientid devicerest connection information qos quality service value least exactly keepalive second must greater retained false autoreconnect true connecttimeout second skipcertverify false certkey file certkey pemblock specified new configuration allow device service also communicate via message bus core command commandrequesttopic edgexcommandrequest subscribing inbound command request commandresponsetopicprefix edgexcommandresponse publishing outbound command response added publish topic prefix note device service configuration existing based already communicate message bus publishing eventsreadings last two line added allow device service subscribe publish command message fromto message bus edgex service internal message bus request application service edgex service future may want also message communication make command request application service make command request today via rest order support following added command service also internal request topic internal response topic prefix configuration allow internal edgex service make command request query request toml messagequeue internalmessagequeue protocol redis host localhost port type redis requesttopicprefix edgexcommandrequest publishing request device service deviceservicedevicenamecommandnamemethod added publish topic prefix responsetopic edgexcommandresponse subscribing device service response internalrequestcommandtopic commandrequest subscribing internal command request internalresponsecommandtopicprefix commandresponse publishing response back internal service devicenamecommandnamemethod added publish topic prefix internalrequestquerytopic commandqueryrequest internalresponsequerytopic commandqueryresponse authmode usernamepassword required redis messagebus secure insecure secretname redisdb new command message client created allow internal service app service instance conveniently message bus communication core command client service configuration also expanded include corresponding topic usemessagebus flag enables new messaging based commandclient created example client configuration would look something like following toml client clientscorecommand usemessagebus true protocol redis host localhost port commandrequesttopicprefix commandrequest devicenamecommandnamemethod added publish topic prefix commandresponsetopic commandresponse commandqueryrequesttopic commandqueryrequest commandqueryresponsetopic commandqueryresponse question separate topic device would one device service suffice defined devicename parameterized topic one topic sufficient device service edgexcommandrequest would client non edgex service application want get list available command via message instead calling rest valid question could provided via later addition command service service like metadata future tackled immediately dynamic configuration message subscription user friendly operation today requiring configuration change future might want think creating additional apis addingupdatingdeletingquery external subscription store redisdb one could also consul change configuration would require configuration question added writable section acceptable one response published device service correlation send back acknowledged scheduled starting done correlation life span tofrom initial requester response back requester would make sense echo command name response reality check solved via topic naming also per lennyintel needed dont http response response topic doesnt extra path info request correlation needed match response request make complex would sendingreceiving binary data cbor supported northsouth message implementation today command service device service support cbor get operation set sdk suppports suggest getting feature parity place sdks exploring cbor support messaging binarycbor payload update per monthly architect meeting support get cbor payload message bus communication nonedgex party service application would bypass api gateway per monthly architect meeting since command service serving external internal message bus broker issue worth calling message bus security paradigm quite whats provided api gateway provides access control edgex api gateway security configuration defined edgex instance edgex service act bridge external message bus external bus properly configured application bus interact edgex instance thus security configuration defined external broker edgex finally note mqtt broker support topic acls based client username note number open question message structure section still addressed alert per tsc meeting discussion around error response reopened still polite disagreement whether keep error response simple documented adr offer errorcode enumeration similar http response code common problem part discussion question whether error code enumeration exactly http response code etc generic nonhttp response error code unique implementation resolution question explore implementation time enumeration http explored development brought forth via info adr handle securing message bus communication service covered universally upcoming adr future consideration desired query command could return information make either rest message request presumably query response would rest message query request information returned allows party application choose whether rest message bus make command request mentioned adr ekuiper allowed access directly internal edgex message bus special circumstance party external system communication future release edgex even ekuiper may routed external internal message bus bridge better decoupling security noted validation communication rest message bus done future future might want think creating additional apis addingupdatingdeletingquery external subscription store redisdb part consideration noted one could also consul change configuration would require configuration question added writable section consequence reference core command api