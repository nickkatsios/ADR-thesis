proxy uploads cloudfront user uploads file tdr file currently sent javascript running user browser straight aws upload bucket mean several http request user browser aws domain cognitoidentityeuwestamazonawscom exchange tdr access token cognito token stsamazonawscom exchange cognito token temporary aws credential session token longer expiry cognito token tdruploadfilesdirtyenvironmentseuwestamazonawscom upload file sequence request look like simplified slightly cors request multiple request auth server omitted clarity tdr user restricted network upload step completely fails could see video call one user network call tdr domain succeed one amazonawscom blocked think replace request amazonawscom request tdrnationalarchivesgovuk user able upload file considered involved proxying request service could assign tdr domain name didnt consider moving away integrates well process happen file uploaded file check export task proxy whatever choose solve problem sending data authorizing request user access object associated consignment another constraint wed like keep aws javascript sdk upload method automatically handle multipart uploads chunking file sending start end request combine chunk considered running nginx writing proxy code running lambda didnt look far mean maintaining extra service would also proxy request cognito sts find way aws javascript sdk send keycloak token upload request also looked website endpoint allow assign custom domain route bucket definitely support request plain http cannot make request http url nowhere add certificate ssl termination considered api gateway proxy lambda would either proxy cognito sts request found way add keycloak token aws javascript sdk upload request api gateway also maximum request time second might enough user uploading large file slow connection might required reduce default chunk size splitting file upload main looked cloudfront upload proxy built spike sandbox environment check would work see tdr main reason didnt stand obvious start documentation around cloudfront assumes want host static website tricky find right guide cloudfront upload proxy seem expected way cloudfront look like good authorisation considered restricting user permission upload file keep current system keycloak cognito sts credential user keycloak access token directly one cloudfronts system restricting content signed cooky signed url keeping existing token exchange process would meant proxying two extra request one cognito one sts already quite awkward three set token keycloak cognito sts another disadvantage cognito token authorisation iam policy cognito part object key restrict uploads user folder would fine except easy way link keycloak user cognito cognito generate user given valid token keycloak user requires user authenticate admin user cannot convert arbitrary keycloak cognito viceversa keycloak token would simplify workflow cloudfront could configure edge function validate token authorise request downside obviously compatible aws javascript sdk sdk set authorization header based aws credential clear add custom header based keycloak token wanted keycloak token authorise upload would write clientside javascript handle multipart uploads replace call sdk would still worth considering assumption change future ruled idea cloudfront signed url generate signed url every file inconvenient uploads thousand file signed url would fetched server consignment api also dont think signed url compatible aws javascript sdk sdk let set domain name whole url including query parameter contain cloudfront signature built cloudfront signed cooky compatible aws sdk set xhrwithcredentials true cooky associated cloudfront domain sent every request domain signature cookie wildcards cookie uploading multiple file user folder require extra authorisation step generate signed cooky lambda function validates keycloak token generates signed cooky based user keycloak proxy request cloudfront signed cooky authorisation instead uploading directly frontend direct uploads domain like uploadtdrnationalarchivesgovuk associated cloudfront instance cloudfront send request upload bucket request authorised cloudfront signed cooky generated lambda function sits behind cloudfront instance reason cloudfront instance service return setcookie header lambda must domain service requires cookie cloudfront upload request set cookie shared parent domain tdrnationalarchivesgovuk cookie would sent subdomains unnecessarily auth api domain api gateway required bridge cloudfront lambda cloudfront proxy request service fixed url diagram show service involved new upload process sequence request look like omitting cors preflight request multiple oauth request frontend updated send uploads tna domain hosted cloudfront rather straight aws javsascript sdk configured setting config awsconfigs endpoint httpsuploadtdrnationalarchivesgovuk sbucketendpoint true security security consideration similar new architecture uploads authenticated signed cooky rather cognito token restriction credential similar user sts credential signed cookie send put request upload data cannot send get request read still versioning enabled upload bucket data cannot lost overwriting authorisation also similar sts credential signed cooky allow user upload file object prefix match user act folder user permission upload file folder extra certificate stored securely one signing cooky store encrypt rotate way secret value tdr also couple advantage new approach signing cooky configure address allowed cookie cloudfront check address made http request address signed cookie policy mean leaked cookie could outside original user network signed cookie expiry fairly short javascript call lambda repeatedly get new cooky sts credential fairly longlived lifetime longer time might take upload single file credential set uploading file way reset middle upload signed cookie method refresh cooky separate loop file upload cookie lifetime short reduces damage done attacker signed cookie cost expect change significantly increase cost uploads uploaded data may multiple per consignment pass extra service cloudfront cloudfront ingres pricing perrequest rather pergb