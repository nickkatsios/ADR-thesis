record upgrade elasticsearch highlevel migration plan new cluster architecture elasticsearch compatibility connecting multiple elasticsearch cluster synchronising state data sync production staging integration testing elasticsearch decomissioning elasticsearch work done change made repository also significant change govukaws govukawsdata govukpuppet highlevel migration plan based experience migrating elasticsearch decided time wanted isolate complexity two elasticsearch cluster searchapi make searchapi work elasticsearch elasticsearch give searchapi support multiple elasticsearch cluster index change cluster add url parameter select cluster query perform onetime import data elasticsearch elasticsearch synchronise update missed import running confirm elasticsearch elasticsearch cluster consistent set test finderfrontend etc select elasticsearch cluster gradually phase elasticsearch elasticsearch retire elasticsearch approach took last time rummager searchapi running parallel necessitated one carrenza one aws led lot change govukpuppet didnt really give anything reusable adding multicluster support searchapi directly get something reusable new cluster architecture based experience running elasticsearch quarter first opted three dedicated master node type clargeelasticsearch six data node type rlargeelasticsearch found data node powerful enough switched rxlargeelasticsearch talking aws solution architect changed rxlargeelasticsearch due wider govuk scaling concern caused political activity increased data node rxlargeelasticsearch also shrunk cluster staging production size cope indexing load final cluster size environment master data production clargeelasticsearch rxlargeelasticsearch staging clargeelasticsearch rxlargeelasticsearch integration tmediumelasticsearch rlargeelasticsearch cluster configured appelasticsearch terraform project elasticsearch compatibility deprecation message elasticsearch error message elasticsearch figure needed change change needed index query index change switching string field text keyword field removing field includeinall query change like instead doc morelikethis query replacing match type phrase matchphrase query replacing index query query indicesshould change introduced inefficiency query generation ask elasticsearch real name alias added new buildquery metric keep track elasticsearch issue opened february solution problem also changed text similarity metric classic similarity new similarity connecting multiple elasticsearch cluster elasticsearchyml file contains list cluster cluster specify schema configuration file mean try different indexlevel setting new cluster example changing text similarity metric elasticsearch code multicluster support implemented searchconfig indexclient class cluster selection implemented searchparameterparser class involved significant refactoring main architectural made index writes cluster ensuring cluster consistency perform query default cluster unless url parameter given test cluster one searchconfig singleton per cluster change result detail cluster leaking throughout searchapi unfortunate addressed future refactoring work example passing around searchconfig instance rather asking cluster singleton synchronising state planned either take snapshot elasticsearch restore elasticsearch approach last upgrade script copy data across turned unnecessary searchapi running cluster couple week started think synchronising data time everything republished either directly result dependency resolution govuk government detailed index consistent elasticsearch pagetraffic index also handled multicluster work traffic data saved cluster index needed manual work metasearch hold best bet attempting republish searchadmin kept failing due transient network issue getting best bet seemed impossible metasearch index script python elasticsearch import elasticsearch elasticsearch transporterror transporterror elasticsearch import elasticsearch elasticsearch transporterror transporterror elasticsearchhelpers import bulk datetime import datetime import index metasearch genericdoctype genericdocument eshostport osgetenvesoriginhost httpelasticsearch estargetport osgetenvestargethost httpelasticsearch esclient elasticsearcheshostport esclient elasticsearchestargetport def preparedocsforbulkinsertdocs doc doc yield docid source docsource def bulkindexdocumentstoesdocuments try bulk esclient preparedocsforbulkinsertdocuments indexindex doctypegenericdoctype chunksize except transporterror printfailed index document stre def fetchdocumentsfrom pagesize scrollidnone try scrollid none result esclientsearchindex genericdoctype fromfrom sizepagesize scrollm scrollid resultsscrollid else result esclientscrollscrollidscrollid scrollm doc resultshitshits return scrollid doc except transporterror printfailed fetch document stre return stre estatuscode name main start datetimenow dcount esclientcountindexindex doctypegenericdoctypecount printpreparing index document esformatdcount offset pagesize scrollid none offset dcount scrollid doc fetchdocumentsfromoffset pagesizepagesize scrollidscrollid printindexing document esformatoffset offsetpagesize bulkindexdocumentstoesdocs offset pagesize printfinished secondsformatdatetimenow start data sync production staging integration done way elasticsearch data sync script needed modified allow different host httpelasticsearch httpelasticsearch otherwise matter writing configuration testing elasticsearch test set like configuration govukcdnconfig logic finderfrontend pas one two url parameter searchapi based cdnlevel test logic searchapi choose cluster based parameter finderfrontend general test process covered dev doc test monitored clickthrough rate proportion search refinement proportion search exit test revealed significant degradation metric compared elasticsearch unable proceed switch without work improve search result two main change elasticsearch impacted search result quality switching classic similarity similarity issue arose elasticsearch decided ahead new similarity moving elasticsearch removal query coordination factor affecting scoring multiclause must query meant even switched back classic similarity wouldnt get result elasticsearch query coordination factor multiclause must query scored sumclause score nummatching clause numclauses query clause match overall score multipled effect make document match multiple clause tend rank higher document match fewer clause even fewer clause matched really well assumption number matching clause important predictor relevance without query coordination factor query scored sumclause score figuring improve search query straightforward particularly systematic process elasticsearch query ruby bool matchphrasetitle query matchphraseacronym query matchphrasedescription query matchphraseindexablecontent query matchalltermswtitle acronym description indexablecontent query matchanytermswtitle acronym description indexablecontent query minimumshouldmatchallsearchabletext query elasticsearch query settled ruby shouldcoordquery matchalltermswtitle query matchalltitleboost matchalltermswacronym query matchallacronymboost matchalltermswdescription query matchalldescriptionboost matchalltermswindexablecontent query matchallindexablecontentboost matchalltermswtitle acronym description indexablecontent query matchallmultiboost matchanytermswtitle acronym description indexablecontent query matchanymultiboost minimumshouldmatchallsearchabletext query matchminimumboost shouldcoordquery reimplementation query coordination factorbased scoring functionscore query also changed matchphrase clause elasticsearch query matchallterms clause adjusted field boosting factor ran test found elasticsearch new query clickthrough rate within percentage point elasticsearch old query decided good enough ahead switch decomissioning elasticsearch step followed switch elasticsearch permanently decomission elasticsearch switch searchapi variant test disable cluster indexing done disable test govukcdnconfig finderfrontend remove elasticsearch configuration govukpuppet remove elasticsearch govukaws didnt want permanently configuration required care change set elasticsearchuri environment variable value elasticsearchburi environment variable govukpuppet swap cluster configuration cluster configuration unset elasticsearchburi environment variable govukpuppet approach avoided coordinate simultaneous deploys searchapi govukpuppet