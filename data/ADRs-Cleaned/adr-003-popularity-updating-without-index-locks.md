record perform popularity updating without index lock current nightly job work locking current index queuing record index starting threaded work insert record new index updated popularity waiting work finish switch new index release index lock fact process requires index locked process run mean prefer run hour doesnt block insertion new content index locking required document edits reindex process blocked writing old index would discarded lock block write process completed switched new index turn mean create new index write updated popularity data old index currently locked code quite complicated manage threaded workload difficult test reason part building new govuk index want simplify process ideally avoid index locking mean sidekiqs concurrency implementation instead longer able unlock index end process external versioning dont index locking switching instead overwrite existing document copy updated popularity figure following scenario outline different outcome given piece content called documenta currently index version popularity update process create job update content let call joba popularity figure today let call poptoday get update documenta popularity update process running let call updatea updatea generated popularity figure equal poptoday joba result one two thing occurring updatea occurs joba case joba ignored earlier version documenta leaving value updatea search index joba occurs updatea case update occur leaving value updatea search index process would fail versiontype set external would succeed versiontype set externalgte elasticsearch documentation state externalgte incorrectly result loss data external versioning multiplier multiplying external version field multiplier inserted elasticsearch possible increment version field time transient data update normal versiontype external would skip transient data update content updated would mean multiplier could daily update approx year multiplier could daily update approx year two similar implementation minor difference result going easier two externalgte updating single field popularity risk data loss quite low additional advantage choosing approach index arent currently external versioning inplace edit current version taken start reindex process ignored content changed version automatically incremented