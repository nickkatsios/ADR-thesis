sync route proposal history maintain reliability event temporary network partition must ensure user desired state consistent across component past weve done bulk sync agent like nsyncbulker processessync copilotsync component share similar goal fetch desired state ensure consistently represented everywhere become actual state practice modern version bulk sync loop page ccdb api make request external component diego copilot metac ensure internal state consistent value ccdb kubernetes kubernetes also implemented via series bulk sync loop commonly known controller key difference convergence loop work watch api client client subscribe incremental change desired actual state ksioclientgocache provides mechanism client build maintain local cache kubernetes state kubebuilder provides amongst thing sdk building reconciliation loop top watch client side caching problem solution illustrate necessity sync loop help think improve resiliency case temporary network partition perspective api problem update ccdb succeed update route crd fail problem update route crd succeed update ccdb fail handle failure mode several approach taken mimic historical sync loop problem ccdb route crd solution raise error user allow ccdb transaction commit bulk sync loop detect route crd missing create later problem route crd ccdb solution raise error user dont route crd write ccdb change committed solution bulk sync loop detect route crd extraneous delete later forgo bulk sync attempt bootstrap consistency ccdb transaction problem ccdb route crd solution raise error user abort ccdb transaction problem route crd ccdb solution roll back change route crd still fails due network partition sync ccdb problem ccdb route crd solution raise error user abort ccdb transaction problem route crd ccdb solution raise error user leave route crd bulk sync loop consider route reconciled correct ccdb viable long term implementation tradeoff ccdbks sync ruby mimic processessync efficient access ccdb run independent process clockglobal avoid bosh entanglement unclear scale limitation might encounter regularly download route apiks sync probably new independent program take advantage goclient cache reflector avoid repeatedly downloading state mean reconcile change single route crd ccdb authoritative would page api build picture state sync ksccdb kubebuilder controller reloads probably routescontroller akin existing kpack buildscontroller take advantage goclient cache reflector avoid repeatedly downloading state take advantage existing kubebuilder pattern reconciling change single route crd mean verifying api loaded route reconcile must post vrouteguidreload endpoint api must succeed given resource loaded reconcile call requires successful call endpoint else itll reqeued endpoint must short circuit provided resourceversion match one stored ccdb avoids endless loop avoids unnecessary traffic normal operation api must careful commit change ccdb failed applied practice mean route operation must occur inside ccdb transaction failure mode restarting routescontroller would resync existing route hard handle route missing still present ccdb theory never happen delete would reconciled practice could happen due bug might require periodically post vroutesguidreload every route ccdb anyways operator rare case route count outofsync maybe patch cause deletes gone allows platform operator add route part cfforks configuration could viewable via api ended taking bit hybrid approach apiks sync sync ksccdb kubebuilder controller reloads discussion adr became apparent could kubebuilder build bulk sync loop reconciles route api added new crd periodicsync controller cfapicontrollers api source truth periodicsyncreconciler run existing cfaicontrollermanager reconciles vroutes periodically consequence pro correct behavior extra route case hard solve proposal minimal new ruby code minimal unnecessary api load custom logic managing periodicity reliance existing clock mechanism thanks kubebuilder doesnt prevent optimizing perroute reconciliation later routedoesntexist might little wonky likely still possible periodicsync crd type field hopefully reuse work resource like droplet lrps loop would also necessary syncing ksccdb sync direction cant detect extra ccdb route without loop like con similar existing sync loop care must taken prevent loop exiting early error always easy ccdb access cfapicontrollers serializingdeserializing vroutes frequently punted pagination limiting route handling pagination future might challenging especially cause miss route ccdb