adr sql performance profiling superceded simple android app driven almost entirely local database great application reliability inconsistent poor network condition also problem event running expensive database query amount data queried large historically led case tend look optimizing performance specific screen becomes problem production receive report field lead degraded user experience significant portion user base however much time take fix issue reported plus additional stress team working fixing performance issue problem ongoing field goal overall goal reach state collect performance information sql query automatically field report appropriate tool expect performance issue reach problematic stage production fix proactively approach currently room database framework defining database entity model give bunch benefit also introduces layer abstraction allow automatic query profiling easily library work developer define interface annotation describe sql query run gradle plugins process interface defined generate actual implementation directly available developer add profiling code sample interface definition kotlin dao abstract class roomdao queryselect loggedinuser limit abstract fun user flowablelistuser queryselect loggedinuser limit abstract fun userimmediate user sample generated implementation java public final class userroomdaoimpl extends userroomdao private final roomdatabase private final entityinsertionadapter insertionadapterofuser private final uuidroomtypeconverter uuidroomtypeconverter new uuidroomtypeconverter private final userstatusroomtypeconverter roomtypeconverter new userstatusroomtypeconverter private final instantroomtypeconverter instantroomtypeconverter new instantroomtypeconverter private final userloggedinstatusroomtypeconverter roomtypeconverter new userloggedinstatusroomtypeconverter private final usercapabilitystatusroomtypeconverter roomtypeconverter new usercapabilitystatusroomtypeconverter private final entitydeletionorupdateadapter deletionadapterofuser private final sharedsqlitestatement preparedstmtofupdateloggedinstatusforuser private final sharedsqlitestatement preparedstmtofsetcurrentfacility private final syncstatusroomtypeconverter roomtypeconverter new syncstatusroomtypeconverter public userroomdaoimplroomdatabase thisdb override public flowable user final string sql select loggedinuser limit final roomsqlitequery statement roomsqlitequeryacquiresql return rxroomcreateflowabledb false new stringloggedinuser new callable override public list call throw exception final cursor cursor dbutilquerydb statement false null try final int cursorindexofuuid cursorutilgetcolumnindexorthrowcursor uuid final int cursorindexoffullname cursorutilgetcolumnindexorthrowcursor fullname final int cursorindexofphonenumber cursorutilgetcolumnindexorthrowcursor phonenumber final int cursorindexofpindigest cursorutilgetcolumnindexorthrowcursor pindigest final int cursorindexofstatus cursorutilgetcolumnindexorthrowcursor final int cursorindexofcreatedat cursorutilgetcolumnindexorthrowcursor createdat final int cursorindexofupdatedat cursorutilgetcolumnindexorthrowcursor updatedat final int cursorindexofloggedinstatus cursorutilgetcolumnindexorthrowcursor loggedinstatus final int cursorindexofregistrationfacilityuuid cursorutilgetcolumnindexorthrowcursor registrationfacilityuuid final int cursorindexofcurrentfacilityuuid cursorutilgetcolumnindexorthrowcursor currentfacilityuuid final int cursorindexofteleconsultphonenumber cursorutilgetcolumnindexorthrowcursor teleconsultphonenumber final int cursorindexofcanteleconsult cursorutilgetcolumnindexorthrowcursor capabilitycanteleconsult final list result new arraylistcursorgetcount whilecursormovetonext final user item final uuid tmpuuid final string tmp tmp cursorgetstringcursorindexofuuid tmpuuid uuidroomtypeconvertertouuidtmp final string tmpfullname tmpfullname cursorgetstringcursorindexoffullname final string tmpphonenumber tmpphonenumber cursorgetstringcursorindexofphonenumber final string tmppindigest tmppindigest cursorgetstringcursorindexofpindigest final userstatus tmpstatus final string tmp tmp cursorgetstringcursorindexofstatus tmpstatus roomtypeconvertertoenumtmp final instant tmpcreatedat final string tmp tmp cursorgetstringcursorindexofcreatedat tmpcreatedat instantroomtypeconvertertoinstanttmp final instant tmpupdatedat final string tmp tmp cursorgetstringcursorindexofupdatedat tmpupdatedat instantroomtypeconvertertoinstanttmp final userloggedinstatus tmploggedinstatus final string tmp tmp cursorgetstringcursorindexofloggedinstatus tmploggedinstatus roomtypeconvertertoenumtmp final uuid tmpregistrationfacilityuuid final string tmp tmp cursorgetstringcursorindexofregistrationfacilityuuid tmpregistrationfacilityuuid uuidroomtypeconvertertouuidtmp final uuid tmpcurrentfacilityuuid final string tmp tmp cursorgetstringcursorindexofcurrentfacilityuuid tmpcurrentfacilityuuid uuidroomtypeconvertertouuidtmp final string tmpteleconsultphonenumber tmpteleconsultphonenumber cursorgetstringcursorindexofteleconsultphonenumber final usercapabilities tmpcapabilities cursorisnullcursorindexofcanteleconsult final usercapabilitystatus tmpcanteleconsult final string tmp tmp cursorgetstringcursorindexofcanteleconsult tmpcanteleconsult roomtypeconvertertoenumtmp tmpcapabilities new usercapabilitiestmpcanteleconsult else tmpcapabilities null item new usertmpuuidtmpfullnametmpphonenumbertmppindigesttmpstatustmpcreatedattmpupdatedattmploggedinstatustmpregistrationfacilityuuidtmpcurrentfacilityuuidtmpteleconsultphonenumbertmpcapabilities resultadditem return result finally cursorclose override protected void finalize statementrelease override public user userimmediate final string sql select loggedinuser limit final roomsqlitequery statement roomsqlitequeryacquiresql dbassertnotsuspendingtransaction final cursor cursor dbutilquerydb statement false null try final int cursorindexofuuid cursorutilgetcolumnindexorthrowcursor uuid final int cursorindexoffullname cursorutilgetcolumnindexorthrowcursor fullname final int cursorindexofphonenumber cursorutilgetcolumnindexorthrowcursor phonenumber final int cursorindexofpindigest cursorutilgetcolumnindexorthrowcursor pindigest final int cursorindexofstatus cursorutilgetcolumnindexorthrowcursor final int cursorindexofcreatedat cursorutilgetcolumnindexorthrowcursor createdat final int cursorindexofupdatedat cursorutilgetcolumnindexorthrowcursor updatedat final int cursorindexofloggedinstatus cursorutilgetcolumnindexorthrowcursor loggedinstatus final int cursorindexofregistrationfacilityuuid cursorutilgetcolumnindexorthrowcursor registrationfacilityuuid final int cursorindexofcurrentfacilityuuid cursorutilgetcolumnindexorthrowcursor currentfacilityuuid final int cursorindexofteleconsultphonenumber cursorutilgetcolumnindexorthrowcursor teleconsultphonenumber final int cursorindexofcanteleconsult cursorutilgetcolumnindexorthrowcursor capabilitycanteleconsult final user result ifcursormovetofirst final uuid tmpuuid final string tmp tmp cursorgetstringcursorindexofuuid tmpuuid uuidroomtypeconvertertouuidtmp final string tmpfullname tmpfullname cursorgetstringcursorindexoffullname final string tmpphonenumber tmpphonenumber cursorgetstringcursorindexofphonenumber final string tmppindigest tmppindigest cursorgetstringcursorindexofpindigest final userstatus tmpstatus final string tmp tmp cursorgetstringcursorindexofstatus tmpstatus roomtypeconvertertoenumtmp final instant tmpcreatedat final string tmp tmp cursorgetstringcursorindexofcreatedat tmpcreatedat instantroomtypeconvertertoinstanttmp final instant tmpupdatedat final string tmp tmp cursorgetstringcursorindexofupdatedat tmpupdatedat instantroomtypeconvertertoinstanttmp final userloggedinstatus tmploggedinstatus final string tmp tmp cursorgetstringcursorindexofloggedinstatus tmploggedinstatus roomtypeconvertertoenumtmp final uuid tmpregistrationfacilityuuid final string tmp tmp cursorgetstringcursorindexofregistrationfacilityuuid tmpregistrationfacilityuuid uuidroomtypeconvertertouuidtmp final uuid tmpcurrentfacilityuuid final string tmp tmp cursorgetstringcursorindexofcurrentfacilityuuid tmpcurrentfacilityuuid uuidroomtypeconvertertouuidtmp final string tmpteleconsultphonenumber tmpteleconsultphonenumber cursorgetstringcursorindexofteleconsultphonenumber final usercapabilities tmpcapabilities cursorisnullcursorindexofcanteleconsult final usercapabilitystatus tmpcanteleconsult final string tmp tmp cursorgetstringcursorindexofcanteleconsult tmpcanteleconsult roomtypeconvertertoenumtmp tmpcapabilities new usercapabilitiestmpcanteleconsult else tmpcapabilities null result new usertmpuuidtmpfullnametmpphonenumbertmppindigesttmpstatustmpcreatedattmpupdatedattmploggedinstatustmpregistrationfacilityuuidtmpcurrentfacilityuuidtmpteleconsultphonenumbertmpcapabilities else result null return result finally cursorclose statementrelease shown two broad category query generally throughout app synchronous query userimmediate roomdao described earlier example synchronous query query execute thread invoked directly query database relatively easier instrument since measure time taken execute method report tracking software approach automatically would something like dynamic proxy allows replace implementation interface runtime however second type query lot place app work method reactive asynchronous query user roomdao described earlier example reactive asynchronous query seen return type method one ioreactivex primitive type advantage power application background change data load automatically update without application explicitly requery data make building quite easy however make measuring performance hard measuring much time take invoke database method give amount time required query database give time required instantiate reactive type instance time looking measure time taken reactive instance returned subscribed hard measure automatically room database way access reactive type instantiated within generated dao implementation possible manually measure error prone since requires every developer manually instrument query write easy miss approach bytecode processing since room library generates database implementation cannot access first approach attempted process edit bytecode part final apk tried library called javassist insert bytecode statement class file generated dao implementation track time measure database query performance approach doable turned quite complex generated bytecode deeply coupled version room library would also require significant learning curve developer needing understand jvm bytecode order work approach deemed expensive order final approach approach java abstract syntax tree ast processing approach required mixture runtime code processing generated code way work two separate component working together integrate tool simple android build process process java code javaparser generated room output metadata get embedded part final apk raw asset file metadata contains information generated code like name generated dao file method dao file beginning ending line number method csv userroomdaoimpluser userroomdaoimpluserimmediate proof concept tool available httpsgithubcomsimpledotorgroommetadatagenerator runtime wrapper around supportsqliteopenhelper class wrapper process previously generated metadata packaged app provided room database sqlite implementation whenever database query made manually create throwable instance full stacktrace method call including line number method call walk stacktrace find generated dao line sqlite method invoked perform reverse lookup generated dao metadata find exactly method responsible invoking sqlite method fairly trivial track amount time required report reporting tool choice sample query run time taken show quite effective shell isearchperf time taken userroomdaoimpluserimmediate isearchperf time taken userroomdaoimplcurrentfacility isearchperf time taken userroomdaoimpluser isearchperf time taken userroomdaoimpluserandfacilitydetails isearchperf time taken patientroomdaoimplpatientcount isearchperf time taken userroomdaoimplcurrentfacility isearchperf time taken medicalhistoryroomdaoimplcount isearchperf time taken appointmentroomdaoimplcount isearchperf time taken prescribeddrugroomdaoimplcount isearchperf time taken userroomdaoimpluserimmediate isearchperf time taken userroomdaoimplcurrentfacilityimmediate isearchperf time taken teleconsultrecordroomdaoimplcount isearchperf time taken bloodsugarmeasurementroomdaoimplcount isearchperf time taken bloodpressuremeasurementroomdaoimplcount isearchperf time taken recentpatientroomdaoimplrecentpatients approach seems promising decided proceed consequence performance impact one thing wanted make sure work required implement instrumentation impact application performance much expensive part performance tracking implementation creating throwable filling stacktrace take millisecond low end device samsung galaxy core impact atleast order magnitude time taken run query profile every single query run app important get sense query degrading faster scale randomly sample small percentage query run give enough data time across entire userbase limitation minification tooling rely build tooling process generated code extract method metadata work android minification toolchain minification obfuscation decide turn code obfuscation reason would also update build tooling either skip obfuscation generated room dao file process mapping file generated obfuscation tooling update generated metadata retain information unlikely problem since application open source obfuscate final apk way currentlly minification tooling retain line number class file lne number present stack trace changing would remove line number stacktrace get generated runtime preventing tool working simple way guard would add comment minification configuration file anyone change file warned also affect part app paging library currently paging library order lazy load list app due implementation detail room generates class performance tooling able determine dao method called paginated source invokes database query query ignored reporting currentlly paginated list three feature app one frequently overdue feature would good solution explicitly aware fact query tracked begin start collecting data rest query investigate adding support query soon rest reporting instrumentation place overloaded method current tooling implementation report method name part metadata however quite instance dao method name different signature parameter method name confuse reporting since performance information overloaded method reported name different could approach one three way fail build overloaded dao method found report build error renamed make entire method signature part metadata combining parameter method name order generate final metric name result metric name hard read since someone looking metric look method specific signature source annotation order define metric name reported instead actual method name update tooling look specific source level annotation overloaded dao method name metric instead actual method name tooling even enforce failing build overloaded method without source annotation present chose first approach failing build since simplest approach