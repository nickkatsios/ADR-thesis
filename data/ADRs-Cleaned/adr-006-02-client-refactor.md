adr client refactor changelog initial draft applied ibcgo initial development client submodule light client supported solomachine tendermint localhost referenced hardcoding example code existed client submodule func keeper updateclientctx sdkcontext clientid string header exportedheader exportedclientstate error switch clienttype case exportedtendermint clientstate consensusstate err tendermintcheckvalidityandupdatestate clientstate header ctxblocktime case exportedlocalhost override client state update block height clientstate localhosttypesnewclientstate ctxchainid chain since client running chain self ctxblockheight default err typeserrinvalidclienttype add additional light client code would added directly client submodule evidently would likely become problematic ibc scaled many chain consensus mechanism beyond initial supported light client issue sdk addressed problem creating modular client submodule client submodule would interact light client via interface change positive development increasing flexibility adoptability ibc also opened door new problem difficulty generalizing light client became apparent change light client required light client represents different consensus algorithm may contain host complexity nuance example issue arose light client applicable light client supported solomachine tendermint localhost tendermint nonzero height upgrade launch ibc determined golang implementation tendermint would capable supporting nonzero height upgrade implies upgrade would require changing chain resetting height chain uniquely identified chainid validator set two different chain viewed different chain thus normal update produced validator set cannot change chain work around lack support nonzero height upgrade abstract height type created along upgrade mechanism type would indicate revision number number time chain changed revision height current height blockchain ref issue ibc specification repository specification change implementation change abstract height type sdk tendermint requires misbehaviour detection update initial release ibc module tendermint light client implementation support misbehaviour detection update prevent overwriting previous update despite fact designed clientstate interface developed tendermint client failed detect even duplicate update constituted misbehaviour thus freeze client fixed required light client implementation aware must handle duplicate update misbehaviour detection misbehaviour detection update applicable solomachine localhost also obvious checkheaderandupdatestate performing functionality localhost requires access entire client store localhost broken since initial version ibc module localhost tried developed underneath client interface without special exception proved impossible issue outlined discussed attempted adr unlike client localhost requires access entire ibc store prefixed client store solomachine doesnt set consensus state solomachine set consensus state within prefixed client store single consensus state stored within client state cause setting consensus state client level unnecessary storage also cause timeouts fail solo machine previously timeout logic within ibc would obtain consensus state height timeout proved problematic solo machine consensus state set see issue ibc specification repo new client may want batch update new light client may function similar fashion solomachine tendermint may require setting many consensus state single update seunlanlege state support change reason would allow light client handle batch header update checkheaderandupdatestate special case beefy proving finality batch header much space time efficient spacetime complexity proving individual header batch combined also allows single light client instance beefy prove finality every parachain connected relay chain polkadotkusama achieve setting appropriate consensusstate individual parachain header checkheaderandupdatestate require light client set client consensus state ibc specification state provided header valid client must also mutate internal state store nowfinalised consensus root update necessary signature authority tracking change validator set future call validity predicate initial version ibc sdk based module fulfill requirement instead client submodule required light client return client consensus state updated client prefixed store lead issue solomachine doesnt set consensus state new client may want batch update light client required set client consensus state update necessary implementation changed match specification requirement allow flexibility light client manage internal storage batch update merge headermisbehaviour interface rename clientmessage remove getheight header interface light client set clientconsensus state result headermisbehaviour interface reduce complexity codebase headermisbehaviour interface merged clientmessage clientmessage provide client authenticated information may result regular update misbehaviour detection batch update custom functionality light client requires split checkheaderandupdatestate function see split checkheaderandupdatestate function verifyclientmessage checkformisbehaviour updatestateonmisbehaviour updatestate verifyclientmessage check structure clientmessage correct authentication data provided valid checkformisbehaviour check see clientmessage evidence misbehaviour updatestateonmisbehaviour freeze client update state accordingly updatestate performs regular update noop duplicate update code roughly look like func keeper updateclientctx sdkcontext clientid string header exportedheader error err clientstateverifyclientmessageclientmessage err nil return err foundmisbehaviour clientstatecheckformisbehaviourclientmessage foundmisbehaviour clientstateupdatestateonmisbehaviourheader emit misbehaviour event return clientstateupdatestateclientmessage expects noop duplicate header emit update event return add gettimestampatheight client state interface adding gettimestampatheight clientstate interface allow light client nontraditional consensus statetimestamp storage process timeouts correctly fix issue outlined solo machine client add generic verification function complexity functionality grows new verification function required additional path explained specification repo generic verification function would immediately useful new path added connectionchannel upgradability well custom path defined ibc application interchain query old verification function verifyclientstate verifyconnection etc removed favor generic verification function consequence positive flexibility light client implementation well defined interface required functionality generic verification function applies change necessary future clientconnectionchannel upgrabability feature timeout processing solo machine reduced code complexity negative refactor touch sensitive area ibcgo codebase changing established naming headermisbehaviour clientmessage neutral notable consequence reference issue