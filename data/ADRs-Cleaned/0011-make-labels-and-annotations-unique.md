adding key prefix annotation database label annotation table currently lack unique constraint lead potential insertion duplicate metadata labelsannotations due race condition occurs two vms receive update request concurrently find existing metadata object table subsequently issue create given absence preventative measure schema result duplicate entry sometimes differing value database leading undefined behavior inconsistency metadata cause api return different result different call ensure data integrity consistency crucial prevent duplicate database metadata object proposed solution set unique constraint labelsresourceid keyprefix keyname annotationsresourceid keyprefix key however several nonobvious consideration related postgres mysql behavior null value database mysql postgres always unique nullnull sql make unique constraint effective must allow null value key column annotation table type varchar length long mysql create unique constraint api doc limit key length annotation character adjusting column length advantageous removal duplicate metadata table critical ensure new duplicate inserted migration run otherwise would fail setting unique constraint table locking table migration modify code insert empty string database convert nil model maintain current behavior compare string value handle empty string column keyprefix key column null value point add code manage unique constraint violation updating labelsannotations retry eliminate race condition ensure select return valid object thereby preventing second create metadata table introduce migration modifies schema sanitizes metadata table annotation table lock table trim key longer character never actually occur done prevent migration failure reduce column length key column character convert null value keyprefix column empty string set null constraint column resourceid keyprefix key find delete duplicate value column resourceid keyprefix key equal set unique constraint column resourceid keyprefix key label table lock table convert null value keyprefix column empty string set null constraint column resourceid keyprefix keyname find delete duplicate value column resourceid keyprefix keyname equal set unique constraint column resourceid keyprefix keyname modify code clean stop handling null value empty string point please note step backward compatible version step backward compatible version includes change step consequence positive consequence api behave correctly duplicate longer occur negative consequence staged rollout necessary requiring clear documentation limitation upgrade path two change necessitate specific minimum cfdeploymentcapi version