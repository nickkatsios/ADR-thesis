jetstream simplification metadata value author aricart derekcollison tbeets scottf jarema piotrpio approved tag jetstream client spec problem statement consuming message jetstream require large number design client api user current jetstream client create update consumer definition fly subscribe functionality consuming message invoked lead unexpected behavior different client possibly written different version different library attempt consume consumer client implementing jetstream code also confronted choice whether implementing pull push subscriber goal adr provide simpler api jetstream user reduces number confronted provides expected performance design jetstream api consists three main component jetstreamcontext stream consumer jetstream jetstream mainly responsible managing stream serf entry point creating configuring controlling stream jetstreamcontext also expose method manage consumer directly bypassing getcreate stream example set method jetstreamcontext stream operation addstreamstreamconfig updatestreamstreamconfig getstreamstreamname deletestreamstreamname liststreams consumer operation getconsumerstreamname consumername createconsumerstreamname consumerconfig updateconsumerstreamname consumerconfig createorupdateconsumerstreamname consumerconfig deleteconsumerstreamname consumername accountinfo stream stream created jetstreamcontext provide set operation managing stream content stream perform operation purging entire stream fetchingdeleting individual message stream also allow managing consumer example set method stream operation consumer getconsumerconsumername createconsumerconsumerconfig updateconsumerconsumerconfig createorupdateconsumerconsumerconfig deleteconsumerconsumername operation stream purgepurgeopts info gettingdeleting individual message getmsggetmsgopts deletemsgdeletemsgopts consumer consumer jetstream api entity message read consumer expose method getting consumer info well method consuming message consume fetch next example set method consumer operation consumer instance info operation consume message consume fetch next design naming individual client library client library implementing jetstream api adhere languagespecific library best practice following outlined design method name may vary add versus create certain method may placed differently based idiomatic convention consumerdelete instead streamdeleteconsumerconsumername library may support chaining functionality aligns jetstream implementation semantics getstreamnamegetconsumername operation consumer following operation fetch next consume info optional operation return consumer info consumer delete optional operation delete referenced consumer lifecycle consume may controlled example stop delivering message callback drain message already accumulated stopping consumer additional method consumer implementation appropriate object return value callback driven consumer note pull request issued client clientside timeouts addition serverside timeout expiry clientside timeout value always larger expiry fetch get one message operation end rpc expires number messagesdata batch requested provided user control retrieve message server depending language message delivered via callback signal indicate fetch finished could message null via iterator functionality getting next message block message yielded operation operation finish terminates iterator client also expose fetch certain amount data maxbytes instead message depending language either fetch different consumer method fetchbytes fetch configuration maxmessages number max number message return expires number amount time wait request expire nanosecond maxbytes number max number byte return idleheartbeat number amount idle time server wait sending heartbeat request expires heartbeat enabled default note maxmessages maxbytes described optional least one required next get single message server pull request fetch message sent next invoked depending language implementation may fetchmaxmessages return iterator next configuration expires number amount time wait request expire nanosecond idleheartbeat number amount idle time server wait sending heartbeat request expires heartbeat enabled default consume retrieve message server maintaining buffer refill point message processing client may want way drain buffer iterator without pulling message client cleanly stop without leaving many message unacked consume configuration maxmessages number max number message stored buffer expires number amount time wait single pull request expire maxbytes number max number byte stored buffer idleheartbeat number amount idle time server wait sending heartbeat thresholdmessages number number message left buffer trigger low watermark client influence request message thresholdbytes number hint number byte left buffer trigger low watermark client influence request data note maxmessages maxbytes exclusive client allow depending constraint provided client default value maxmessages set maxbytes constraint corresponding threshold set note maxbytes set client set batchsize request large number instead leaving empty bypass server sending one message batchsize default constraint default configuration value consume may vary client implementation depending value efficient specific programming language maxmessages depends client probably message expires default minimum maxbytes set maxmessages provided idleheartbeat default expires capping minimum maximum thresholdmessages maxmessages thresholdbytes maxbytes client make sure consume work properly maxmessages set getting stuck default thresholdmessages consume specification algorithm continuously fetching message implemented client taking account language construct nats subscription consume create single subscription handle response pull request subject subscription created reply consumermsgnext request max message max byte user able set either maxmessages maxbytes value provided default value maxmessages maxbytes set maxmessages set user value set maxmessages maxbytes set maxbytes set user value set maxbytes maxmessages set large value internally user cannot set constraint single consume execution constraint custom threshold set containing number messagesbytes processed trigger next pull request value threshold cannot higher corresponding constraint value pull request batch maxbytes value calculated pull request fill buffer buffering message consume prebuffer message limit set maxmessages maxbytes whichever provided client track total amount message pending buffer whenever threshold reached new request consumermsgnext published track specific pull request long aggregate message byte count maintained consume able fill buffer appropriately pending message byte count updated new pull request published add value requestbatchsize pending message count value requestmaxbytes pending byte count new user message processed subtract pending message count subtract message size pending byte count pull request termination received containing natspendingmessages natspendingbytes header subtract value natspendingmessages header pending message count subtract value natspendingbytes pending byte count client could check header future proof request timeout message size exceeds maxbytes batchcompleted message size calculation message size byte calculated server size consists data payload header subject reply subject consumergo calculate payload size calculated client side include transport subject since generally known client lenpmsgsubj lenackreply lenpmsghdr lenpmsgmsg handling addition providing termination natspendingmessages natspendingbytes header message indicate termination pull error telegraphed user language specific way telegraphing warning optional error bad request consumer deleted consumer push based warning exceeded maxrequestbatch exceeded maxrequestexpires exceeded maxrequestmaxbytes exceeded maxwaiting telegraphed message request timeout message size exceeds maxbytes call next fetch concluded pull terminated hand consume recover maintaing state pending count issuing new pull request unless consumer deleted consumer push based case consume call conclude implementation specific way idiomatic language idle heartbeat consume always utilize idle heartbeat heartbeat value calculated follows warning triggered timer reach request idleheartbeat value timer reset received message either user message message heartbeat message heartbeat timer reset paused event client disconnect resumed reconnect heartbeat error terminal rather telegraphed user language idiomatic way server reconnects client detect server disconnect reconnect disconnect event received client reset heartbeat timer pause heartbeat timer reconnect event received client resume heartbeat timer check consumer exists fetch consumer info consumer available terminate consume execution error operation may retried several time jetstream may immediately available publish new pull request message processing algorithm algorithm receiving processing message take account server reconnects heartbeat check process handling described previous section verify whether new pull request sent pending message count reach threshold pending byte count reach threshold yes publish new pull request add request batch maxbytes pending message byte counter check new message available yes reset heartbeat timer verify type message message heartbeat message message user message handle return execute callback subtract message pending message count message size pending byte count message error verify error type message contains natspendingmessages natspendingbytes header verify error terminal based handling issue warningerror required conclude call necessary read value natspendingmessages natspendingbytes header subtract value pending message count pending byte count respectively info optional operation return consumer info note depending consumer exported across account api retrieve info consumer may available client may optionally expose way retrieved cached info consumer instance bypassing consumerinfo request server delete optional operation allows deleting consumer note depending consumer exported across account api delete consumer may available consequence new jetstream simplified consumer api separate legacy functionality legacy functionality deprecated