adr protobufbased intermodule communication changelog initial draft proposed abstract adr introduces system permissioned intermodule communication leveraging protobuf query msg service definition defined adr adr provides stable protobuf based module interface potentially later replace keeper paradigm stronger intermodule object capability ocaps guarantee module account subaccount authorization current cosmos sdk documentation objectcapability model stated assume thriving ecosystem cosmos sdk module easy compose blockchain application contain faulty malicious module currently thriving ecosystem cosmos sdk module hypothesize part due lack stable cosmos sdk build module module interface changing sometimes dramatically point release point release often good reason create stable foundation build lack properly implemented object capability even objectoriented encapsulation system make refactors module keeper interface inevitable current interface poorly constrained xbank case study currently xbank keeper give pretty much unrestricted access module reference instance setbalance method allows caller set balance account anything bypassing even proper tracking supply appears later attempt implement semblance ocaps modulelevel minting staking burning permission permission allow module mint burn delegate token reference module account permission actually stored string array moduleaccount type state however permission dont really much control module referenced mintcoins burncoins delegatecoins method one unique object capability token control access simple string xupgrade module could mint token xstaking module simple calling mintcoinsstaking furthermore module access keeper method also access setbalance negating attempt ocaps breaking even basic objectoriented encapsulation based adr adr introduce intermodule communication framework secure module authorization ocaps implemented could also serve existing paradigm passing keeper module approach outlined herein intended form basis cosmos sdk provides necessary stability encapsulation guarantee allow thriving module ecosystem emerge particular note enable functionality module adopt discretion proposal migrate existing module new paradigm separate conversation potentially addressed amendment adr new keeper paradigm adr mechanism protobuf service definition define querier introduced adr mechanism protobuf service define msg added protobuf service definition generate two golang interface representing client server side service plus helper code minimal example bank cosmosbankmsgsend message type package bank type msgclient interface sendcontextcontext msgsend opts grpccalloption msgsendresponse error type msgserver interface sendcontextcontext msgsend msgsendresponse error adr adr specifies module implement generated queryserver msgserver interface replacement legacy querier msg handler respectively adr explain module make query send msg module generated queryclient msgclient interface propose mechanism replacement existing keeper paradigm clear adr necessitate creation new protobuf definition service rather leverage proto based service interface already client intermodule communication queryclientmsgclient approach following key benefit exposing keeper external module protobuf type checked breaking change buf way protobuf designed give strong backwards compatibility guarantee allowing forward evolution separation client server interface allow insert permission checking code two check one module authorized send specified msg module providing proper object capability system see router intermodule communication give convenient place handle rollback transaction enabling atomicy operation currently problem failure within moduletomodule call would result failure entire transaction mechanism added benefit reducing boilerplate code generation allowing module language either via like cosmwasm subprocesses grpc intermodule communication client generated protobuf compiler grpcclientconn interface implementation introduce new type modulekey implement grpcclientconn interface modulekey thought private key corresponding module account authentication provided special invoker function described detail blockchain user external client account private key sign transaction containing msg listed signer message specifies required signer msggetsigner authentication check performed antehandler extend process allowing module identified msggetsigners module want trigger execution msg another module modulekey act sender clientconn interface describe set sole signer worth note dont cryptographic signature case example module could amodulekey create msgsend object cosmosbankmsgsend transaction msgsend validation assure account amodulekey case signer here example hypothetical module foo interacting xbank package foo type foomsgserver bankquery bankqueryclient bankmsg bankmsgclient func newfoomsgservermodulekey rootmodulekey foomsgserver return foomsgserver modoulekey modulekey bankquery banknewqueryclientmodulekey bankmsg banknewmsgclientmodulekey func foo foomsgserver barctx contextcontext req msgbarrequest msgbarresponse error balance err foobankquerybalancebankquerybalancerequestaddress foomsgservermodulekeyaddress denom foo err foobankmsgsendctx bankmsgsendrequestfromaddress foomsgservermodulekeyaddress design also intended extensible cover case fine grained permissioning like minting denom prefix restricted certain module discussed modulekeys moduleids modulekey thought private key module account moduleid thought corresponding public key adr module root module account number subaccounts derived account different pool staking pool managed account group account also think module subaccounts similar derived key root key derivation path moduleid simple struct contains module name optional derivation path form address based addresshash method adr type moduleid struct modulename string path byte func key moduleid address byte return addresshashkeymodulename keypath addition able generate moduleid address modulekey contains special function called invoker key safe intermodule access invoker creates invokefn closure invoke method grpcclientconn interface hood able route message appropriate msg query handler performing appropriate security check msg allows even safer intermodule access keeper whose private member variable could manipulated reflection golang support reflection function closure captured variable direct manipulation memory would needed truly malicious module bypass modulekey security two modulekey type rootmodulekey derivedmodulekey type invoker funccallinfo callinfo funcctx contextcontext request response interface opts interface error type callinfo method string caller moduleid type rootmodulekey struct modulename string invoker invoker func rootmodulekey derivepath byte derivedmodulekey type derivedmodulekey struct modulename string path byte invoker invoker module get access derivedmodulekey derivepath byte method rootmodulekey would key authenticate msg subaccount package foo func foomsgserver msgserver barctx contextcontext req msgbar msgbarresponse error derivedkey foomsgservermodulekeyderivereqsomepath bankmsgclient banknewmsgclientderivedkey err bankmsgclientbalancectx bankmsgsendfromaddress derivedkeyaddress way module gain permissioned access root account number subaccounts send authenticated msg account invoker callinfocaller parameter hood distinguish different module account either way function returned invoker allows msg either root derived module account pas note invoker return function closure based callinfo passed allow client implementation future cache invoke function method type avoiding overhead hash table lookup would reduce performance overhead intermodule communication method bare minimum required checking permission reiterate closure allows access authorized call access anything else regardless name impersonation rough sketch implementation grpcclientconninvoke rootmodulekey func key rootmodulekey invokectx contextcontext method string args reply interface opts grpccalloption error keyinvokercallinfo method method caller moduleid modulename keymodulename return fctx args reply appmodule wiring requirement adr appmoduleregisterserviceconfigurator method introduced support intermodule communication extend configurator interface pas modulekey allow module specify dependency module requireserver type configurator interface msgserver grpcserver queryserver grpcserver modulekey modulekey requireservermsgserver interface modulekey passed module registerservice method registerservices serf single entry point configuring module service intended also sideeffect greatly reducing boilerplate appgo modulekeys created based appmodulename flexible system may introduced future modulemanager handle creation module account behind scene module get direct access anymore module may unfulfilled dependency make sure module dependency resolved startup configuratorrequireserver method added modulemanager make sure dependency declared requireserver resolved app start example module foo could declare dependency xbank like package foo func appmodule registerservicescfg configurator cfgrequireserverbankqueryservernil cfgrequireserverbankmsgservernil security consideration addition checking modulekey permission additional security precaution taken underlying router infrastructure recursion reentry recursive reentrant method invocation pose potential security threat problem module call module module call module call one basic way router system deal maintain call stack prevents module referenced call stack reentry mapstringinterface table router could perform security check query query cosmos sdk generally unpermissioned allowing one module query another module pose major security threat assuming basic precaution taken basic precaution router system take making sure sdkcontext passed query method allow writing store done cachemultistore currently done baseapp query internal method many case may wish module call method module exposed client purpose add internalserver method configurator type configurator interface msgserver grpcserver queryserver grpcserver internalserver grpcserver example xslashings slash must call xstakings slash dont want expose xstakings slash end user client internal protobuf service defined corresponding internalproto file given module proto package service registered internalserver callable module external client solution internalonly method could involve hook plugins discussed detailed evaluation hook plugin system addressed later followup adr separate adr authorization default intermodule router requires message sent first signer returned getsigners intermodule router also accept authorization middleware provided adr middleware allow account otherwise specific module account perform action behalf authorization middleware take account grant certain module effectively admin privilege module addressed separate adrs update adr future work future improvement may include custom code generation simplifies interface generates code sdkcontext instead contextcontext optimizes intermodule call instance caching resolved method first invocation combining storekeys modulekeys single interface module single ocaps handle code generation make intermodule communication performant decoupling modulekey creation appmodulename apps override root module account name intermodule hook plugins msgservices xcapability xcapability module provide proper objectcapability implementation module cosmos sdk could even intermodule ocaps described advantage approach described adr mostly around integrates part cosmos sdk specifically protobuf code generation interface leveraged better dev module interface versioned checked breakage buf submodule account per adr general msg passing paradigm way signer specified getsigners also complete replacement keeper could applied intermodule communication whereas xcapability approach would applied method method consequence backwards compatibility adr intended provide pathway scenario greater long term compatibility module shortterm likely result breaking certain keeper interface permissive andor replacing keeper interface altogether positive keeper easily lead stable intermodule interface proper intermodule ocaps improved module developer devx commented several particpants architecture review call dec lay groundwork greatly simplified appgo router setup enforce atomic transaction moduletomodule call negative module adopt significant refactoring neutral test case optional reference adr adr adr adr draft objectcapability model