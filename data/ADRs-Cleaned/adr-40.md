nats connection metadatavalue author jarema implemented tag client server spec revisiondateauthorinfo jarema initial draft summary document describes client connect nats server nats cluster includes topic like connection process reconnect discoverability node cluster motivation ensuring consistent way client establish maintain connection nats server provide consistent predictable behaviour across ecosystem guidelevel explanation establishing connection todo add websocket flow minimal example client initiate network connection server server responds info json client sends connect json client server start exchange pingpong message detect connection alive note client set protocol field connect equal greater server send subsequent info ongoing connection client handle appropriately update server list server info auth flow todo two flow available server enable standard nats explicit method available nats server version client initiate network connection server server responds info json server info contains tlsrequired set true client requirement set true client performs upgrade client sends connect json client server start exchange pingpong message detect connection alive first implicit method available since nats server two prerequisite method server config enabled handshakefirst field block client set tlsfirst set true handshakefirst possible value false handshake first disabled default value true handshake first enabled enforced client flow fail connect duration hybrid mode wait given time allowing client follow tlsfirst flow duration expired info sent enabling standard client flow auto default value default wait upgrade sending info flow flipped established server sends info client initiate network connection server client upgrade connection server sends info json client sends connect json client server start exchange pingpong message detect connection alive server discovery note server send back info server sends back info may contain additional url client make connection attempt client store url reconnection strategy client turn advertised url default url todo add indepth explanation topology discovery work reconnection strategy progress ondemand reconnect client way allows user force reconnection process useful refreshing auth rebalancing client triggered client drop connection current server perform standard reconnection process mean subscription consumer resubscribed work resumed successful reconnect reconnect respected client mean reconnect method clientconnection handle detecting disconnection two method client detect disconnection missing two consecutive pong server number missing pong configured handling error network connection reconnect process client detects disconnection start reconnect attempt following rule immediate reconnect attempt client attempt reconnect immediately finding disconnected exponential backoff jitter first reconnect fails backoff process kick default jitter also included avoid thundering herd problem server returned additional url client try reconnecting random order server list unless randomization disabled client successful reconnect reset timer upon reconnection client resubscribe created subscription change connection state connecteddisconnected client way notifying user callback function idiomatic mechanism given language reporting asynchronous event disconnect buffer client buffer aggregate message client side case disconnection fill buffer send pending message soon connection restored buffer filled connection restored publish attempt return error noting fact referencelevel explanation client although client provide sensible default handling connection many case requires tweaking list defines changed mean default ping interval default minute client server might know connection severed nats pingpong protocol client set interval send ping server expecting pong two consecutive pong missed connection marked lost triggering reconnect attempt worth noting shorter ping interval improve responsiveness client network issue also increase load whole nats system network added client max ping default set number allowed outstanding pong response client ping marking client disconnected triggering reconnect retry failed initial connect default false default client make connection attempt fails connect return error many scenario user might want allow first attempt fail long client continue effort notify progress enabled client start initial connection process return standard nats connectionclient handle background connection attempt continued client wait first connection succeed fail network scenario take much time first attempt fails standard reconnect process performed max reconnects default none specifies number consecutive reconnect attempt client make giving useful preventing zombie service endlessly reaching server also footgun surprise user expect client give entirely connection timeout default specifies long client wait network connection established language hang eternally timeout mechanic might necessary others network connection method might way configure timeout custom reconnect delay default none finegrained control reconnect attempt interval needed allows user specify one implementation make sense given language example callback reconnectattempt int duration disconnect buffer given client support storing message disconnect period allows tweak number stored message also allow disable buffering entirely required default false set client enforces whether server also requires scheme connection string also enforces ignore advertised server default false connecting server may send back list server cluster aware helpful discoverability remove client pas server connect also may unwanted example server url unreachable given client retain server order default false default many server address passed connect string array client try connect random order help healthy connection distribution specific case list treated preference list randomization may turned function expressed enable retaining order disable randomization depending idiomatic given language protocol command grammar info linklink send server establishing depending flow contains information server nonce server url client connect connect connect send client response info contains information client including optional signature client version connection ping pong mechanism detect broken connection may reported network connection given language server sends ping client answer pong client sends ping server answer pong two configurable consecutive pong missed client treat connection broken start reconnect attempt default interval ping minute error handling todo server respond authorization error security consideration discus additional security consideration pertaining implementation connection handling future possibility smart reconnection could potential big improvement