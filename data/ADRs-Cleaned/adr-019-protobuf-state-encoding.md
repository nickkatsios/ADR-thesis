adr protocol buffer state encoding changelog feb initial draft feb update handle message interface field apr convert usage oneof interface may describe cosmosproto extension amino compatibility dec move rename marshalany unmarshalany codeccodec interface feb remove mention hybridcodec abandoned currently cosmos sdk utilizes goamino binary json object encoding wire bringing parity logical object persistence object amino doc amino object encoding specification subset proto extension interface support see proto spec information proto amino largely compatible proto goal amino encoding protocol bring parity logic object persistence object amino also aim following goal complete list binary byte must decodeable schema schema must upgradeable encoder decoder logic must reasonably simple however believe amino fulfill goal completely fully meet truly flexible crosslanguage multiclient compatible encoding protocol cosmos sdk namely amino proven big painpoint regard supporting object serialization across client written various language providing virtually little way true backwards compatibility upgradeability furthermore profiling various benchmark amino shown extremely large performance bottleneck cosmos sdk largely reflected performance simulation application transaction throughput thus adopt encoding protocol meet following criterion state serialization language agnostic platform agnostic rich client support thriving ecosystem high performance minimal encoded message size codegenbased reflectionbased support backward forward compatibility note migrating away amino viewed twopronged approach state client encoding adr focus state serialization cosmos sdk state machine corresponding adr made address clientside encoding adopt protocol buffer serializing persisted structured data cosmos sdk providing clean mechanism developer application wishing continue amino provide mechanism updating module accept codec interface marshaler instead concrete amino codec furthermore cosmos sdk provide two concrete implementation marshaler interface aminocodec protocodec aminocodec amino binary json encoding protocodec protobuf binary json encoding module whichever codec instantiated app default cosmos sdks simapp instantiates protocodec concrete implementation marshaler inside maketestencodingconfig function easily overwritten app developer desire ultimate goal replace amino json encoding protobuf encoding thus module accept andor extend protocodec amino json still provided legacy usecases handful place cosmos sdk still amino json hardcoded legacy api rest endpoint xparams store planned converted protobuf gradual manner module codecs module require ability work serialize interface path protobuf migration pretty straightforward module simply migrate existing type encoded persisted via concrete amino codec protobuf keeper accept marshaler protocodec migration simple thing work asis note business logic encode primitive type like bool int gogoprotobuf value type example err gogotypestimestampprotocompletiontime err nil cdcmustmarshalts however module vary greatly purpose design must support ability module able encode work interface account content module must define codec interface extends marshaler specific interface unique module contain method contract know serialize needed interface example xauthtypescodecgo type codec interface codeccodec marshalaccountacc exportedaccount byte error unmarshalaccountbz byte exportedaccount error marshalaccountjsonacc exportedaccount byte error unmarshalaccountjsonbz byte exportedaccount error usage encode interface general modulelevel proto file define message encode interface googleprotobufany extension discussion chosen preferred alternative applicationlevel oneofs original protobuf design argument favor summarized follows provides simpler consistent client dealing interface applevel oneofs coordinated carefully across application creating generic transaction signing library oneofs may cumbersome critical logic may reimplemented chain provides resistance human error oneof generally simpler implement module apps main counterargument center around additional space possibly performance overhead space overhead could dealt compression persistence layer future performance impact likely small thus seem premature optimization user experience higher order concern note given cosmos sdks adopt codec interface described apps still choose oneof encode state transaction recommended approach apps choose oneofs instead likely lose compatibility client apps support multiple chain thus developer think carefully whether care possibly premature optimization enduser client developer safe usage default gogo protobuf implementation global type registration decode value packed concrete type introduces vulnerability malicious module dependency tree could register type global protobuf registry cause loaded unmarshaled transaction referenced typeurl field prevent introduce type registration mechanism decoding value concrete type interfaceregistry interface bear similarity type registration amino type interfaceregistry interface registerinterface associate protoname public name interface passed iface registryregisterinterfacecosmossdkmsg sdkmsgnil registerinterfaceprotoname string iface interface registerimplementations register impls concrete implementation interface iface registryregisterimplementationssdkmsgnil msgsend msgmultisend registerimplementationsiface interface impls protomessage addition serving whitelist interfaceregistry also serve communicate list concrete type satisfy interface client proto file field accept interface annotated cosmosprotoacceptsinterface fullqualified name passed protoname interfaceregistryregisterinterface interface implementation annotated cosmosprotoimplementsinterface fullqualified name passed protoname interfaceregistryregisterinterface future protoname cosmosprotoacceptsinterface cosmosprotoimplementsinterface may via code generation reflection static linting struct implement interfaceregistry also implement interface interfaceunpacker unpacking anys type interfaceunpacker interface unpackany unpacks value interface pointer passed iface note type must registered registerimplementations concrete type interface var msg sdkmsg err ctxunpackanyany msg unpackanyany iface interface error note interfaceregistry usage deviate standard protobuf usage introduces security introspection layer golang usage interfaceregistry member protocodec described order module register interface type app module optionally implement following interface type interfacemodule interface registerinterfacetypesinterfaceregistry module manager include method call registerinterfacetypes every module implement order populate interfaceregistry encode state cosmos sdk provide support method marshalinterface unmarshalinterface hide complexity wrapping interface type allow easy serialization import githubcomcosmoscosmossdkcodec note eviexportedevidence interface type func marshalevidencecdc codecbinarycodec eviexportedevidence byte error return cdcmarshalinterfacee func unmarshalevidencecdc codecbinarycodec byte eviexportedevidence error var evi eviexportedevidence err cdcunmarshalinterfaceevi return err nil sdkmsgs similar concept applied message contain interface field example define msgsubmitevidence follows evidence interface protobuf xevidencetypestypesproto message msgsubmitevidence byte submitter gogoprotocasttype githubcomcosmoscosmossdktypesaccaddress googleprotobufany evidence note order unpack evidence reference interfaceregistry order reference evidence method like validatebasic shouldnt know interfaceregistry introduce unpackinterfaces phase deserialization unpacks interface theyre needed unpacking interface implement unpackinterfaces phase deserialization unpacks interface wrapped theyre needed create interface sdkmsgs type implement type unpackinterfacesmessage interface unpackinterfacesinterfaceunpacker error also introduce private cachedvalue interface field onto struct public getter getcachedvalue interface unpackinterfaces method invoked message deserialization right unmarshal interface value packed anys decoded stored cachedvalue reference later unpacked interface value safely code afterwards without knowledge interfaceregistry message introduce simple getter cast cached value correct interface type added benefit unmarshaling value happens initial deserialization rather every time value read also value first packed instance call newmsgsubmitevidence original interface value cached unmarshaling isnt needed read msgsubmitevidence could implement unpackinterfaces plus convenience getter getevidence follows func msg msgsubmitevidence unpackinterfacesctx sdkinterfaceregistry error var evi eviexportedevidence return ctxunpackanymsgevidence evi func msg msgsubmitevidence getevidence eviexportedevidence return msgevidencegetcachedvalueeviexportedevidence amino compatibility custom implementation transparently amino proper codec instance mean interface packed within anys amino marshaled like regular amino interface assuming registered properly amino order functionality work legacy code must codeclegacyamino instead aminocodec wrapper properly handle new code marshaler compatible amino protobuf also codeclegacyamino renamed codeclegacyamino wasnt chosen instead complete comparison alternative protocol see capn proto capn proto seem like advantageous alternative protobuf due native support interfacesgenerics built canonicalization lack rich client ecosystem compared protobuf bit mature flatbuffers flatbuffers also potentially viable alternative primary difference flatbuffers parsingunpacking step secondary representation access data often coupled perobject memory allocation however would require great effort research full understanding scope migration path forward isnt immediately clear addition flatbuffers arent designed untrusted input future improvement roadmap future may consider compression layer right persistence layer doesnt change merkle tree hash reduces storage overhead addition may adopt protobuf naming convention make type url bit concise remaining descriptive additional code generation support around usage something could also explored future make developer seamless consequence positive significant performance gain support backward forward type compatibility better support crosslanguage client negative learning curve required understand implement protobuf message slightly larger message size due although could offset compression layer future neutral reference httpsgithubcomcosmoscosmossdkissues httpsgithubcomcosmoscosmossdkissues