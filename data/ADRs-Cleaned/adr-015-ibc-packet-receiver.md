adr ibc packet receiver changelog oct initial draft routing module defines function handlepacketrecv routing module defined layer application module verifies route message destination module possible implement separate module however already functionality route message upon destination identifier baseapp adr suggests utilize existing baseapprouter route packet application module generally routing module callback two separate step verification execution corresponds antehandlerhandler model inside sdk verification inside antehandler order increase developer ergonomics reducing boilerplate verification code atomic multimessage transaction want keep ibc related state modification preserved even application side state change reverts one example might ibc token sending message following stake delegation token received previous packet message token receiving fails reason might want keep executing transaction also dont want abort transaction sequence commitment reverted channel stuck adr suggests new codetype codetxbreak fix problem portkeeper capability key able access channel bound port entity hold portkeeper able call method corresponding method name channelkeeper allowed port channelkeeperportstring channelchecker defined easily construct capabilitysafe portkeeper addressed another adr insecure channelkeeper baseapprunmsgs break loop message one handler return resultisok however outer logic write cached store resultisok resultcodeisbreak resultcodeisbreak resultcode codetxbreak func app baseapp runtxtx result result msg txgetmsgs antehandler appantehandler nil antectx mscache appcachetxcontextctx newctx err appantehandlerantectx newctxiszero ctx newctxwithmultistorems err nil error handling logic return mscachewrite main handler runmsgctx mscache appcachetxcontextctx result apprunmsgsrunmsgctx msg begin modification made adr resultisok resultisbreak end mscachewrite return result cosmos sdk define antedecorator ibc packet receiving antedecorator iterate message included transaction type switch check whether message contains incoming ibc packet verify merkle proof type proofverificationdecorator struct clientkeeper clientkeeper channelkeeper channelkeeper func pvr proofverificationdecorator antehandlectx simulate bool next antehandler error msg range txgetmsgs var err error switch msg msgtype case clientmsgupdateclient err pvrclientkeeperupdateclientmsgclientid msgheader case channelmsgpacket err pvrchannelkeeperrecvpacketmsgpacket msgproofs msgproofheight case chanelmsgacknowledgement err pvrchannelkeeperacknowledgementpacketmsgacknowledgement msgproof msgproofheight case channelmsgtimeoutpacket err pvrchannelkeepertimeoutpacketmsgpacket msgproof msgproofheight msgnextsequencerecv case channelmsgchannelopeninit err pvrchannelkeepercheckopenmsgportid msgchannelid msgchannel default continue err nil return ctx err return nextctx simulate msgupdateclient msgpacket msgacknowledgement msgtimeoutpacket sdkmsg type correspond handleupdateclient handlerecvpacket handleacknowledgementpacket handletimeoutpacket routing module respectively side effect recvpacket verifyacknowledgement verifytimeout extracted separated function writeacknowledgement deletecommitment deletecommitmenttimeout respectively called application handler execution writeacknowledgement writes acknowledgement state verified counterparty chain increment sequence prevent double execution deletecommitment delete commitment stored deletecommitmenttimeout delete commitment close channel case ordered channel func keeper channelkeeper writeacknowledgementctx packet packet ack byte keepersetpacketacknowledgementctx packetgetdestport packetgetdestchannel packetgetsequence ack keepersetnextsequencerecvctx packetgetdestport packetgetdestchannel packetgetsequence func keeper channelkeeper deletecommitmentctx packet packet keeperdeletepacketcommitmentctx packetgetsourceport packetgetsourcechannel packetgetsequence func keeper channelkeeper deletecommitmenttimeoutctx packet packet kdeletepacketcommitmentctx packetgetsourceport packetgetsourcechannel packetgetsequence channelordering typesordered channelstate typesclosed ksetchannelctx packetgetsourceport packetgetsourcechannel channel application handler call respective finalization method portkeeper order increase sequence case packet remove commitment case acknowledgement timeout calling function implies application logic successfully executed however handler return result codetxbreak calling method persist state change already done prevent message executed case semantically invalid packet keep sequence increased previous ibc packetsthus preventing double execution without proceeding following message case application module never return state reverting result make channel unable proceed channelkeepercheckopen method introduced replace onchanopen defined routing module specification instead define channel handshake callback function application module provide channelchecker function appmodule injected channelkeeperport top level application checkopen find correct chennelchecker portid call return error unacceptable application proofverificationdecorator inserted top level application safe make module responsible call proof verification logic whereas application misbehavein term ibc protocol mistake proofverificationdecorator come right default sybil attack resistent layer current authnewantehandler add ibc proofverificationdecorator chain func newantehandler keeperaccountkeeper supplykeeper typessupplykeeper ibckeeper ibckeeper siggasconsumer signatureverificationgasconsumer sdkantehandler return sdkchainantedecorators newsetupcontextdecorator outermost antedecorator setupcontext must called first newincrementsequencedecoratorak ibcanteproofverificationdecoratoribckeeperclientkeeper ibckeeperchannelkeeper innermost antedecorator implementation adr also create data field packet type byte deserialised receiving module private type application module according interpretation ibc keeper crucial dynamic ibc example applicationside usage type appmodule struct checkchannel provided channelkeeper channelkeeperportmodulecheckchannel func module appmodule checkchannelportid channelid string channel channel error channelordering unordered return erruncompatibleordering channelcounterpartyport bank return erruncompatibleport channelversion return erruncompatibleversion return nil func newhandlerk keeper handler return funcctx msg msg result switch msg msgtype case msgtransfer return handlemsgtransferctx msg case ibcmsgpacket var data packetdatatransfer err typesmodulecodecunmarshalbinarybaremsggetdata data err nil return err return handlepacketdatatransferctx msg data case ibcmsgtimeoutpacket var data packetdatatransfer err typesmodulecodecunmarshalbinarybaremsggetdata data err nil return err return handletimeoutpacketdatatransferctx packet interface portid string channelid string channel ibcchannel msgchaninit msgchantry implement ibcmsgchannelopen case ibcmsgchannelopen return handlemsgchannelopenctx msg func handlemsgtransferctx keeper msg msgtransfer result err ksendtransferctxmsgportid msgchannelid msgamount msgsender msgreceiver err nil return sdkresultfromerrorerr return sdkresult func handlepacketdatatransferctx keeper packet packet data packetdatatransfer result err kreceivetransferctx packetgetsourceport packetgetsourcechannel packetgetdestinationport packetgetdestinationchannel data err nil todo source chain sent invalid packet shutdown channel kchannelkeeperwriteacknowledgementbytex writeacknowledgement increase sequence preventing double spending return sdkresult func handlecustomtimeoutpacketctx keeper packet custompacket result err krecovertransferctx packetgetsourceport packetgetsourcechannel packetgetdestinationport packetgetdestinationchannel data err nil chain sent invalid packet cannot recover fund panicerr kchannelkeeperdeletecommitmenttimeoutctx packet packet timeout fail return sdkresult func handlemsgchannelopensdkcontext keeper msg msgopenchannel result kallocateescrowaddressctx msgchannelid return sdkresult proposed consequence positive intuitive interface developer ibc handler care ibc authentication state change commitment logic embedded baseappruntx logic negative cannot support dynamic port routing tied baseapp router neutral introduces new antehandler decorator dynamic port supported hierarchical port identifier see detail reference relevant comment cosmosics routing module