pull subscribe internals metadata value author wallyqs partially implemented tag jetstream client motivation one form message delivery jetstream pull based consumer adr described current state implementing consumption message type consumer pull based consumer type consumer delivery subject server know send message instead client request message delivered needed server example given stream bar consumer durable name dur pull subscriber durable pull request would look like term protocol shell pub jsapiconsumermsgnextbardur inboxxtkdpdlcoeknrfbrhvubzed request body possible field presented json body request body presented example default assumed batch number message server send minimum limit batch size level library account server may limit nowait boolean value indicating make pull request wait type see detail default false expires number nanosecond pull expire supplied mean expiration applied wait take precedence expires supplied pulln request request empty payload identical pull batch size result server sending next available message example shell sub inboxexample pub jsapiconsumermsgnextbardur inboxexample msg bar jsackbardur helo note even though inbox request inboxexample message got delivered subject rewritten bar subject message persisted jetstream pull request next message linger interest subject client disconnected batch size filled pull request increase numawaiting counter consumer inflight pull request consumer inflight pull request though changed creating consumer maxwaiting shell pub jsapiconsumerinfobardur inboxumfjlecclhcsclfwfrsjdszxco msg inboxumfjlecclhcsclfwfrsjdszxco type ionatsjetstreamapivconsumerinforesponse streamname bar name dur created config durablename dur deliverpolicy ackpolicy explicit ackwait maxdeliver filtersubject bar replaypolicy instant maxwaiting maximum inflight pullfetch request maxackpending delivered consumerseq streamseq ackfloor consumerseq streamseq numackpending numredelivered numwaiting inflight pullfetch request numpending cluster leader ncuouhyicresecktxesmgaznktelxpuiejcrtlifuwebz making pull request also possible request one message shell pub jsapiconsumermsgnextbardur inboxxtkdpdlcoeknrfbrhvogym batchexpires whenever pull request time count numwaiting increase consumer eventually reset reach max waiting inflight configured pull consumer wait pull request order get response server rigth away client make pull request nowait enabled example shell pub jsapiconsumermsgnextbardur inboxxtkdpdlcoeknrfbrhvogym batchnowaittrue result wait pull request guaranteed instant response server either next message error error could server error case service available commonly result wait pull request message error shell hmsg inboxxtkdpdlcoeknrfbrhvogym nats message design implementation pull subscribe combination wait lingering pull request described previously client simple example api look follows sub err jspullsubscribestreamname durable err nil logfatalerr msg err subfetch err nil logprintlnerror err continue msg range msg msgack implementing pullsubscribe two main case consider pulln pull pulln pulln batch request implemented somewhat similarly old style request making pull request first wait request done try get message may already available needed message message error jetstream server long pull request made shell sub inboxnquaixdgoozkotfectig pub jsapiconsumermsgnextbardur inboxwvajlnixcjzfsrxlhmts batchnowaittrue result wait request message hmsg inboxwvajlnixcjzfsrxlhmts nats message next pull request long pull request client side timeout pub jsapiconsumermsgnextbardur inboxnquaixdgoozkotfectig expiresbatch part request payload batch field set number expected message expires set cancel request client side timeout example timeout payload expires result represented nanosecond making first request wait request also recommended send auto unsubscribe protocol discounting message already received result wait request case batch request message client would auto unsubscribe receiving since first message error unsub batch account initial error message shell unsub successful result batch request least one message delivered client case message delivered client time away pull request recommended unsubscribe remove interest awaited message server otherwise risk server sending message inbox connected client longer expecting message shell sub inboxwvajlnixcjzfsrxlhmts pub jsapiconsumermsgnextbardur inboxwvajlnixcjzfsrxlhmts batchnowaittrue hmsg inboxwvajlnixcjzfsrxlhmts nats message unsub pub jsapiconsumermsgnextbardur inboxwvajlnixcjzfsrxlhmts expiresbatch msg hello jsackbardur helo message receives client away unsubscribes unsub error message handling receiving message point client may instead receive error server message msg hello jsackbardur hello system reached many inflight pull request condition hmsg inboxwvajlnixcjzfsrxlhmri nats request timeout whenever message recommended error returned user processable message instead handle error condition msg err subfetch err nil error client timeout request timeout bad request responder system unavailable current quorum logprintlnerror err continue msg never error message case error loop break msg range msg msgack pull optimization case pulling single message possible optimize thing making first pull request wait request instead preparing new style like requestresponse handler wildcard subscription result chatty protocol also work better topology jetstream running leafnode edge shell sub inboxmiojjnkoghobmcgcwkjz pub jsapiconsumermsgnextbardur inboxmiojjnkoghobmcgcwkjzasdf batchnowaittrue similar pulln first wait request fails first pull longer old style request made unique inbox note pull subscriber must pull requestresponse handler default implementation new style request cannot purpose due subject get rewritten would cause response dropped