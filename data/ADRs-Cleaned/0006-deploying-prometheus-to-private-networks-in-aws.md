model deploying prometheus private network aws draft looking offer prometheus nonpaas team infrastructure monitored run another team called client team document provide one prometheus server responsible gathering metric underlying infrastructure longer term aiming provide prometheus service multiple environment across multiple programme nonsuitability existing infrastructure existing prometheus infrastructure paas team work service broker generate filesdconfigs prometheus scrape paas apps public internet approach wont work nonpaas team based assumption every app directly routable public internet doesnt hold nonpaas environment instead apps live private network public access controlled firewall load balancer main problem solved scraping apps private network previous section explained main problem want prometheus provided able scrape apps endpoint owned client team living private network want way doesnt require client unnecessarily expose metric endpoint public internet thing would like able maintain prometheus single common version upgrading prometheus across whole estate update prometheus configuration without restart prometheus allow client team provide configuration example alert rule perform service discovery querying api permission read client account resource several way might provide prometheus pattern allows scrape private endpoint provide artefact deployed client team client team provides iam access deploy prometheus within vpc build infrastructure vpc peering access client team private network build infrastructure vpc endpoint service way get prometheus access client team private network provide artefact deployed client team artefact provide could take several form ami amazon machine image client team deploys instance terraform module client team includes terraform project model downside doesnt allow maintain prometheus single common version mercy client team deploy cadence ensure thing get upgraded client team provides iam access deploy prometheus model client team would create iam role allow assume build prometheus infrastructure within vpc would mean client team work provide correct iam policy without giving capability feel comfortable client team would visibility built would able see aws console however would likely ssh access instance one possible issue model beholden client provide cidr range deploy onto depending existing estate private may short supply youre also dependent networking arrangement ask question like get network download package install work download security update work answer question may different different client team mean prometheus pattern flexible enough cope difference take extra engineering effort would work integration point team would could terraform output appear remote state file stereotyped resource namestags matched data source whether deploying prometheus want service discovery described prometheus sort iam access client team account anyway vpc peering provide access prometheus scrape target infrastructure vpc peering feature allows establish networking connection two vpcs particular peering arrangement mean two network either side vpc peering arrangement cannot share address range crucially vpcs different aws account mean could build prometheus account could access client team infrastructure peering connection running infrastructure account without dependent client team providing anything would make smoother operation deployment drawback client add extra point ingres egress traffic client network increase attack surface network make security audit harder make harder confidence security system there also drawback term combination connection build service might provided client team extend service client team end vpc peering connection maintain techops broadly provides service client team end consider vpc peering connection security analysis doesnt feel like particularly scalable way offer service client team finally believe vpc peering something manually receiving account console least peering across aws account compound scaling problem two sub case worth exploring single prometheus vpc peer multiple client vpcs model would build single prometheus service vpc owned would vpc peering arrangement multiple client team vpcs order scrape metric benefit run fewer instance scrape metric number environment drawback single vpc becomes privileged access environment mean compromise prometheus vpc could lead compromise client vpcs single prometheus vpc peer single client vpc scenario would build single prometheus vpc client team vpc offer service avoids drawback previous case prometheus doesnt privilege access multiple separate vpcs vpc endpoint service access scrape target similar idea vpc peering vpc endpoint service aka aws privatelink provides way provide service vpc potentially another account allows make single network load balancer nlb appear directly available without going nat gateway another vpc case prometheus pull model seems likely way could make work would client team provide endpoint service prometheus consume would mean client team would add routing layer possibly path vhostbased routing possibly alb distribute scrape request individual scrape target following advantage address space prometheus vpc client team vpc completely independent however drawback feel like endpoint service designed case word feel like bit hack prometheus designed close target fewer thing wrong prevent scraping layer routing prometheus scrape target chance well lose metric outage exactly deploy prometheus verify performance environment test concept deploy instance prometheus client team vpc ubuntu distribution instance adr cloud init configure prometheus adr verify infrastructure initially poc adradr consequence havent yet solved problem client team provide alert configuration prometheus moment acceptable define configuration cloudinit meet update configuration without rebuilding instance revise future