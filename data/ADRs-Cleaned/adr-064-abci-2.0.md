adr abci integration phase changelog initial draft alexanderbez add upgrading section alexanderbez simplify vote extension state persistence alexanderbez revise vote extension state persistence alexanderbez revise vote extension power calculation staking interface davidterpay abstract adr outline continuation effort implement abci cosmos sdk outlined adr abci phase specifically adr outline design implementation abci includes extendvote verifyvoteextension finalizeblock abci continues promised update abci specifically three additional abci method application implement order gain control insight customization consensus process unlocking many novel usecases previously possible describe three new method extendvote method allows validator process extend precommit phase cometbft consensus process specifically allows application perform custom business logic extends precommit vote supply additional data part vote although signed separately key data called vote extension broadcast received together vote extending made available application next height specifically proposer next block receive vote extension requestprepareproposallocallastcommitvotes application vote extension information provide return length byte array vote extension note although validator process submits vote extension proposer next block receive vote extension included part precommit phase previous block mean proposer implicitly access vote extension via requestprepareproposal vote extension may included since validator wait precommits precommit vote signed independently vote extension verifyvoteextension method allows validators validate vote extension data attached precommit message receives validation fails whole precommit message deemed invalid ignored cometbft cometbft verifyvoteextension validating precommit vote specifically precommit cometbft reject message doesnt contain signed vote signed vote extension reject message vote signature vote extension signature fails verify reject message verifyvoteextension rejected app otherwise cometbft accept precommit message note important consequence liveness vote extension repeatedly cannot verified correct validators cometbft may able finalize block even sufficiently many validators send precommit vote block thus verifyvoteextension special care cometbft recommends application detects invalid vote extension accept responseverifyvoteextension ignore logic finalizeblock method delivers decided block application application must execute transaction block deterministically update state accordingly cryptographic commitment block transaction result returned via corresponding parameter responsefinalizeblock included header next block cometbft call new block decided word finalizeblock encapsulates current abci execution flow beginblock one delivertx endblock single abci method cometbft longer execute request legacy method instead simply call finalizeblock discus change cosmos sdk implement abci two distinct phase voteextensions finalizeblock voteextensions similarly prepareproposal processproposal propose introduce two new handler application implement order provide verify vote extension propose following new handler application implement type extendvotehandler funcsdkcontext abciextendvoterequest abciextendvoteresponse type verifyvoteextensionhandler funcsdkcontext abcirequestverifyvoteextension abciresponseverifyvoteextension ephemeral state supplied handler contain relevant metadata block height block hash state cached version committed state application discarded execution handler mean handler get fresh state view change made written application decides implement extendvotehandler must return nonnil responseextendvotevoteextension recall implementation extendvotehandler deterministic however given set vote extension verifyvoteextensionhandler must deterministic otherwise chain may suffer liveness fault addition recall cometbft proceeds round height cannot made block proposal given height cometbft proceed next round thus execute extendvote verifyvoteextension new round validator valid precommits obtained given broad scope potential implementation usecases vote extension verify application choose implement handler single handler type number dependency injected keeper addition handler type could contain notion volatile vote extension state management would assist vote extension verification state management could ephemeral could form ondisk persistence example voteextensionhandler implement oracle vote extension handler type voteextensionhandler struct cdc codec mykeeper state voteextstate could map connection object extendvotehandler something hmk possibly hstate create vote extension fetching series price supported asset func voteextensionhandler extendvotehandlerctx sdkcontext req abciextendvoterequest abciextendvoteresponse price getpricesctx hmkassets err encodepriceshcdc price err nil panicfmterrorffailed encode price vote extension err store vote extension given height note vote extension overridden since timeout round setpriceshstate req return abciextendvoteresponsevoteextension verifyvoteextensionhandler something hstate req verify reqvoteextension field ensuring provided oracle price within valid range price func voteextensionhandler verifyvoteextensionhandlerctx sdkcontext req abcirequestverifyvoteextension abciresponseverifyvoteextension price err decodepriceshcdc reqvoteextension err nil logfailed decode vote extension err err return abciresponseverifyvoteextensionstatus reject err validatepriceshstate req price err nil logfailed validate vote extension price price err err return abciresponseverifyvoteextensionstatus reject store updated vote extension given height note vote extension overridden since timeout round setpriceshstate req reqvoteextension return abciresponseverifyvoteextensionstatus accept vote extension propagation verification mentioned previously vote extension height made available proposer height prepareproposal however order make vote extension useful validators access agreed upon vote extension height since cometbft includes vote extension signature requestprepareproposal propose proposing validator manually inject vote extension along respective signature via special transaction voteextstx block proposal prepareproposal voteextstx populated single extendedcommitinfo object received directly requestprepareproposal convention voteextstx transaction first transaction block proposal although chain implement preference safety purpose also propose proposer verify vote extension signature receives requestprepareproposal validator upon requestprocessproposal receive injected voteextstx includes vote extension along signature transaction exists validator must reject proposal validator inspects voteextstx evaluate signedvoteextension signed vote extension validator generate signed byte verify signature least valid signature based voting power must received order block proposal valid otherwise validator must reject proposal order ability validate signature baseapp must access xstaking module since module store index consensus address public key however avoid direct dependency xstaking instead rely interface instead addition cosmos sdk expose default signature verification method application type validatorstore interface getpubkeybyconsaddrcontextcontext sdkconsaddress cmtprotocryptopublickey error validatevoteextensions function application execute processproposal verify vote extension signature func app baseapp validatevoteextensionsctx sdkcontext currentheight int extcommit abciextendedcommitinfo error votingpower totalvotingpower vote range extcommitvotes totalvotingpower votevalidatorpower votesignedlastblock lenvotevoteextension continue valconsaddr sdkconsaddressvotevalidatoraddress pubkeyproto err valstoregetpubkeybyconsaddrctx valconsaddr err nil return fmterrorffailed get public key validator valconsaddr err lenvoteextensionsignature return fmterrorfreceived nonempty vote extension empty signature validator valconsaddr cmtpubkey err cryptoencpubkeyfromprotopubkeyproto err nil return fmterrorffailed convert validator public key valconsaddr err cve cmtprotocanonicalvoteextension extension votevoteextension height currentheight vote extension signed previous height round intextcommitround chainid appgetchainid extsignbytes err cosmosiomarshaldelimitedcve err nil return fmterrorffailed encode canonicalvoteextension err cmtpubkeyverifysignatureextsignbytes voteextensionsignature return errorsnewreceived vote invalid signature votingpower votevalidatorpower votingpower totalvotingpower threshold return errorsnewnot enough voting power vote extension return nil least signature voting power received verified validator vote extension derive additional data come based vote extension note important state neither vote propagation technique vote extension verification mechanism described required application implement word proposer required verify propagate vote extension along signature proposer required verify signature application implement pki mechanism sign verify vote extension vote extension persistence certain may useful necessary application persist data derived vote extension order facilitate case propose allow app developer define preblocker hook called beginning finalizeblock beginblock see note cannot allow application directly write application state processproposal replay cometbft call processproposal would result incomplete state view func myapp preblockerctx sdkcontext req abcirequestfinalizeblock error voteexts getvoteextensionsctx reqtxs process perform compute vote extension storing resulting state err aprocessvoteextensionsctx voteexts err nil return err finalizeblock existing abci method beginblock delivertx endblock existed since dawn abcibased application thus application tooling developer grown method usecases specifically beginblock endblock grown pretty integral powerful within abcibased application application might want run distribution inflation related operation prior executing transaction staking related change happen executing transaction propose keep beginblock endblock within sdks core module interface application developer continue build existing execution flow however remove beginblock delivertx endblock sdks baseapp implementation thus abci surface area exist single finalizeblock execution flow specifically finalizeblock execute application beginblock followed execution transaction finally followed execution application endblock note still keep existing transaction execution mechanic within baseapp notion delivertx removed deliverstate replace finalizestate committed commit however current parameter field exist existing beginblock endblock abci type vote distribution byzantine validators evidence handling parameter exist finalizeblock request type passed application implementation beginblock endblock mean cosmos sdks core module interface updated reflect parameter easiest straightforward way achieve pas requestfinalizeblock beginblock endblock alternatively create dedicated proxy type sdk reflect legacy abci type legacybeginblockrequest legacyendblockrequest come new type name altogether func app baseapp finalizeblockreq abcirequestfinalizeblock abciresponsefinalizeblock error ctx apppreblocker nil ctx appfinalizeblockstatectx rsp err apppreblockerctx req err nil return nil err rspconsensusparamschanged appfinalizeblockstatectx ctxwithconsensusparamsappgetconsensusparamsctx beginblockresp err appbeginblockreq appendblockeventattrbeginblockrespevents beginblock txexecresults makeabciexectxresult lenreqtxs range reqtxs result appruntxruntxmodefinalize txexecresults appendtxexecresults result endblockresp err appendblockappfinalizeblockstatectx appendblockeventattrbeginblockrespevents endblock return abciresponsefinalizeblock txresults txexecresults event joineventsbeginblockrespevents endblockrespevents validatorupdates endblockrespvalidatorupdates consensusparamupdates endblockrespconsensusparamupdates apphash nil event many tool indexer ecosystem library rely existence beginblock endblock event since cometbft expose finalizeblockevents find still useful client tool still query rely existing event especially since application still define beginblock endblock implementation order facilitate existing event functionality propose beginblock endblock event dedicated eventattribute keyblock valuebeginblockendblock eventattribute appended event beginblock endblock event upgrading cometbft defines consensus parameter voteextensionsenableheight specifies height vote extension enabled required value set zero default vote extension disabled application required implement vote extension however value positive height greater configured height vote extension must present even empty configured height reached prepareproposal include vote extension yet extendvote verifyvoteextension called reaching height prepareproposal include vote extension height important note height vote extension cannot disabled mandatory precommit message sent must extension attached even empty application update cosmos sdk version cometbft support upgrade handler must ensure set consensus parameter voteextensionsenableheight correct value application set perform upgrade height value voteextensionsenableheight set value mean upgrade height vote extension enabled yet height enabled consequence backwards compatibility abci naturally backwards compatible prior version cosmos sdk cometbft example application request requestfinalizeblock application speak abci naturally fail addition beginblock delivertx endblock removed application abci interface along input output modified module interface positive beginblock endblock semantics remain burden application developer limited communication overhead multiple abci request condensed single request set groundwork optimistic execution vote extension allow entirely new set application primitive developed inprocess price oracle encrypted mempools negative existing cosmos sdk core apis may modified thus broken signature verification processproposal vote extension signature add significant performance overhead processproposal granted signature verification process happen concurrently error group gomaxprocs goroutines neutral manually inject vote extension block proposal prepareproposal awkward approach take block space unnecessarily requirement resetprocessproposalstate create footgun application developer theyre careful necessary order application able commit state vote extension computation discussion future discussion include design implementation abci continuation abci general discussion optimistic execution reference adr abci phase