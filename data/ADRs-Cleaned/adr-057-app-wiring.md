adr app wiring changelog initial draft update update proposed implemented abstract order make easier build cosmos sdk module apps propose new app wiring system based dependency injection declarative app configuration replace current appgo code number factor made sdk sdk apps current state hard maintain symptom current state complexity simappappgo contains almost line import otherwise line mostly boilerplate code generally copied new project mention additional boilerplate get copied simappsimd large amount boilerplate needed bootstrap app made hard release independently versioned module cosmos sdk module described adr module refactoring addition verbose repetitive appgo also expose large surface area breaking change module instantiate positional parameter force breaking change anytime new parameter even optional one needed several attempt made improve current situation including adr internalmodule communication proofofconcept new sdk discussion around design led current solution described order improve current situation new app wiring paradigm designed replace appgo involves declaration configuration module app serialized json yaml dependencyinjection framework instantiating apps configuration dependency injection examining code appgo code simply instantiates module dependency provided either framework store key module keeper generally pretty obvious given correct dependency actually dependencyinjection obvious solution rather making developer manually resolve dependency module tell container dependency container figure provide explored several existing solution golang felt reflectionbased approach uberdig closest needed quite assessing needed sdk designed built cosmos sdk depinject module following feature dependency resolution provision functional constructor funcneed somedep anotherdep error dependency injection structs support optional dependency groupeddependencies manypercontainer manypercontainertype tag interface modulescoped dependency via modulekeys module get unique dependency onepermodule dependency onepermoduletype tag interface sophisticated debugging information container visualization via graphviz example would sdk module storekey could modulescoped dependency unique per module module appmodule instance equivalent could onepermoduletype cli command could provided manypercontainertypes note even though dependency resolution dynamic based reflection could considered pitfall approach entire dependency graph resolved immediately app startup get resolved except case dynamic config reloading separate topic mean error dependency graph get reported immediately startup approach slightly worse fully static resolution term error reporting much better term code complexity declarative app config order compose module app declarative app configuration configuration based protobuf basic structure simple protobuf package cosmosappv message config repeated moduleconfig module message moduleconfig string name googleprotobufany config configuration every module protobuf message module identified loaded based protobuf type url config object cosmosbankmodulevmodule module given unique short name share resource across different version module might different protobuf package version cosmosbankmodulevmodule module config object define cosmosappvalphamodule descriptor provide additional useful metadata framework also indexed module registry example app config yaml might look like yaml module name baseapp config type cosmosbaseappmodulevmodule beginblockers staking auth bank endblockers bank auth staking initgenesis bank auth staking name auth config type cosmosauthmodulevmodule bechprefix foo name bank config type cosmosbankmodulevmodule name staking config type cosmosstakingmodulevmodule example hypothetical baseapp module contains information around ordering begin blocker end blocker init genesis rather lifting concern module config layer handled module could allow convenient way swapping different version baseapp instance target different version tendermint without needing change rest config baseapp module would provide server framework sort sits outside abci app instance abciapplication model app module way dependency injectionapp config layer much protocolagnostic adapt even major breaking change protocol layer module protobuf registration order two component dependency injection declarative configuration work together described way module actually register provide dependency container one additional complexity handled layer protobuf registry initialization recall current sdk codec proposed adr protobuf semver compatible codegen protobuf type explicitly registered given app config based protobuf protobuf type protobuf registration happen app config decoded dont know protobuf type needed priori module define type decode app config separate phase parse app config jsonyaml raw json collect required module type url without proto json decoding build protobuf type registry based file descriptor type provided required module decode app config proto json protobuf type registry adr protobuf semver compatible codegen module might internal generated code registered global protobuf registry code provide alternate way register protobuf type type registry way pbgo file currently var filefooproto protoreflectfiledescriptor file fooproto generated code new member var typesfooproto typeinfo typeinfo interface struct necessary info register protobuf generated type file descriptor module must provide dependency injection provider protobuf type take input module config object uniquely identifies module based type url mind define global module register allows module implementation register following api register register module provided type name cosmosbankmodulevmodule provided func registerconfigtypename protoreflectfullname type private method provide register dependency injection provider function work cosmossdk container module function also accept additional parameter module config object func provideproviders interface type register protobuf typeinfos protobuf registry func typestypes typeinfo func init appconfigregistercosmosbankmodulevmodule appconfigtypes typestypestxproto typestypesqueryproto typestypestypesproto appconfigprovide providebankmodule type input struct containerin authkeeper authkeeper ormdbmoduledb type output struct keeper bankkeeper appmodule appmoduleappmodule func providebankmoduleconfig bankmodulevmodule input output error note module module configuration object cannot register different dependency provider runtime based configuration intentional allows know globally module provide dependency also allow code generation whole app initialization help figure issue missing dependency app config needed module loaded runtime case required module loaded runtime may possible guide user correct module global cosmos sdk module registry appmodulehandler type referenced replacement legacy appmodule framework described adr core module api new appgo setup appgo might look something like package main import package register module must imported sideeffects module implementation registered cosmossdkioxauthmodule cosmossdkioxbankmodule cosmossdkioxstakingmodule githubcomcosmoscosmossdkcoreapp goembed appyaml var appconfigyaml byte func main apprunapploadyamlappconfigyaml application existing sdk module far described system largely agnostic specific sdk store key appmodule baseapp etc improvement part framework integrate general app wiring framework defined described adr core module api registration intermodule hook module define hook interface stakinghooks allows one module call back another module certain event happen app wiring framework hook interface defined onepermoduletypes module consumes hook collect hook map module name hook type mapstringfoohooks func init appconfigregistermodule foomodulevmodule appconfiginvokeinvokesetfoohooks func invokesetfoohooks keeper keeperkeeper foohooks mapstringfoohooks error sortstringsmapskeysfoohooks keeperaddfoohooksfoohooksk optionally module consuming hook allow apps define order calling hook based module name config object way registering hook via reflection considered keeper type inspected see implement hook interface module exposing hook downside needing expose keeper module module providing hook allowing encapsulating hook different type doesnt expose keeper method harder know statically module expose hook checking approach proposed hook registration obviously observable appgo depinject codegen described code generation yet implemented depinject framework optionally allow app configuration dependency injection wiring code generated allow dependency injection wiring inspected regular code like existing appgo dependency injection optin manual wiring still possible code generation requires provider invokers parameter exported noninternal package module semantic versioning start creating semantically versioned sdk module standalone module state machine breaking change module handled follows semantic major version incremented new semantically versioned module config protobuf type created instance sdk module bank module cosmossdkioxbank module config type cosmosbankmodulevmodule want make state machine breaking change module would create new module cosmossdkioxbankv module config protobuf type cosmosbankmodulevmodule mean increment protobuf api version bank module support cosmosbankv cosmossdkioxbankv separate module separate module config type practice eventually allow appconfig load new version module via configuration change effectively correspondence semantically versioned module versioned module config protobuf type major versioning bump occur whenever state machine breaking change made module note sdk module standalone module adopt semantic versioning concern described adr module semantic versioning addressed shortterm solution issue left somewhat unresolved however easiest tactic likely standalone api module follow guideline described comment httpsgithubcomcosmoscosmossdkpullissuecomment timebeing recommended cosmos sdk module continue follow tried true based versioning officially recommended solution provided section adr updated happens section considered design recommendation future adoption semantic versioning consequence backwards compatibility module work new app wiring system drop existing appmodule newkeeper registration paradigm two method live sidebyside long needed positive wiring new apps simpler succinct errorprone easier develop test standalone sdk module without needing replicate simapp may possible dynamically load module upgrade chain without needing coordinated stop binary upgrade mechanism easier plugin integration dependency injection framework provides automated reasoning dependency project graph visualization negative may confusing dependency missing although error message graphviz visualization global module registration may help neutral require work education discussion protobuf type registration system described adr implemented may reconsidered light code generation may better type registration provider reference httpsgithubcomcosmoscosmossdkblobcedbbcabcefebcsimappappgo httpsgithubcomallinbitscosmossdkpoc httpsgithubcomubergodig httpsgithubcomgooglewire httpspkggodevgithubcomcosmoscosmossdkcontainer httpsgithubcomcosmoscosmossdkpull adr core module api