secret provider existing implementation secret service exclusive service shared secret known unknown service static secret runtime secret interface factory method bootstrap current implementation interface factory bootstrap handler method app sdks current implementation interface factory bootstrap handler method secret store nonsecure mode insecuresecrets configuration exclusive secret store abstraction interface implementation factory method bootstrap handler caching secret insecure secret handling onthefly change insecuresecrets mock secretprovider reside service device service consequence approved adr defines new secretprovider abstraction edgex service including device service secret provider service retrieve secret secret store secret store secure mode currently vault nonsecure mode configuration form databaseinfo configuration insecuresecrets configuration application service existing implementation secret provider abstraction defined adr based secret provider abstraction implementation application function sdk app sdk application service one gomodbootstrap bootstrap core support security service edgexgo device service currently secure secret app sdk implementation initially based bootstrap implementation similarity difference implementation wrap secretclient gomodsecrets initialize secretclient based secretstore configuration factory method differ greatly implement getdatabasecredentials api bootstrap split interface definition credentialsprovider certificateprovider app sdks single interface secretprovider abstraction bootstrap includes bootstrap handler app sdks bootstrap handler separated bootstrap implement getcertificatekeypair api app sdks app sdks implement following bootstrap initialize api bootstrap initialization done bootstrap handler storesecrets api getsecrets api insecuresecretsupdated api secretslastupdated api wrap second secretclient application service instance exclusive secret storesecrets getsecrets apis standard secretclient considered shared client secret application service instance share getdatabasecredentials api configuration based secret store nonsecure mode called insecuresecrets caching secret needed secret pipeline function cause call vault every event processed secret secret collection keyvalue pair stored secretstore specified path whose value sensitive nature redis database credential example secret contains username password keyvalues stored redisdb path service exclusive service shared secret service exclusive secret exclusive instance running service example exclusive secret http auth token two running instance appserviceconfigurable httpexport export different device event different endpoint different auth token http header service exclusive secret seeded posting secret apivxsecrets endpoint running instance application service service shared secret instance class service application service share think core data class service example shared secret database credential single database instance store forward data application service may access another example database credential instance core data shared one instance core data currently ever run service shared secret seeded securitysecretstoresetup static configuration static secret known service currently database credential shared secret future may message bus credential shared secret truly shared secret service securely connect message bus shared instance service application service currently ability configure secretstores service exclusive andor service shared secret depending known unknown service known service identified static configuration securitysecretstoresetup currently core data core metadata support notification support scheduler application service class unknown service known static configuration become known added docker compose file snap application service instance example service service exclusive secretstore created service adding service unique name appservicehttpexport edgexaddsecretstoretokens environment variable securitysecretstoresetup edgexaddsecretstoretokens appservicehttpexport appservicemqttexport creates exclusive secret store token service listed name provided service must service secretstore configuration docker volume mount applicable typically configuration set via environment override already existing configuration profile httpexport profile appserviceconfigurable example dockercompose file entry yaml environment secretstoreexclusivepath vsecretedgexappservicehttpexport tokenfile tmpedgexsecretsappservicehttpexportsecretstokenjson volume tmpedgexsecretsappservicehttpexporttmpedgexsecretsappservicehttpexportroz static secret runtime secret static secret identified name static configuration whose value randomly generated seed time secret seeded startup edgex database credential currently secret type runtime secret known static configuration become known run time secret seeded run time via application service apivxsecrets endpoint http header authorization credential http export type secret interface factory method bootstrap current implementation interface type credentialsprovider interface getdatabasecredentialsdatabase configdatabase configcredentials error type certificateprovider interface getcertificatekeypairpath string configcertkeypair error factory bootstrap handler method type secretprovider struct secretclient pkgsecretclient func newsecret secretprovider return secretprovider func secretprovider bootstraphandler ctx contextcontext syncwaitgroup startuptimer startuptimer dic dicontainer bool intializes secretclient add dic interface app sdks current implementation interface type secretprovider interface initialize contextcontext bool storesecretspath string secret mapstringstring error getsecretspath string string mapstringstring error getdatabasecredentialsdatabase dbdatabaseinfo commoncredentials error insecuresecretsupdated secretslastupdated timetime factory bootstrap handler method type secretproviderimpl struct sharedsecretclient pkgsecretclient exclusivesecretclient pkgsecretclient secretscache mapstringmapstringstring secret path key value configuration commonconfigurationstruct cachemuxtex syncmutex loggingclient loggerloggingclient track secret last retrieved lastupdated timetime func newsecretprovider loggingclient loggerloggingclient configuration commonconfigurationstruct secretproviderimpl secretproviderimpl secretscache makemapstringmapstringstring cachemuxtex syncmutex configuration configuration loggingclient loggingclient lastupdated timenow return type secret struct func newsecrets secret return secret func secret bootstraphandler ctx contextcontext syncwaitgroup startuptimer startuptimer dic dicontainer bool creates newnewsecretprovider call initailizes add dic secret store nonsecure mode bootstrap app sdks implementation databaseinfo configuration getdatabasecredentials api nonsecure mode app sdk backward compatibility database credential found new insecuresecrets configuration section ireland planned new insecuresecrets configuration section nonsecure mode note redis credential blank nonsecure mode core data toml database databasesprimary host localhost name coredata username password port timeout type redisdb application service toml database type redisdb host localhost port username password timeout insecuresecrets configuration app sdk defines new writable configuration section called insecuresecrets structure mimic secure secretstore edgexsecuritysecretstoreenvironment variable set false insecuresecrets writable section allows secret updated without restarting service minor processing must occur insecuresecrets section updated call insecuresecretsupdated api api simply set time secret last updated secretslastupdated api return timestamp pipeline function credential exporting know client recreated new credential mqtt export type writableinfo struct loglevel string insecuresecrets insecuresecrets type insecuresecrets mapstringinsecuresecretsinfo type insecuresecretsinfo struct path string secret mapstringstring toml writableinsecuresecrets writableinsecuresecretsdb path redisdb writableinsecuresecretsdbsecrets username password writableinsecuresecretsmqtt path mqtt writableinsecuresecretsmqttsecrets username password cacert clientcert clientkey new secretprovider abstraction defined adr combination two implementation described existing implementation section exclusive secret store simplify secretprovider abstraction reduce exclusive secretstores allows apis deal single secretclient rather split way currently application service requires current application service shared secret database credential must copied application service exclusive secretstore created challenge seed static secret unknown service become known described known unknown service section service currently identify exclusive secretstore creation via edgexaddsecretstoretokens environment variable securitysecretstoresetup environment variable simply take comma separated list service name yaml edgexaddsecretstoretokens servicenameservicename expanded add optional list static secret identifier service appserviceredisdb exclusive store could also seeded copy static shared secret case redis database credential application service shared database environment variable name change addsecretstore token yaml addsecretstore appservicexyzappserviceredisdb note secret identifier short path secret existing appservice secretstore example expands full path secretedgexappserviceredisdb example result redis credential copied appservicexyzs secretstore secretedgexappservicexyzredis similar approach could taken message bus credential common secretstore created message bus credential saved service request credential copied exclusive secretstore commonmessagebus secret identifier full specification environment variable value comma separated list service entry defined servicenameoptional list static secret sperated servicenameoptional list static secret sperated example one service specifying static secret one without static secret yaml addsecretstore appservicexyzappserviceredisdb commonmessagebus appservicehttpexport addsecretstore environment variable processed create secretstores copy specified saved secret initial secretstore service secretstore depends completion database credential bootstrapping secret stored prior environment variable processed securitysecretstoresetup refactored ensure sequencing abstraction interface following new secretprovider abstraction interface edgex service type secretprovider interface store new secret service exclusive secretstore specified path storesecretspath string secret mapstringstring error retrieves secret service exclusive secretstore specified path getsecretspath string string mapstringstring error set secret lastupdated time current time secretsupdated return secret last updated time secretslastupdated timetime note getdatabasecredentials getcertificatekeypair apis removed longer needed since insecure database credential longer stored databaseinfo configuration certificate key pair secret like others allows secret retrieved via getsecrets api implementation factory method bootstrap handler factory method bootstrap handler follow currently bootstrap implementation tweak rather putting two split interface dic put single interface instance dic see detail interface factory method section existing implementation caching secret secret cached currently application service implementation insecure secret insecure secret handled currently application service implementation databaseinfo configuration longer storing insecure database credential stored insecuresecrets configuration toml writableinsecuresecrets writableinsecuresecretsdb path redisdb writableinsecuresecretsdbsecrets username password handling onthefly change insecuresecrets service handle special processing insecuresecrets changed onthefly via consul since common configuration item writable handled gomodbootstrap along existing log level processing special processing taken app sdk mock proper mock secretprovider interface created mockery unit test current mock app sdk hand written rather generated mockery secretprovider reside service final make new secretprovider abstraction reside originally assumed would reside gomodsecrets seems logical attempt implementation including bootstrap handler gomodsecrets would dependency gomodbootstrap likely create circular dependency refactoring existing implementation gomodbootstrap reside seems best choice device service device sdk implement secretprovider abstraction insecuresercets configuration underling secretstore client consequence service writableinsecuresecrets section added configuration insecuresecrets definition moved app sdk gomodbootstrap device sdk add secretprovider bootstrapping device sdk implementation could big lift secretstoreconfiguration section added device service edgexgo service modified single secretprovider interface dic place current usage getdatabasecredentials getcertificatekeypair interface call getdatabasecredentials getcertificatekeypair replaced call getsecrets api appropriate processing returned secret added app sdk modified getsecrets api place getdatabasecredentials api app sdk modified new secretprovider bootstrap handler appserviceconfigurables configuration profile well application service example configuration updated remove secretstoreexclusive configuration existing secretstore configuration securitysecretstoresetup enhanced described exclusive secret store section adding new service static secret added secretstore requires stopping restarting service securitysecretstoresetup completed stopped rerun without stopping service token static secret changed planned refactor securitysecretstoresetup attempt resolve snap yet support setting environment variable adding secretstore planned ireland release