adr core module api changelog first draft first draft update partially implemented abstract new core api proposed way develop cosmossdk application eventually replace existing appmodule sdkcontext framework set core service extension interface core api aim simpler extensible stable current framework enable deterministic event query support event listener adr protobufbased intermodule communication client historically module exposed functionality framework via appmodule appmodulebasic interface following shortcoming appmodule appmodulebasic defined registered counterintuitive apps implement full interface even part dont although workarounds interface method depend heavily unstable third party dependency particular comet legacy required method littered interface far long order interact state machine module needed combination thing get store key app call method sdkcontext contains full set capability available module isolating state machine functionality sdkcontext set functionality available module tightly coupled type change upstream dependency comet new functionality desired alternate store type change impact sdkcontext consumer basically module also module receive contextcontext convert sdkcontexts nonergonomic unwrapping function breaking change interface one imposed thirdparty dependency like comet side effect forcing module ecosystem update lockstep mean almost impossible version module run different version sdk different version another module lockstep coupling slows overall development within ecosystem cause update component delayed longer would thing stable loosely coupled core api proposes set core apis module rely interact state machine expose functionality designed principled way tight coupling dependency unrelated functionality minimized eliminated apis longterm stability guarantee sdk framework extensible safe straightforward way design principle core api follows everything module want interact state machine service service coordinate state via contextcontext dont try recreate bag variable approach sdkcontext independent service isolated independent package minimal apis minimal dependency core api minimalistic designed longterm support lts runtime module implement core service defined core api handle module functionality exposed core extension interface noncore andor nonlts service exposed specific version runtime module module following design principle includes functionality interacts specific nonstable version third party dependency comet core api doesnt implement functionality defines type stable api compatibility guideline followed httpsgodevblogmodulecompatibility runtime module module implement core functionality composing abci app currently handled baseapp modulemanager runtime module implement core api intentionally separate core api order enable parallel version fork runtime module possible sdks current tightly coupled baseapp design still allowing high degree composability compatibility module built core api dont know anything version runtime baseapp comet order compatible module core mainline sdk could easily composed forked version runtime pattern design intended enable matrix compatible dependency version ideally given version module compatible multiple version runtime module compatible module allow dependency selectively updated based battletesting conservative project may want update dependency slower fast moving project core service following core service defined core api valid runtime module implementation provide implementation service module via dependency injection manual wiring individual service described bundled convenient appmoduleservice bundle service simplicity module declare dependency single service store service store service defined cosmossdkiocorestore package generic storekvstore interface current sdk kvstore interface store key refactored store service instead expecting know store invert pattern allow retrieving store generic three store service three type currently supported store regular kvstore memory transient type kvstoreservice interface openkvstorecontextcontext kvstore type memorystoreservice interface openmemorystorecontextcontext kvstore type transientstoreservice interface opentransientstorecontextcontext kvstore module service like func msgserver sendctx contextcontext msg typesmsgsend typesmsgsendresponse error store kkvstoresvcopenkvstorectx current runtime module implementation module explicitly name store key rather runtime module choose appropriate name module request type store dependency injection manual constructor event service event service defined cosmossdkiocoreevent package event service allows module emit typed legacy untyped event package event type service interface emitprotoevent emits event represented protobuf message described adr caller assume event may included consensus event must emitted deterministically adding removing changing event considered statemachine breaking emitprotoeventctx contextcontext event protoifacemessagev error emitkvevent emits event based event kvpair attribute event part consensus adding removing changing event statemachine breaking change emitkveventctx contextcontext eventtype string attrs kveventattribute error emitprotoeventnonconsensus emits event represented protobuf message described adr without including blockchain consensus event part consensus adding removing changing event statemachine breaking change emitprotoeventnonconsensusctx contextcontext event protoifacemessagev error typed event emitted emitproto assumed part blockchain consensus whether part block app hash left runtime specify event emitted emitkvevent emitprotoeventnonconsensus considered part consensus cannot observed module clientside add event patch release method logger logger cosmossdkiolog must supplied depinject made available module via depinjectin module follow current pattern sdk adding module name type moduleinputs struct depinjectin logger loglogger func providemodulein moduleinputs moduleoutputs keeper keepernewkeeper inlogger func newkeeperlogger loglogger keeper return keeper logger loggerwithlogmodulekey xtypesmodulename core appmodule extension interface module provide core service runtime module via extension interface built top cosmossdkiocoreappmoduleappmodule tag interface tag interface requires two empty method allow depinject identify implementers depinjectonepermodule type app module implementation type appmodule interface depinjectonepermoduletype isappmodule dummy method tag struct implementing appmodule isappmodule core extension interface defined cosmossdkiocore supported valid runtime implementation msgserver queryserver registration msgserver queryserver registration done implementing hasservices extension interface type hasservices interface appmodule registerservicesgrpcserviceregistrar cosmosmsgvservice protobuf required msg service serviceregitrar register msg query service genesis genesis handler function defaultgenesis validategenesis initgenesis exportgenesis specified genesissource genesistarget interface abstract genesis source may single json object collection json object efficiently streamed genesissource source genesis data json format may abstract single json object separate file field json object streamed module open separate ioreadcloser field required field represent array efficiently streamed data field function return nil nil important caller close reader done type genesissource funcfield string ioreadcloser error genesistarget target writing genesis data json format may abstract single json object json separate file streamed module open separate iowritecloser field prefer writing field array possible support efficient iteration important caller closer writer check error done expected stream json data written writer type genesistarget funcfield string iowritecloser error genesis object given module expected conform semantics json object field json object read written separately support streaming genesis orm collection support streaming genesis module framework generally write manual genesis code support genesis module implement hasgenesis extension interface type hasgenesis interface appmodule defaultgenesis writes default genesis module target defaultgenesisgenesistarget error validategenesis validates genesis data read source validategenesisgenesissource error initgenesis initializes module state genesis source initgenesiscontextcontext genesissource error exportgenesis export module state genesis target exportgenesiscontextcontext genesistarget error pre blocker module functionality run beginblock implement haspreblocker interface type haspreblocker interface appmodule preblockcontextcontext error begin end blocker module functionality run transaction begin blocker transaction end blocker implement hasbeginblocker andor hasendblocker interface type hasbeginblocker interface appmodule beginblockcontextcontext error type hasendblocker interface appmodule endblockcontextcontext error beginblock endblock method take contextcontext module dont comet information blockinfo eliminate dependency specific comet version module comet block header andor return validator update specific version runtime module provide specific functionality interacting specific version comet supported order beginblock endblock initgenesis send back validator update retrieve full comet block header runtime module specific version comet could provide service like type validatorupdateservice interface setvalidatorupdatescontextcontext abcivalidatorupdate header service defines way get header information block information generalized implementation type service interface headerinfocontextcontext info type info struct height int height return height block hash byte hash return hash block header time timetime time return time block chainid string chainid return chain block comet service provides way get comet specific information type service interface getcometinfocontextcontext info type cometinfo struct evidence abcimisbehavior misbehavior return misbehavior block validatorshash return hash validators comet hash next validators validatorshash byte proposeraddress byte proposeraddress return address block proposer decidedlastcommit abcicommitinfo decidedlastcommit return last commit info user would like provide module information would implement another service like type rollkit interface know type change comet level also limited set module actually functionality intentionally kept core keep core limited necessary minimal set stable apis remaining part appmodule current appmodule framework handle number additional concern arent addressed core api include gas block header upgrade registration gogo proto amino interface type cobra query command grpc gateway crisis module invariant simulation additional appmodule extension interface either inside outside core specified handle concern case gogo proto amino interface registration generally happen early possible initialization adr app wiring protobuf type registration happens dependency injection although could alternatively done dedicated provider grpc gateway registration probably handled runtime module core api shouldnt depend grpc gateway type already older version possible framework registration automatically future runtime module probably provide sort specific type registration type grpcgatewayinfo struct handler grpcgatewayhandler type grpcgatewayhandler funcctx contextcontext mux runtimeservemux client queryclient error module return provider func providegrpcgateway grpcgatewayinfo return grpcgatewayinfo handler handler typesregisterqueryhandlerclient crisis module invariant simulation subject potential redesign managed type defined crisis simulation module respectively extension interface cli command provided via cosmossdkioclientv module autocli framework example usage example setting hypothetical foo module orm state management genesis type keeper struct ormmoduledb evtsrv eventservice func keeper registerservicesr grpcserviceregistrar foovregistermsgserverr foovregisterqueryserverr func keeper beginblockcontextcontext error return nil func provideappconfig foomodulevmodule evtsvc eventeventservice ormmoduledb keeper appmoduleappmodule keeperdb evtsvc evtsvc return runtime compatibility version core module define static integer var cosmossdkiocoreruntimecompatibilityversion minor version indicator core module accessible runtime correct runtime module implementation check compatibility version return error current runtimecompatibilityversion higher version core api runtime version support new feature added core module api runtime module required support version incremented runtime module initial runtime module simply created within existing githubcomcosmoscosmossdk module runtime package module small wrapper around existing baseapp sdkcontext module manager follow cosmos sdks existing based versioning move semantic versioning well runtime modularity new officially supported runtime module created cosmossdkioruntime prefix supported consensus engine semanticallyversioned module created runtime implementation consensus engine example cosmossdkioruntimecomet cosmossdkioruntimecometv cosmossdkioruntimerollkit etc runtime module attempt semantically versioned even underlying consensus engine also runtime module also first class cosmos sdk module protobuf module config type new semantically versioned module config type created runtime module correspondence module module config type practice followed every semantically versioned cosmos sdk module described adr app wiring currently githubcomcosmoscosmossdkruntime protobuf config type cosmosappruntimevalphamodule standalone comet runtime dedicated protobuf module config type cosmosruntimecometvmodule release comet runtime cosmossdkioruntimecometv corresponding cosmosruntimecometvmodule protobuf type order make easier support different consensus engine support core module functionality described adr common module created shared runtime component easiest runtime component share initially probably messagequery router intermodule client service register event router common runtime module created initially cosmossdkioruntimecommon module new architecture implemented main dependency cosmos sdk module would cosmossdkiocore module able supported consensus engine extent explicitly depend consensus engine specific functionality comet block header app developer would able choose consensus engine want importing corresponding runtime module current baseapp would refactored cosmossdkioruntimecomet module router infrastructure baseapp would refactored cosmossdkioruntimecommon support adr eventually dependency githubcomcosmoscosmossdk would longer required short module would depend primarily cosmossdkiocore cosmossdkioruntimeconsensusengine would implement cosmossdkiocore functionality consensus engine additional piece would resolved part architecture runtimes relate server likely would make sense modularize current server architecture runtime even based consensus engine besides comet mean eventually comet runtime would encapsulate logic starting comet abci app testing mock implementation service provided core allow unit testing module without needing depend particular version runtime mock service allow test observe service behavior provide nonproduction implementation instance memory store mock store integration testing mock runtime implementation provided allows composing different app module together testing without dependency runtime comet consequence backwards compatibility early version runtime module aim support much possible module built existing appmodulesdkcontext framework core api widely adopted later runtime version may choose drop support support core api plus runtime module specific apis like specific version comet core module strive remain semantic version long possible follow design principle allow strong longterm support lts older version sdk support module built core adaptor convert wrap core appmodule implementation implementation appmodule conform version sdks semantics well providing service implementation wrapping sdkcontext positive better api encapsulation separation concern stable apis framework extensibility deterministic event query event listener intermodule msg query execution support explicit support forking merging module version including runtime negative neutral module refactored api replacement appmodule functionality still defined followup type registration command invariant simulation take additional design work discussion gas block header upgrade registration gogo proto amino interface type cobra query command grpc gateway crisis module invariant simulation reference adr protobufbased intermodule communication adr app wiring adr orm adr public key address keeping module compatible