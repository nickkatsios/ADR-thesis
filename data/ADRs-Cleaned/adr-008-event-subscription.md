adr rpc client event subscription mechanism changelog initial draft tendermint light client one many important application make rpc client query tendermint full node information relating blockchain tendermint server full node provide event subscription rpc endpoint allow client receive notification specific event happen currently via websockets connection expose subscription mechanism rpc client order achieve ergonomic interface rpc client allows developer subscribe event produced specific query specifically interface must offer subscription functionality single subscription take place event produced query peg time writing located caller must able create multiple distinct subscription subscription must offer interface allow iteration incoming event relevant subscription produce event stream must possible outside rpc client receive event multiple subscription event stream concurrently without interfering withblocking must possible outside rpc client handle subscription event stream without blocking rpc operation offer ability unsubscribe specific query terminate specific subscription appropriate concurrency model driver transport layer allows transport layer operate independently consumer subscription consumer dont block transport layer activity viceversa assumption blocking operation deal must async deasyncifying rpc rather future adr propose synchronous architecture well one proposed entity relationship entity diagram described following subsection event term subscription interface ultimately end user interested obtaining event type structure dictated tendermint rpc rust pub struct event query produced event pub query string data associated event determines itseventtype pub data eventdata event type attribute map pub event pub enum eventdata newblock block resultbeginblock resultendblock txresult txresult subscription subscription envisaged entity implement stream trait allowing owner asynchronously iterate relevant incoming event subscription simple rust let someresultevent subscriptionnextawait match resultevent okevent handle event erre terminate subscription report error terminate subscription unsubscribe consume since subscription could moved consumed asynchronous distinct original client entity created would make sense unsubscribing accessible subscriptionterminateawaitunwrap asynchronous destructors available rust terminate method longer necessary efficient routing event subscription subscription kind unique identifier associated subscriptionid subscription relates single query therefore publicly accessible field may resemble following rust pub struct subscription pub subscriptionid pub query query field help facilitate intertask comms buffering event since rate event could produced remote rpc endpoint may differ rate client process buffer incoming event subscription hood subscription envisaged make kind unbounded channel buffer incoming event provided tokio mpsc dont propose bounded channel yet since complicate concurrency model significantly would cater case encounter full channel provide conventional applicationspecific way dealing full channel backoff backpressure managing multiple simultaneous subscription may come instance client would want initiate multiple subscription different event type consume since subscription struct implement stream trait streamrelated functionality enhance ergonomics working subscription example wanted iterate two subscription time processing event order received client rust futuresstreamselectall sub sub subscription let someres selectallvecsubs subsnextawait match okevent handle event erre handle error client model user tendermint rpc library may may want access subscription functionality since functionality come additional overhead term resource usage asynchronous task management would optimal provide two separate client trait one implement nonsubscription functionality one implement subscription functionality client could either implement one trait interface two type client envisaged follows client type client would allow interaction rpc endpoint except pertaining subscription management current implementation client would interact via http rpc endpoint httpclient entity diagram note async trait facilitated asynctrait rust pub type result stdresultresult asynctrait pub trait client abciinfo get information abci application async abciinfoself result abciquery query abci application async abciqueryv self path optionabcipath data height optionheight prove bool resultabciqueryabciquery intovecu send perform general request rpc endpoint async performrself request resultrresponse request subscriptionclient subscriptionclient would one provides access subscription functionality current implementation client would interact websocket connection provide subscription functionality websocketclient entity diagram rust asynctrait pub trait subscriptionclient subscribe subscribe receive event produced given query async subscribemut self query query result client implementation envisage distinct client implementation point httpclient implement client http websocketclient implement client subscriptionclient websocket connection handledriver concurrency model depending underlying transport client may transport driver running asynchronous example websocket connection rate one interacts websocket connection may differ rate one interacts event produced subscription necessarily run concurrently different implementation transport driver transportspecific shortlived requestresponse interaction http would require transport driver whereas websocket connection would case driver necessary client implementation would become handle driver facilitating communication across asynchronous task rough sketch interaction model different component envisaged make subscription subsystem shown following sequence diagram query proposed builder pattern implement subscription query interface implement full query peg provided implementation rpc client would allow compiletime validation query desired interface constructing query would look follows rust tmeventnewblock let query queryfromeventtypenewblock tmeventtx txhashxyz let query queryfromeventtypetxandeqtxhash xyz tmeventtx txheight let query queryfromeventtypetxandeqtxheight interface could implemented along following line rust query would constructor either specified event type corresponding atmeventeventtype query condition must constructor allows construction empty query pub struct query query match zero one type event eventtype query contain zero condition condition vec impl query fromeventtype eventtype self self eventtype someeventtype condition vecnew impl query example constructor operationeq pub eqkey str value impl self self eventtype none condition vecconditionnewkey operationeqvalueinto allows simple builder pattern pub andeqmut self key str value impl intooperand self selfconditionspushconditionnewkey operationeqvalueinto self derived httpsgithubcomtenderminttendermintblobmaintypeseventsgo pub enum eventtype newblock newblockheader newevidence validatorsetupdates condition specifies key first parameter depending operation value operand kind pub enum condition equal eqstring operand ltstring operand equal ltestring operand greater gtstring operand greater equal gtestring operand contains check key contains certain substring containsstring string exists check key exists existsstring according httpsdocstendermintcomvrpcwebsocketsubscribe operand string number time differentiate integer floating point number would useful implement trait different operand type operand enum would improve ergonomics pub enum operand stringstring signedi unsignedu floatf datechronodate datetimechronodatetime subscription tracking routing internally subscriptionrouter proposed hashmap keep track query relating particular client rust pub struct subscriptionrouter map query map subscription result event channel subscription hashmapstring hashmapstring subscriptiontx present tendermint includes subscription relating particular event jsonrpc message data structure optimal configuration necessarily change tendermints websocket server drop subscription event likely want conform strictly jsonrpc standard notification handling mixed event response since full client implement client subscriptionclient trait certain transport like websocket connection could end receiving mixture event subscription response rpc request disambiguate different type incoming message simple mechanism proposed websocketclientdriver keep track pending request matures receives corresponding response rust pub struct websocketclientdriver command weve received yet completed indexed terminate command executed immediately pendingcommands hashmapstring drivercommand different type request websocketclient send driver subscribecommand unsubscribecommand simplerequestcommand keep response channel allows driver send response later receives relevant one enum drivercommand initiate subscription request subscribesubscribecommand initiate unsubscribe request unsubscribeunsubscribecommand nonsubscriptionrelated request simplerequestsimplerequestcommand terminate outgoing request randomly generated uuidv string logic follows call made websocketclientsubscribe websocketclientperform client sends relevant drivercommand driver via internal communication channel driver receives command sends relevant simple subscription request keep track command pendingcommands member along allows driver continue handling outgoing request incoming response meantime driver receives jsonrpc message whose corresponds pendingcommands member assumes response relevant command sends back original caller way channel stored one subscribecommand unsubscribecommand simplerequestcommand structs failure also communicated mechanism pending command evicted pendingcommands member proposed consequence positive provides relatively intuitive developer ergonomics subscription iteration produce event mocking client functionality relatively easy allowing greater variety testing including simulating transportlevel failure negative requires additional concurrent potentially longrunning async task concerned partially mitigated handledriver concurrency model neutral none reference tendermint rpc subscription endpoint