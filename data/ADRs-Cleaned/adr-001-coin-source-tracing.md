adr coin source tracing changelog initial draft implementation change implemented specification ibc crosschain fungible token transfer aware origin token denomination order relay packet contains sender recipient addressed fungibletokenpacketdata packet relay sending work based case per specification colin axnrs description sender chain acting source zone coin transferred escrow address locked sender chain transferred receiving chain ibc tao logic expected receiving chain mint voucher receiving address sender chain acting sink zone coin voucher burned sender chain transferred receiving chain though ibc tao logic expected receiving chain previously sent original denomination unescrow fungible token send receiving address another way thinking source sink zone token timeline send chain one previously received movement forward token timeline cause trace added token history destination port destination channel prefixed denomination instance sender chain acting source zone token sent back chain previously received prefix removed backwards movement token timeline sender chain acting sink zone example assume following channel connection exist channel port transfer chain channel chain chain channeltob channeltoc respectively chain channel chain chain channeltoa channeltoc respectively chain channel chain chain channeltoa channeltob respectively step transfer chain occur following order particular sender chain source zone sends packet denom escrowed receives denom mint sends voucher transferchanneltoadenom recipient sender chain source zone sends packet transferchanneltoadenom escrowed receives transferchanneltoadenom mint sends voucher transferchanneltobtransferchanneltoadenom recipient sender chain source zone sends packet transferchanneltobtransferchanneltoadenom escrowed receives transferchanneltobtransferchanneltoadenom mint sends voucher transferchanneltoctransferchanneltobtransferchanneltoadenom recipient sender chain sink zone sends packet transferchanneltoctransferchanneltobtransferchanneltoadenom burned receives transferchanneltoctransferchanneltobtransferchanneltoadenom unescrows sends transferchanneltobtransferchanneltoadenom recipient token final denomination chain transferchanneltobtransferchanneltoadenom transferchanneltobtransferchanneltoa trace information upon receive crosschain fungible token transfer sender chain source token protocol prefix denomination port channel identifier following format typescript prefix denom destportndestchannelndestportdestchanneldenom example transferring uatom port hubport channel hubchannel hub ethermints port ethermintport channel ethermintchannel result ethermintportethermintchanneluatom ethermintportethermintchanneluatom new denomination receiving chain case token transferred back hub source chain prefix trimmed token denomination updated original one problem problem adding additional information coin denomination twofold ever increasing length token transferred zone source token transferred time via ibc sink chain token denom contain pair prefix shown format example pose problem port channel identifier maximum length sdk coin type accepts denoms character thus single crosschain token composed port channel identifier plus base denomination exceed length validation sdk coin result undesired behaviour token able transferred multiple sink chain denomination exceeds length unexpected panic due denomination validation failing receiving chain existence special character uppercase letter denomination sdk every time coin initialized constructor function newcoin validation coin denom performed according regex lowercase alphanumeric character desirable native denomination keep clean present challenge ibc port channel might randomly generated special uppercase character per host requirement specification issue outlined applicable sdkbased chain thus proposed solution require specification change would result modification implementation spec instead adding identifier coin denomination directly proposed solution hash denomination prefix order get consistent length crosschain fungible token internal storage transferred via ibc different chain denomination specified packed data full prefix path identifier needed trace token back originating chain specified new proposed format following golang ibcdenom ibc hashtrace path base denom hash function sha hash field denomtrace protobuf denomtrace contains base denomination fungible token source tracing information message denomtrace chain portchannel identifier tracing source fungible token string path base denomination relayed fungible token string basedenom ibcdenom function construct coin denomination creating fungible token packet data golang hash return hex byte sha hash denomtrace field following formula hash shatracepath basedenom func denomtrace hash tmbyteshexbytes return tmhashsumdtpath dtbasedenom ibcdenom coin denomination fungible token format ibchashtracepath basedenom trace empty return base denomination func denomtrace ibcdenom string dtpath return fmtsprintfibcs dthash return dtbasedenom xibctransfer change order retrieve trace information ibc denomination lookup table added ibctransfer module value also persisted upgrade meaning new denomtrace genesisstate field state added module golang getdenomtrace retrieves full identifier trace base denomination store func keeper getdenomtracectx denomtracehash byte denomtrace bool store ctxkvstorekstorekey storegettypeskeydenomtracetracehash nil return denomtrace false var denomtrace denomtrace kcdcmustunmarshalbinarybarebz denomtrace return denomtrace true hasdenomtrace check key given trace hash exists store func keeper hasdenomtracectx denomtracehash byte bool store ctxkvstorekstorekey return storehastypeskeytracedenomtracehash setdenomtrace set new trace hash trace pair store func keeper setdenomtracectx denomtrace denomtrace store ctxkvstorekstorekey kcdcmustmarshalbinarybaredenomtrace storesettypeskeytracedenomtracehash msgtransfer validate coin denomination token field contains valid hash trace info provided base denomination match golang func msg msgtransfer validatebasic error return validateibcdenommsgtokendenom golang validateibcdenom validates given denomination either valid base denomination uatom valid fungible token representation ibchash per adr httpsgithubcomcosmoscosmossdkblobmasterdocsarchitectureadrcoinsourcetracingmd func validateibcdenomdenom string error denomsplit stringssplitndenom switch case stringstrimspacedenom lendenomsplit denomsplit ibc lendenomsplit denomsplit ibc stringstrimspacedenomsplit return sdkerrorswrapferrinvaliddenomfortransfer denomination prefixed format ibchashtrace denom case denomsplit denom stringstrimspacedenom return sdkvalidatedenomdenom err parsehexhashdenomsplit err nil return wrapferr invalid denom trace hash denomsplit return nil denomination trace info updated token received receiver source chain receiver created token must trace lookup already stored necessary native token case wouldnt lookup receiver source chain store received info example step chain receives transferchanneltoadenom golang sendtransfer fulldenompath tokendenom deconstruct token denomination denomination trace info determine sender source chain stringshasprefixtokendenom ibc fulldenompath err kdenompathfromhashctx tokendenom err nil return err typessenderchainissourcesourceport sourcechannel fulldenompath golang denompathfromhash return full denomination path prefix ibc denom hash component func keeper denompathfromhashctx sdkcontext denom string string error hexhash denom hash err parsehexhashhexhash err nil return wraperrinvaliddenomfortransfer errerror denomtrace found kgetdenomtracectx hash found return wraperrtracenotfound hexhash fulldenompath denomtracegetfulldenompath return fulldenompath nil golang onrecvpacket prefix would prefixed denomination sender chain token originally came receiving chain note sourceport sourcechannel counterparty chain would prefixed destport destchannel originally receiving coin seen sender chain source condition receiverchainissourcepacketgetsourceport packetgetsourcechannel datadenom sender chain source unescrow token remove prefix added sender chain voucherprefix typesgetdenomprefixpacketgetsourceport packetgetsourcechannel unprefixeddenom datadenomlenvoucherprefix token sdknewcoinunprefixeddenom sdknewintfromuintdataamount unescrow token escrowaddress typesgetescrowaddresspacketgetdestport packetgetdestchannel return kbankkeepersendcoinsctx escrowaddress receiver sdknewcoinstoken sender chain source mint voucher since sendpacket prefix denomination must prefix denomination sourceprefix typesgetdenomprefixpacketgetdestport packetgetdestchannel note sourceprefix contains trailing prefixeddenom sourceprefix datadenom construct denomination trace full raw denomination denomtrace typesparsedenomtraceprefixeddenom set value lookup table stored already tracehash denomtracehash khasdenomtracectx tracehash ksetdenomtracectx tracehash denomtrace voucherdenom denomtraceibcdenom voucher sdknewcoinvoucherdenom sdknewintfromuintdataamount mint new token source transfer chain err kbankkeepermintcoins ctx typesmodulename sdknewcoinsvoucher err nil return err send receiver return kbankkeepersendcoinsfrommoduletoaccount ctx typesmodulename receiver sdknewcoinsvoucher golang func newdenomtracefromrawdenomdenom string denomtrace denomsplit stringssplitdenom trace lendenomsplit trace stringsjoindenomsplitlendenomsplit return denomtrace basedenom denomsplitlendenomsplit trace trace one final remark fungibletokenpacketdata remain prefixed full denomination since receiving chain may sdkbased chain coin change coin denomination validation updated reflect change particular denomination validation function accept slash separator uppercase character due hexbytes format bump maximum character length hex representation tendermints hexbytes type contains character additional validation logic verifying length hash may added bank module future custom base denomination validation integrated sdk positive clearer separation source tracing behaviour token transfer prefix original coin denomination consistent validation coin field special character fixed max length cleaner coin standard denomination ibc additional field sdk coin negative store set tracing denomination identifier ibctransfer module store client fetch base denomination every time receive new relayed fungible token ibc mitigated mapcache already seen hash client side form mitigation would opening websocket connection subscribe incoming event neutral slight difference spec additional validation logic ibc coin ibctransfer module additional genesis field slightly increase gas usage crosschain transfer due access store interblock cached transfer frequent reference fungible token transfer custom coin denomination validation