record upgrade elasticsearch highlevel migration plan running searchapi rummager parallel elasticsearch compatibility looking future elasticsearch compatibility new cluster architecture synchronising state switching application staging teething problem production teething problem data sync production staging integration dockerising development work done change rummager searchapi contained also significant change govukaws govukawsdata govukpuppet various repository small change well terminology rummager elasticsearch search service deployed carrenza staging production searchapi elasticsearch search service deployed aws highlevel migration plan decided two highlevel objective planning closetozerodowntime switch dont want set new infrastructure carrenza consequence needed least temporarily two elasticsearch cluster elasticsearch carrenza elasticsearch aws rest plan came create fork rummager called searchapi run different port deployed aws make searchapi work elasticsearch arrange update sent rummager also sent searchapi set new elasticsearch cluster perform onetime import data elasticsearch elasticsearch synchronise update missed import running confirm elasticsearch elasticsearch cluster consistent plek make application read search searchapi plek make application write search searchapi retire rummager elasticsearch anything related licencefinder also elasticsearch store small amount data reindex minute decided complication running second licencefinder soon new elasticsearch cluster existed production switched licencefinder running searchapi rummager parallel largely matter following set new rail application documentation main difference basing configuration searchapi existing puppet etc code rummager change needed rummager configuration changing port first available free port changing redis namespace rummager searchapi changing rabbitmq namespace rummager searchapi additionally searchapi hostname needed adding terraform configuration elasticsearch compatibility elasticsearch release note includes large section breaking change neither developer team knew elasticsearch start quarter section served guide necessary documentation main change address structural change query language generally straightforward resolve two complex issue revisited moving elasticsearch default text similarity metric changed classic algorithm encountered problem result ordering possibly due switched back classic algorithm elasticsearch string type split two new type keywords text different behaviour elasticsearch internally transforms single string field two field new type transparently handling indexing querying update schema textkeywords looking future elasticsearch compatibility elasticsearch allow multiple document type index elasticsearch allow two way solve problem combine type one large type add type field application add separate index type decided combine type index one big type added documenttype field distinguish elasticsearch anyway document lucene index must type think imposes additional overhead searchapi still validates document schema different field hold type external api changed new cluster architecture decided aws managed elasticsearch cluster selfmanaging elasticsearch undesirable nobody know manage elasticsearch version puppet old cant version puppetelasticsearch support elasticsearch much harder scale designed new cluster architecture based resource allocated current elasticsearch cluster proved sufficient time writing cluster three dedicated master node type clargeelasticsearch six data node type rlargeelasticsearch cluster configured appelasticsearch terraform project synchronising state two step ensuring search update sent rummager also sent searchapi import current elasticsearch data first ensured update sent searchapi wouldnt point importing data would immediately become three way data get rummager publishingapi via rabbitmq searchadmin http whitehall http publishingapi update already handled setting searchapi similar way rummager handled http update traffic replay traffic sent rummager also sent searchapi reliable occasionally dropped document case resending document whitehall rummager made also appear searchapi data import script fetch document elasticsearch transform new singletype format insert elasticsearch elasticsearchmigrationhelpers created fresh search index ran import script replayed update missed due running switching application handled application switchover plek gave searchusing application new parameter puppet specify url set plekservicerummageruri plekservicesearchuri environment variable could configure hieradata allowing application switched independently application configured environment switched environment independently constraint order change application update search done application query search avoid inconsistent state thing querying rummager thing updating searchapi production switchover divided application riskiness collection licencefinder finderfrontend contenttagger hmrcmanualsapi searchadmin whitehall frontend backend set rummager xray recording verify monitoring still talking staging teething problem discovered significant problem manual testing staging delayed production rollout week strange result ordering resolved switching back classic text similarity back string field mentioned detail every query returned every best bet due mistake made combining type index would automatically unlock due aws process run every four minute locking index cluster unhealthy unlocking healthy changed readonlyallowdelete introduced benign potentially confusing race condition importing page traffic data reindexing new schema issue commented code switch alias without lock since readonlyallowdelete prevents alias changed page traffic loader daily process wont race condition switch alias without lock since readonlyallowdelete prevents alias changed running schema migration traffic must represented anyway race condition irrelevant equivalent synonym expanded didnt figure happening default configuration expand equivalent synonym configuration overrided problem fixed turning equivalent synonym explicit mapping query would throw bad request error best bet analysis also didnt figure happening possibly problem elasticsearch ruby library unsuccessful replicating problem curling cluster directly problem solved handling exception production teething problem encountered issue switching production suspect caught staging staging doesnt publishing activity also possibility traffic replay staging set elasticsearch performance issue query queueing elasticsearch didnt realise problem first due unfamiliarity new metric ended doubling size cluster also switching faster data node long slow query slow query log revealed sometimes getting character query would take second execute changed searchapi reject query character length finderfrontend truncate query probably also problem elasticsearch elasticsearch error error due unmapped type sorting query multiple index field exist index saw many error trying sort field present govuk index fine result govuk index error frequent obscured actual problem changed query searchapi generates include default sort behaviour missing field sorting end probably also problem elasticsearch searchapi performance issue two search machine rather three provisioned terraform configuration aws search machine created two machine whreas three carrenza searchapi could handle two third traffic rummager initially bumped unicorn worker aws search machine half added missing third machine realised problem failing generate sitemap file aws search machine running memory trying generate sitemap file working one point stopped changed sitemap file link per file rather revealed bug would eventually hit anyway sitemap generation failed sitemap file bug fixed data sync production staging integration elasticsearch snapshot data sync three snapshot repository backed bucket govukproduction backed govukproductionelasticsearchmanualsnapshots govukstaging backed govukstagingelasticsearchmanualsnapshots govukintegration backed govukintegrationelasticsearchmanualsnapshots elasticsearches write read repository production writes govukproduction staging read govukproduction writes govukstaging integration read govukstaging writes govukintegration sometimes staging writes metadata file production bucket integration writes metadata file staging bucket cant avoided elasticsearch requires write access snapshot repository even ever restores snapshot lambda fix object permission happens taking restoring snapshot triggered govukenvsync script terraform provision bucket cant tell elasticsearch python script python import import sys import boto import request requestsawsauth import awsauth host httpelasticsearch region euwest service credential botosessiongetcredentials awsauth awsauthcredentialsaccesskey credentialssecretkey region service sessiontokencredentialstoken def registerrepositoryname rolearn deletefirstfalse printname url host snapshot name deletefirst requestsdeleteurl rraiseforstatus printrtext payload type setting bucket name elasticsearchmanualsnapshots region region rolearn rolearn header contenttype applicationjson requestsputurl authawsauth jsonpayload headersheaders rraiseforstatus printrtext deletefirst deletefirst osenviron sysargv integration rolearn arnawsiamroleblueelasticsearchmanualsnapshotrole registerrepositorygovukintegration rolearn deletefirstdeletefirst write registerrepositorygovukstaging rolearn deletefirstdeletefirst read elif sysargv staging rolearn arnawsiamroleblueelasticsearchmanualsnapshotrole registerrepositorygovukstaging rolearn deletefirstdeletefirst write registerrepositorygovukproduction rolearn deletefirstdeletefirst read elif sysargv production rolearn arnawsiamroleblueelasticsearchmanualsnapshotrole registerrepositorygovukproduction rolearn deletefirstdeletefirst write else printexpected one integrationstagingproduction dockerising development cant mange elasticsearch puppet due version constraint upgrading puppet upgrade eventually elasticsearch far much work dockerised elasticsearch development data replication process changed download govukintegrationelasticsearchmanualsnapshots bucket copy docker container restore latest snapshot