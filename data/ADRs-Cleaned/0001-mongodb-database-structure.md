mongodb database structure record event mongodb specific structureschema cloudevents persisted like event collection database json specversion aae source httpname type orgoccurrentdomainnamedefined datacontenttype applicationjson dataschema httpsomeschemacomschemajson subject name time data timestamp name name streamid streamid note streamid added extension mongodb event store order read event particular stream stream consistency enabled another collection stream consistency collection also written database json streamid version appending cloud event stream consistency stream maintained comparing version supplied user version present dont match cloud event written also two thread writing stream one run error mean retry optimistic locking work transaction required another previous approach instead store event like json streamid version event specversion aae source httpname type orgoccurrentdomainnamedefined datacontenttype applicationjson subject name time data timestamp name name event stored inside single document several benefit approach transaction required java eventcollectionupdateoneandeqid streamid eqversion expectedstreamversion combinepusheachevents serializedevents setversion expectedstreamversion new updateoptionsupserttrue read could done streaming fashion even though event stored subarray aggregation subscription could take listcloudevent event written transaction event store approach subscription get notified event consumer reassemble transaction somehow major drawback approach however two major drawback lead approach there document size limit mongodb approach wouldnt work large stream much hard implement queriesfilters subscription aggregation support limited working subscription preventing simple filter would much simpler unwind supported since could flatten event subarray applying query something like unwindevents replacerootevents matchfilterapplytype item another problem subscription format document created content specified fulldocument property different property document updated thus filterquery would consider case difficult new approach queryfilter much easier since care insert consequence unfortunately implementation must make transaction consistency consistency required application turnedoff streamconsistencyguaranteenone transaction required however mode store stream version