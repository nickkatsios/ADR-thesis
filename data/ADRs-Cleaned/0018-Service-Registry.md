service registry existing behavior device service registry client interface usage core support service security proxy setup history problem statement reference approved tsc vote edgex system may run optional service registry see related adr registryrefactor controlled perservice basis via rregistry commmand line purpose adr base assumption registry enabled service default service registry edgex consul hashicorp consul also default configuration provider edgex adr meant address current usage registry edgex service particular whether edgex service registry determine location peer service static perservice configuration reason investigated proposal edgex away registry functionality current implementation considered secure due current configuration consul latest version edgex hanoi according original service name design document written california release edgex edgex foundry microservices able accomplish following task register configurationregistration referred simply registry rest document provider today consul respond availability request respond shutdown request cleaning resource orderly fashion unregistering registry get address host port another edgex microservice service name registry enabled purpose design ensure service advertise location rest system first self registering service registry including consul implement sort health check mechanism service failing one health check registry stop reporting availability queried note design specifically excludes device service service lookup core metadata maintains persistent store deviceservice object provide service location device service existing behavior section document existing behavior hanoi version edgex device service device virtuals behavior first tested edgexfoundry snap configured always registry following sudo snap install edgexfoundry varsnapedgexfoundrycurrentconfigdevicevirtualresconfigurationtoml edited file removing clientdata section completely copied file back place next enabled devicevirtual monitoring journal output sudo configurationtoml varsnapedgexfoundrycurrentconfigdevicevirtualres sudo snap set edgexfoundry devicevirtualon following error seen journal levelinfo appdevicevirtual sourcehttpservergo msgweb server starting error fatal error host setting core data client configured next followed step instead completely removing client instead set client port invalid value case service logged following error exited levelerror appdevicevirtual sourceservicego msgdeviceservicforname failed get httplocalhostapivdeviceservicenamedevicevirtual dial tcp connect connection refused levelerror appdevicevirtual sourceinitgo msgcouldnt register metadata service get httplocalhostapivdeviceservicenamedevicevirtual dial tcp connect connection refusedn note order run second test easiest way remove reinstall snap manually wiping devicevirtuals configuration consul could also stopped service modified configuration directly consul restarted service registry client interface usage next service usage gomodregistry client interface examined type client interface register current service registry discover health check register error unregisters current service registry discover health check unregister error simply check registry running configured url isalive bool get service endpoint information target registry getserviceendpointserviceid string typesserviceendpoint error check registry target service available registered healthy isserviceavailableserviceid string bool error summary device service started registry flag set device sdks register registry startup unregister registry normal shutdown sdk devicesdkgo query registry check dependent service availability health via isserviceavailable startup regardless registry setting sdk always source address dependent service client configuration stanza sdk query registry address dependent service ping service directly determine availbility health core support service approach core support service reviewing usage gomodbootstraps client interface ironically sma seems service edgexgo actually query registry service location internalsystemagentgetconfigexecutorgo err eregistryclientgetserviceendpointservicename internalsystemagentdirectmetricsgo err mregistryclientgetserviceendpointservicename summary smas configuration metric logic core support service behave manner devicesdkgo note sma also longstanding issue continuousy log error one support service running described issue could avoided sma registry determine service actually available see related issue look driving default service list via configuration security proxy setup securityproxysetup service also relies static service address configuration configure server route service accessible api gateway aka kong although tomlbased client config key service configuration value ever read securityproxysetups local configurationtoml file security service never supported configuration provider aka consul note another point worth mentioning respect security service geneva hanoi release service health check registered service associated isserviceavailable method orchestrate ordered startup security service via set consul script additional orchestration performed edgex deployed via docker slated removed part ireland release history bit research reaching far back california release edgex ive managed piece together current implementation work way history focues solely core support service california release edgex released june first include service written version edgex well version fuji release relied bootstrapping service called coreconfigseed responsible seeding configuration core support service consul prior service started release actually preceded usage toml configuration file instead flat keyvalue format key converted legacy java property name metadbdeviceurl camelpascalcase metadeviceserviceurl chose config key mentioned purpose metadeviceurl httpedgexcoremetadataapivdevice config key provide address core metadata also provided path specific rest endpoint later release edgex address service specific endpoint path decoupled instead following service name design finalized two month earlier initial implementation followed legacy java implementation initialized service client required rest endpoint belonging another edgex service directly associated url config key read consul enabled directly configuration file shared client initialization code also created endpoint monitor goroutine passed channel channel service receive update rest api endpoint url monitor goroutine effectively polled consul every became configurable later version client service address change detected would write updated endpoint url given channel effectively ensuring service started new url wasnt till late geneva development cycle noticed log message made aware fact every one service making rest call check address service endpoint every every rest endpoint issue filed httpsgithubcomedgexfoundryedgexgoissues client monitoring removed part geneva release problem statement fundamental problem existing implementation decribed much duplication configuration across service instance core data service port easily changed passing environment variable serviceport service startup override configuration read configuration provider cause core data listen new port however impact service core data client config read configuration provider excluding securityproxysetup mean order change service port environment variable override clientscoredaraport set every client service well securityproxysetup required update core support securityproxysetup service gomodregistrys clientgetserviceendpoint method started registry determine service dependency available returned address information initialize client endpoint setup correct route case proxysetup change also applied app function sdk device sdk minor change required device sdk see previous commments current implementation note design work service registration occurs service initializes client instance core data core metadata depend thus defer service registration till client initialization neither able successfully lookup address service consquences one impact since securityproxysetup service currently run core support service started would possible implement proposal without also modifying service lazy initialization api gateway route implementation adr require design work respect securityproxysetup issue include splitting configuration api gateway service route intialization logic either making service longrunning splitting route initialization service handling registry nonregistry scenario add registry commandline support securityproxysetup handling change service address information dynamically update api gateway route ifwhen service address change finally proxysetups configuration updated route entry servicekeys instead arbitrary name routecoredata routecoredata reference adr registryrefactor consul service name design