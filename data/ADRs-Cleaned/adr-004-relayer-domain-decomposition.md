adr relayer domain decomposition changelog initial sketch dependency outline update based sketch reviewed ibc handler query relayer defined loosely spec goal adr provide clarity around basic domain object perspective relayer interface well dependency order guide implementation success criterion decomposition well tested expected decomposition lend tight unit test allowing collaborator make change code base confidence decomposition motivated want test mock exercise core logic want able test following highlevel function client create update different chain state connection handshake different chain state channel setup different chain state datagram construction different chain state datagram transaction batching signing datagram submission different chain state missing client update missing proof handler datagrams chain state event handling batch datagrams different chain state specifically key value store produce event dependency section map operation performed different stage relayer ibc handler give outline lowlevel operation dependency mocked test stage isolation inform design various trait needed mock stage listed operation dependency outlined cover possible dependency stage initializing connection relayer relayer configuration relayertoml query chain commitment prefix abci query send msgconnectionopeninit message chain transaction connopeninit handler provable store private store updateibcclient relayer get latest height chain query get client consensus state chain query get latest header minimal set chain light client verify client state proof prover create submit datagrams update view message builder transaction replace full node full node peerlist create submit proof fork fork evidence reporter wait updateclient event event subscription pendingdatagrams relayer build datagrams required given onchain state connection datagrams get connection object chain query get connection object chain query get proof connection state init chain query prover light client get proof client state consensus state chain query prover light client involves querying chain get headerminimal set verify proof build next message connection handshake connopentry message builder channel datagrams built similarly packet datagrams triggered event detailed link section ibc module every transaction block height call appropriate handler realized routing submodule handler succeeds transaction abort apply update keyvalue store provable private also get current height emit appropriate event object main domain object relayer foreignclient connection channel created concrete type contain configuration object relayers representation different part state two chain dependency type indicate runtime dependency chain state instance object parameterized foreignclient type connection precondition runtime completed client creation operating object chainhandle chainhandle trait local representation chain state relayer api chainhandle provides reliable access chain state whether crashed constructed queried envision mock version chain test handler relayer logic method set chainhandle trait reflect specific intermediate representation query light client verification concern internal chain handle implementation exposed via api user chainhandle implementation relayer method assume verified data receive error act appropriately rust trait chainhandle generate packet createpacketself event ibcevent result fetch height ibc client hosted chain query consensusstate src dst query highest consensusstate verify light client return height getheightself client foreignclient resultheight chainerror submit transaction chain underlying full node submitself transaction encodedtransaction result chainerror connection rust impl connection new chaina chainhandle chainb chainhandle foreignclienta foreignclient foreignclientb foreignclient config connectionconfig resultconnection error establish connection chaina chainb via handshake first version completely synchronous blocking call channel rust impl channel new chaina chainhandle chainb chainhandle connection connection config channelconfig resultchannel error establish channel two module handshake link link object connects two specific module separate chain link responsible relaying packet chaina chainb therefore unidirectional single relayer process able support multiple link instance link run thread link depend foreignclients connection channel rust struct link srcchain chainhandle dstchain chainhandle channel channel impl link newchannel channel config linkconfig link relay link specific packet srcchain dstchain expect run thread runself error let subscription selfsrcchainsubscribeselfchannel targetheight event subscriptioniter let datagrams eventsmapevent datagrampacketselfdsrcchainbuildpackettargetheight event attempt selfconfigsubmissionattempts let currentheight selfdstchaingetheightselfconnectionchannelforeignclient let signedheaders selfsrcchaingetminimalsetcurrentheight targetheight let mut attemptdatagrams datagramsclone attemptdatagramspushdatagramclientupdatclientupdatenewsignedheaders let transaction transactionnewdatagram selfdstchainsubmittransactionsignencode example main example initializing single link two chain chain runtime expose handle communicate runtime different thread dependency foreignclients connection channel link encoded type system construction reflects corresponding handshake protocol completed successfully rust main result box let srcchain chainruntimenew let dstchain chainruntimenew chain expose handler commuicating chain related runtime move thread let srcchainhandle srcchainhandle threadspawnmove srcchainrununwrap let dstchainhandle dstchainhandle threadspawnmove return dstchainrununwrap let srcforeignclientondst foreignclientnew srcchainhandle dstchainhandle let dstforeignclientonsrc foreignclientnew srcchainhandle dstchainhandle let connection connectionnew srcchainhandle dstchainhandle dstforeignclientonsrc srcforeignclientondst connectionconfigdefaultunwrap let channel channelnew srcchainhandle dstchainhandle connection channelconfigdefaultunwrap let link linknew srcchainhandle dstchainhandle channel linkconfigdefault linkrun first implementation consequence positive clean abstraction isolation handshake correct construction sane error handling negative neutral reference