udfs implemented proposed adam gibson jan discussed paul dub finalized adam gibson feb user able define custom operation samediff including custom gradient currently defining userdefined function udf properly integrated samediff requires handling multiple aspect system registering operation importclassmappings operation registry implementing special code path operation executioner support calling userdefined code implementing special code path serialization correctly load samediff graph operation making direct function call samediff properly register operation part graph proposal support custom udfs samediff following component created operation type flatbuffersmapper saving graph know save load udfs base class extending dynamiccustom clear method constructor override defining custom operation execution method user pass relevant input operation executioner instead accessing lowlevel code hook samediff register udf sdudf annotation subclass scanner discover register userdefined operation relevant area importclassmappings component work together allow following scanning annotation discover register userdefined operation operation registry user extending base class create custom udfs integrating udfs samediff registering operation graph example java java samediff samediffcreate userdefinedcustomop userdefinedcustomop sdvariable opoutputs sddoudfuserdefinedcustomop operation registered saved loaded graph like operation dynamic creation operation via reflection graph loaded annotation scanning example java userdefinedop annotation discovering custom ops register public class testaddudf extends userdefinedcustomop class extend empty constructor creating graph flatbuffers underlying orgndjautodiffsamediffserdeflatbuffersmapper public testaddudf super constructor whatever user wish custom ops usually take samediff instance one sdvariable args minimum component instantiate call super properly configure within samediff graph passed public testaddudfsamediff samediff sdvariable arg supersamediff arg public testaddudfsamediff samediff sdvariable args supersamediff args calculate output variable registering graph override public listdatatype calculateoutputdatatypeslistdatatype datatypes user must implement method samediff determine number output variable needed cant determined getnumoutputs return arraysaslistdatatypesget override public void setpropertiesforfunctionmapstring object property user define property field must implement method propertiesforfunction create scratch savingloading model override public mapstring object propertiesforfunction return property field java class map property value field property optional may needed depending property end passed underlying iarguments targuments associated data structure inherited dynamiccustomop return collectionsemptymap override public int getnumoutputs return number output variable number output user sdvariableeval call return int determine number output return override public string opname name required proper registration registry return testaddudf override public void configurefromarguments hook configuring creation configuration specified argument ints floatsdoubles input variable argument referenced underlying argument get passed every ops including iarguments targuments darguments inputarguments outputarguments override public void configurewithsamediffsamediff samediff thissamediff samediff implemented method handling initialization created initiate value relevant samediff metadata obtaining input output argument metadata sdvariable found args override public boolean isinplacecall indicates whether input also output note extra care taken avoid bug operation inplace particularly important input operation view return false override public listlongshapedescriptor calculateoutputshape describes calculate output shape based input note calculateoutputshape called dynamically creating output array store result operation execution called operation inplace return arraysaslistinputargumentsgetshapedescriptor override public listlongshapedescriptor calculateoutputshapeopcontext describes calculate output shape based input operation note calculateoutputshape called dynamically creating output array store result operation execution different method input obtained operation instead operation called operation inplace return arraysaslistocgetinputarraysgetshapedescriptor override public listsdvariable dodifflistsdvariable dodiff method must implemented user operation training return one gradient input return new addbpopsamediff larg rarg fgetoutputs override public void exec exec method operation consisting operation execution setting output operation addop addop new addop addopaddinputargumentinputargumentsget inputargumentsget ndjgetexecutionerexecaddop thisoutputargumentsaddalladdopoutputarguments override public void execopcontext opcontext exec method operation consisting operation execution setting output operation ndjgetexecutionerexecnew addop opcontext definition user pas created instantiated object long annotated properly integrated samediff graph executing special code path executioner call exec execopcontext consequence advantage allows user define ops make optimization introduce custom ops within samediff augments model import combining annotation scanning model import annotation registration udfs similar annotation disadvantage bit lower level mean user misuse api encounter bug might otherwise ops maintained core framework