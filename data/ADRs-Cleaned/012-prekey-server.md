adr prekey server order send offline message responder obtain cryptographic key initiator engage noninteractive dake cryptographic key distributed prekey ensemble made public untrusted prekey server participant identified identity underlying network like alicexmpporg xmpp network network assume everything participant required know want send message mind clientserver architecture prekey server instance must offer following service user receive client profile prekey profile set prekey message store inform operation failed successful deliver prekey ensemble previously stored inform publisher many prekey message stored inform retriever prekey ensemble value specific party publish client profile prekey profile set prekey message participant deniably authenticates prekey server interactive dake sends value stored published prekey server prekey server associate prekeys received identity sender identify prekey server obtain prekey ensemble participant asks prekey server prekey ensemble particular identity server delivers one prekey ensemble instance tag longterm public key know particular identity notation following notation represent three value stored prekey server identity identity client profile identity prekey profile identity prekey message publish client profile prekey profile prekey message initiator start interactive dake prekey server initiator sends client profile prekey profile set prekey message published server server store valid nonexpired client profile prekey profile prekey message associate publisher identity prekey ensemble retrieval scenario server must deliver one prekey ensemble multiple prekey message available identity instance tag given server following value stored identity client profile instance tag identity prekey profile instance tag identity prekey message instance tag identity prekey message instance tag participant asks prekey server indentity prekey server send one following prekey message along client profile prekey profile identity client profile instance tag prekey profile instance tag prekey message instance tag scenario server must deliver additional prekey ensemble multiple instance tag found identity given server following prekey message stored identity client profile instance tag identity client profile instance tag identity prekey profile instance tag identity prekey profile instance tag identity prekey message instance tag identity prekey message instance tag participant asks prekey server identity prekey server send two prekey ensemble identity client profile instance tag prekey profile instance tag prekey message instance tag identity client profile instance tag prekey profile instance tag prekey message instance tag receiving prekey ensemble client trust prekey server always return valid prekey ensemble must validate client find usable prekey ensemble value prekey server response may perform additional request receiving multiple prekey ensemble client group received prekey ensemble instance tag group longterm public key choose group one latest expiry time must done avoid sending multiple offline message instance tag there still multiple prekey ensemble filtering duplicate instance tag client decide client offline message sent even send client may inform user sending offline encrypted message multiple instance tag ask user many possible action taken client decides send offline encrypted message multiple instance tag also decide either keep multiple conversation established publisher one received prekey ensemble always terminate conversation offline message sent notice attacker impersonates publisher identity prekey server someone example steal xmpp password publish new client profile new longterm public key prekey profile prekey message guarantee receive copy every encrypted offline message sent retriever notice although attacker profile expire consequence prekey server subject attack untrusted furthermore send expired prekey ensemble send incomplete value send anything retriever client expected keep mind working prekey server