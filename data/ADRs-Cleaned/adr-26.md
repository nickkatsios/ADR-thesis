nats authorization callouts metadata value author derekcollison implemented tag server problem statement enable external nats service generate nats authorization credential authenticating connection request overview document describes implementation serversigned authorization request mechanism mechanism server configuration operator mode server server client connects send authorization request includes information client server client set include traditional authentication parameter username password token nkeys jwt credential may also include information fully signed client certificate presented connect call authorization request sent sysrequserauth default account named account server configuration mode operator mode utilize public connected account request signed server nkey encrypted configured response request signed user jwt must signed declared issuer server configuration mode account signing key operator mode request encrypted response also encrypted issuing server request contain public user nkey required subject user jwt response authorization service request client bound different account detail security main security concern auth callout proposal spoofing request response address concern request sent server signed server nkey encrypted request also contain public user nkey must subject response response user jwts signed account nkey encrypted server configured authorization callout issuer public account nkey server configuration mode response must signed issuer subject must public user nkey request operator mode response must signed account bound client server generate server keypair xkey keypair startup sign optionally encrypt authorization request server receives client connection request call authorization service signed request needed request signed server sent sysrequserauth subject subject automatically protected system user authorization callout account good pattern follow authorization service run isolated account since system bind user authorized account example given configuration server conf listen servername authorization timeout user user auth password pwd authcallout issuer abjhlovmpacirklngobgslniyioupajcyfndlqviobyqguwvla authusers auth setup user global account user auth predefined allowed number user usernamepassword nkeys mix since authorization callout section list user auth authuser callout mechanism user user callout service note even server configures user system authenticates user unless specified authusers callout service called regardless also since callout configuration specify account default global account hence account allow user send sysrequserauth request signed server currently authorization request jwt claim includes client information known server passed client application including authentication optionally information client certificate also set public user nkey response server would accept assist replay attack authorization service example matching server configuration user try connect following err natsconnectsclienturl natsuserinfodlc zzz auth request json aud abjhlovmpacirklngobgslniyioupajcyfndlqviobyqguwvla exp jti whcqeyrnoblcjmriyyenmqegjcktudffrlfhzoseq iat nbfcqybgnxslagzyuxqzkkifukvdzclrniusjtwewkqv sub natsuserauthrequest nats clientinfo clienttype nats host kind client lang rtt server start user dlc ver clientopts echo true header true lang name noresponders true pas zzz pedantic false protocol tlsrequired false user dlc verbose false version usernkey ubomqvtqtvirvxftezoacmwlocmcdmawnqvnpinjhtvdron serverid host nbfcqybgnxslagzyuxqzkkifukvdzclrniusjtwewkqv name version application receive encoded authorization claim jwt decode proving server nbfcqybgnxslagzyuxqzkkifukvdzclrniusjtwewkqv properly signed claim response signed authorizationresponse user jwt error message authorized signing key must private key authorization callout issuer account operator mode also subject must public user nkey presented request audience aud public key issuing server public account key seen audience request usernkey represents required subject signed user jwt response server make sure response well formed properly signed possessor private account key changing account response authorization request override account request processed example authorization service could set handle authorization request determine account user assigned primarily applicable server configuration mode also operator mode operator mode account enables authorization callouts specify account client assigned response user jwt must signed private key one account server verify owner new bound account authorized switch client certificate authorization request contain information state include cipher version well client certificate specified verified certificate included pemencoded format along verified chain client certificate specified verified also included pemencoded format example part client request conf clienttls cipher tlsaesgcmsha verifiedchains begin certificatenmiidgzccamugawibagiuxshjkqxwgrhqntatdptokwdqyjkozihvcnaqelnbqawtdekmcigauechmbuluywrpysbdbtdwpyfawucybjbmmumrawdgydnvqqlewdoqvrtlmlvmriweaydvqqdewlsbnhbghvcqwhhcnmtkwmjamtkodawnwhcnmjqwmjazmtkodawwjalmqwcwydvqqlewrdtkngmrqwegydvqqdewtlegftncgxllmnvbtccasiwdqyjkozihvcnaqebbqadggepadccaqocggebakubuojfovnddqrknluumbtvnuradjbgksueibjfrvwcsfevzlrvghlrzamnnqulnwhbbamtkmbjnrqqlcjjeksbmgnwuotthepldsrectrswhxhclpnhbfvyqjanhoxujwyizzdozzsmzaixpfxigxgrbbvgwsxeygkdgzjrcfbnfzyqqsettqnokyfptafirwsqsiyyoyjhlqafxgmsmujetdvunmzloofbedrdhalcpeyigreweyhhbwomdtsxxhjptjirqdxtdhzhnepknrwxfcylqccaweaaaobgzcbgdaobgnvhqbafebamcbaawewydvrlbawwcgyinkwybbquhawiwdaydvrtaqhbaiwadadbgnvhqefgquosdpeslaffykfcvscngixvcywhwydvrjbbgwfoaubwbbbhyijdmgkohyjgsswcwydvrrbaqwnaoiamagcsqgsibdqebcwuaaibaqchjrkaiiuexcoakdolowsnibtozbnuxupcoqmyglqedfyhjeyjrwqyzzybvrvbchmtykbxdpkrulczncdivimzgfcbffdxadnejtqgwfptoivwdztjlnwiepurzldzoflrszxnptzbpeetwmjtvckpfluamykctuwbkmybhibnqkuswhzqbldohisybznxzxannupuajnndypeyfdnzcoafcsaumbwxcwyvhezcmazqytjuicngrdzsjpysqkpowiatnzunljzuhdurmfehjaxgbmxnend certificaten begin certificatenmiidadccalcgawibagiuwyrqbloofmuvcvmqhlajokntqwdqyjkozihvcnaqelnbqawtdekmcigauechmbuluywrpysbdbtdwpyfawucybjbmmumrawdgydnvqqlewdoqvrtlmlvmriweaydvqqdewlsbnhbghvcqwhhcnmtkwmjamtkmdawnwhcnmjqwmjazmtkmdawwjbmmsqwigydvqqkexttewhzglhienvbwbmljyxrpnbzieluyyxedaobgnvbastbbvfmuawxejaqbgnvbamtcwxvyfsagzddccnasiwdqyjkozihvcnaqebbqadggepadccaqocggebanryaptdapjcvqkjyjxjnboqgpvgugctnrxopjzvysvvcvatgibqhtymzbfxygzadexotncrcvvsqaemewuyjifdqucgqonfozsywdkytukezdpyvemkhnyqbkbngyauubcnpbspcisgyszllwdjuryjfinrbddmziqklpzpoklzgscxnpqmrihwnznhintzltudjxdbrmavhceegtixwtxihnatkxjeyabsavlnwcaqczbdgmjvgoncnlabpoafbwxngatawpwxstkqeuhsaxahbclnjgjccnaweaaancmeawdgydvrpaqhbaqdagegmagaudewebwqfmambafwhqydvronbbyefgggrovyxzocjticouhrlmagcsqgsibdqebcwuaaibaqbmukijnsarkeosvrduwywahqjdicrhyljzkckcxsiumxlgkgzdprvevymfnnnrhjayizfykfbicmiurnajmqtdmilwezywnbxxsjdivewovyjmptiynkhvcnyugvewuznefiwnlpsihxcdvmyjmjkqwodgkhzbadbbcryadznvoblhtjopqghuwahfntfqcqptatacusfgnenluuxvlbbhzlpmlhroqbiwpayqwneaicjlaqvsdsbryjltizzvvpowiwmutdgfsaltpmucuhopieaacqbnfvlmckcpyejnend certificaten version encryption nkeys support xkeys key compatible nacls seal open function nkeys library automatically handle nonce prevent misuse xkeys enable encryption signing request response authorization service server configuration mode authcallout optionally include public xkey conf authcallout issuer abjhlovmpacirklngobgslniyioupajcyfndlqviobyqguwvla authusers auth xkey xabnanvmnahsqpufrwkkutegzxxabvxvxyqrjgmsczght server see xkey set public xkey server private key asymmetrically encrypt request serverid section request include server public xkey signed also included plaintext header request message key natsserverxkey authorization service also server public key optionally encrypt response operator mode auth account claim include public xkey encrypting account serverid portion externalauthorization property account operator mode auth account claim public xkey encrypting account serverid portion externalauthorization property account