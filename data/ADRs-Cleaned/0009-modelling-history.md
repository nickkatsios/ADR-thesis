modelling history amended content publisher domain model focused storing current information document table store recent content document image table store recent version document image history change stored papertrail intended permanent store presentation document history done via timelineentry model store user something lack detail place richer information required model removal withdrawal associated timelineentry led number pain point user cannot discard new draft published document creating new draft overwrites data stored published edition content publisher cant show accurate link live edition document new draft published document created user cannot edit remove image document first edition published timelineentry model store aspect document state resulting needing queried outside timeline limit flexibility timeline prevents number intended feature content publisher comparing different edition document republishing live content problem currently common support task whitehall publisher showing user change user made particular edit adr proposes change domain model resolve aforementioned pain point provide mean support future intended feature change provide mean store individual edition document revision content document edition held per adr consider sharing data translation document appropriate product common theme immutablity model implicit mean storing history immutability key consideration modelling revision document image adr considers impact storing history timeline topic area usageneed history clear finally adr concludes collated diagram domain model concept core concept document record represents version piece content particular locale many edition time current edition shown content publisher index potentially live edition currently govuk live current edition iteration document content represented revision current edition thus document many revision document mutable entity store data common across edition first publishing expected joining point documentrelated data associated particular edition edition numbered version document expected published govuk associated revision mutable consistent object join immutable data place editionlevel database constraint placed constraint one live edition exist per document supported two edition document share revision allows explicitly reference content support future ability revert document past content revision represents immutable snapshot content document particular point time number indicate revision document store created request user change content result single new revision directly map concept revision time user revise document data outside content state stored revision ensure difference revision represented user anatomy revision model explored document represents state edition hold draft submitted review model coupled concept shown changed user time user change edition new model created user created stored edition one one time data specific explanatory note withdrawal stored specific model associated polymorphic relation allows model removal withdrawal longer responsibility timelineentry initially object intended immutable however may changed change become asynchronous operation single change performed user still represented single record approach mutabilityimmutability number model content publisher defined immutable significantly revision associated model model persisted database never updated deleted change requires creating new record allows store full history appending database simplicity performance consistency rail idiom accessing immutable model intended done foreign key usage select max style query maintains ability regular approach activerecord association mean require existence association specifying foreign key cannot null example modelling mutable edition model reference immutable model revision store content edition accessed consistent primary key revision accessed foreign key stored edition since data mutable model lost model updated data history example store edition held individual model reference edition allows edition reference single replaced history maintained choice immutability strategy store present historical concern way thus ensuring history remains first class citizen nice side effect immutable model open caching since data model never change effectively cached forever breakdown revision revision immutable model store edit document likely large amount often minor difference address revision stored single model instead collection model revision model store little data join model visualised intention breaking conservative amount data duplicated consecutive revision example user edits title edition new contentrevision created existing tagsrevision metadatarevision imagerevisions model associated next revision imagerevision modelled similar way revision explained image modelling intended delegation interfacing revision caller concerned subrevision store particular field allows revision rich interface despite storing low amount data directly image modelling content publisher support user uploading image file referencing revision document metadata editable property user change history stored single image file uploaded produce multiple file uploaded asset manager different sizing variation image modelled similar way revision immutable imagerevision model represented image model continuation image revision known two imagerevisions version item share image association image content publisher url consistently reference image matter revision data imagerevision stored imagefilerevision imagemetadatarevision immutable differ fact change imagefilerevision requires change resultant asset manager file crop dimension whereas imagemetadatarevision store accompanying data doesnt affect asset manager file alt text imagefilerevision associated activestorageblob object responsible managing storage source file also one many association imageasset imageasset represents resultant file uploaded asset manager various image size imageasset model store url asset manager file state file asset manager timeline timelineentry model represents event shown user part visual timeline document history order timeline flexible feature iterated model outside timeline previously model removal withdrawal associated directly timelineentry meant state accessed timeline suggested associated model time writing wasnt yet determined timeline would show therefore wasnt clear exactly best model entry timelineentry modelled speculative way number reference relevant data including polymorphic association flexibility timelineentry model store data could derived aspect document allow ability rebuild timelineentry model timeline changed avoid timeline aspect document state topic data related topic otherwise known govuk taxonomy intended stored content publisher current point time due topic accessed edited directly interacting publishing api application notably content tagger also edit topic consequence publishing api source truth data rather content publisher inconsistency make difficult store history topic reliable way thus determined store past topic content publisher know current topic querying publishing api history topic available collated diagram various aspect collated together represented following somewhat daunting diagram simplified ease reading noticeable omission user model since model creator speculative join timelineentry consequence modelling provide basis provide richer history functionality enable meeting exceeding feature offered whitehall mainstream publisher however come number concern highlighted migrating different database structure change introduced adr fundamental restructuring database nonbackwards compatible process adopting change carry number risk time complexity migrating data one structure another assuming production data development new feature hindered write code work old new data structure likely lead split codebase risk avoided completing migration quickly possible content publisher deployed production avoids migrate user data limit time spent developing old new data structure however would present new risk code quality may reduced sake completing migration left unaddressed may eventually lead technical debt application benefit avoiding data migration split codebase high prioritised concern code quality approach resolve code quality concern identify catalogue particular area concern wall pain trello board finding opportunity work around team priority risk concurrent editing indirect consequence change almost request change state document involve multiple database writes instance editing content edition involve least creating new revision updating edition revision however application receives concurrent write request risk data integrity could comprised example consider edition one revision user submits change content edition user submits change tag edition request creates new revision new content built first revision revision hasnt saved request build new revision also based first revision revision saved set revision edition revision saved set revision edition edits lost protect suggested pessimistic locking whenever mutating data related document typically non gethead request done wrapping code database transaction running select update query load document effect making subsequent locking query wait first transaction completed pessimistic locking scenario would user submits change content edition lock document user submits change tag edition wait document lock released request creates new revision new content built first revision revision saved set revision edition lock document released lock request build new revision based user created revision revision saved set revision edition document lock released revision reflects change consequence application higher vulnerability slow request block edits document increase risk timeout error locking approach provides mean ensure two edits cannot occur concurrently attempt resolve whether form submission considers recent change document example user submits form unbeknownst user changed one field since started editing edits overwrite scenario optimistic locking rail provides mean resolve distinct feature applied content publisher future model problem increase number model developer understand higher barrier entry every action either database query complicated single query look information idea alleviate delegate activerecord make simpler access update data without interacting individual model scope andor find method alleviate join knowledge materialized view search index current live edition data flat form removal past data data model built around expectation history document published govuk something preserved time may lead large amount data usage point future may evaluated whether appropriate form archiving strategy older data