separate attachment content metadata lazy consensus implemented mailbox implementation james store already parsed attachment faster retrieval attachment storage capability required two feature jmap attachment download jmap message search attachment content criterion memory cassandra backends relied upon jmap backend protocol relies dynamic eml parsing expose message subpart imap pojos related attachment attachment hold attachmentid attachment content well content type messageattachment composes attachment disposition within message cid inline name message expose list messageattachment read fetchtype full blob represents downloadable content either attachment message blob byte array payload following class work aforementioned pojos attachmentmapper attachmentmanager responsible storing retrieving attachment content blobmanager jmap allow blob downloads mailbox search expose attachment content related criterion criterion jmap protocol organisation cause attachment content loaded every time message fully read happens instance open message jmap despite fact needed attachment downloadable separate jmap endpoint content attached jmap message json also content loaded allocate memory space store whole attachment suboptimal want keep consumed memory low permessage given server able handle high number message given time noted jpa maildir mailbox implementation support attachment storage retrieve attachment message implementation parse message extract attachment cassandra mailbox prior schema version stored attachment metadata table version relies blobstore store attachment content enforce cassandra schema version james release allows drop attachment management prior version reorganize attachment pojos attachment hold attachmentid content type size longer hold content content loaded attachmentid via attachmentloader api attachmentmanager implement messageattachment composes attachment disposition within message cid inline name blob would longer hold content byte array rather content retriever supplierinputstream parsedattachment direct result attachment parsing composes messageattachment corresponding content byte array class relied upon saving message mailbox output messageparser adjustment needed class working attachment attachmentmapper attachmentmanager allow attachmentid retrieve attachment content inputstream done separate attachmentloader interface attachmentmapper attachmentmanager attachment content persist attachment messagemanager return attachment metadata result append operation inmemoryattachmentmapper store attachment content separately messagestorer take care storing message behalf messagemanager enables determine attachment parsed implementation aware fashion saving attachment parsing upon writes jpa maildir maildir jpa longer support attachment content loading jmap protocol requires attachment content loading supported top technology mailbox search attachment content criterion supported implementation supporting attachment storage consequence user running cassandra schema version prior version james release upgrade version version proceeding update noticed performance enhancement imap fetch jmap getmessages running gatling test suite exercising jmap getmessages dataset containing attachment lead following observation overall better average performance jmap query global improvement sharp decrease tail latency getmessages time faster also expect improvement james memory allocation reference contribution topic also contains benchmark proposal jira