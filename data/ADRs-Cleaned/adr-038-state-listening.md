adr kvstore state listening changelog initial draft introduce plugin system based hashicorpgoplugin add listencommit flatten state writes block single batch remove listener cache store listen rootmultistore remove haltappondeliveryerror error propagated default implementation return nil dont want propagate error update abci proposed abstract adr defines set change enable listening state change individual kvstores exposing data consumer currently kvstore data remotely accessed query proceed either tendermint abci grpc server addition requestresponse query would beneficial mean listening state change occur real time modify commitmultistore interface concrete rootmulti implementation introduce new listenkvstore allow listening state change underlying kvstores dont listen cache store cant sure writes committed eventually writes duplicated rootmultistore eventually listen rootmultistore introduce plugin system configuring running streaming service write state change surrounding abci message different destination listening new file storetypeslisteninggo create memorylistener struct streaming protobuf encoded pair state change kvstore memorylistener internally concrete rootmulti implementation collect state change kvstores memorylistener listens state writes accumulate record memory type memorylistener struct statecache storekvpair newmemorylistener creates listener accumulate state writes memory func newmemorylistener memorylistener return memorylistener onwrite writes state change event internal cache func memorylistener onwritestorekey storekey key byte value byte delete bool flstatecache appendflstatecache storekvpair storekey storekeyname delete delete key key value value popstatecache return current state cache set nil func memorylistener popstatecache storekvpair flstatecache flstatecache nil return also define protobuf type pair addition key value field message include storekey originating kvstore collect information separate kvstores determine source pair protobuf message storekvpair optional string storekey store key kvstore pair originates required bool set true indicates set operation false indicates delete operation required byte key required byte value listenkvstore create new store type listenkvstore rootmulti store wrap kvstore enable state listening configure store memorylistener collect state change output specific destination store implement kvstore interface listening enabled operation traced core kvstore call written underlying listener proper key operation permission type store struct parent typeskvstore listener typesmemorylistener parentstorekey typesstorekey newstore return reference new tracekvstore given parent kvstore implementation buffered writer func newstoreparent typeskvstore psk typesstorekey listener typesmemorylistener store return storeparent parent listener listener parentstorekey psk set implement kvstore interface trace write operation delegate set call parent kvstore func store setkey byte value byte typesassertvalidkeykey sparentsetkey value slisteneronwritesparentstorekey key value false delete implement kvstore interface trace write operation delegate delete call parent kvstore func store deletekey byte sparentdeletekey slisteneronwritesparentstorekey key nil true multistore interface update update commitmultistore interface allow wrap memorylistener specific kvstore note memorylistener attached internally concrete rootmulti implementation type commitmultistore interface addlisteners add listener kvstore belonging provided storekey addlistenerskeys storekey popstatecache return accumulated state change message memorylistener popstatecache storekvpair multistore implementation update adjust rootmulti getkvstore method wrap returned kvstore listenkvstore listening turned store func store getkvstorekey typesstorekey typeskvstore store rsstoreskeytypeskvstore rstracingenabled store tracekvnewstorestore rstracewriter rstracecontext rslisteningenabledkey store listenkvnewstorestore key rslistenerskey return store implement addlisteners manage kvstore listener internally implement popstatecache mean retrieving current state addlisteners add state change listener specific kvstore func store addlistenerskeys typesstorekey listener typesnewmemorylistener range key rslistenerskeysi listener func store popstatecache typesstorekvpair var cache typesstorekvpair range rslisteners cache appendcache lspopstatecache sortslicestablecache funci int bool return cacheistorekey cachejstorekey return cache also adjust rootmulti cachemultistore cachemultistorewithversion method enable listening cache layer func store cachemultistore typescachemultistore store makemaptypesstorekeytypescachewrapper range rsstores store vtypeskvstore wire listenkvstore allow listener observe writes cache store set listener cache store observe duplicated writes rslisteningenabledk store listenkvnewstorestore rslistenersk storesk store return cachemultinewstorersdb store rskeysbyname rstracewriter rsgettracingcontext func store cachemultistorewithversionversion int typescachemultistore error wire listenkvstore allow listener observe writes cache store set listener cache store observe duplicated writes rslisteningenabledkey cachestore listenkvnewstorecachestore key rslistenerskey cachedstoreskey cachestore return cachemultinewstorersdb cachedstores rskeysbyname rstracewriter rsgettracingcontext nil exposing data streaming service introduce new abcilistener interface plug baseapp relay abci request response service group state change abci request baseappstreaminggo abcilistener interface exposing streaming service type abcilistener interface listenfinalizeblock update streaming service latest finalizeblock message listenfinalizeblockctx contextcontext req abcirequestfinalizeblock abciresponsefinalizeblock error listencommit update steaming service latest commit message state change listencommitctx contextcontext abciresponsecommit changeset storekvpair error baseapp registration add new method baseapp enable registration streamingservices setstreamingservice set streaming service baseapp hook load listener multistore func app baseapp setstreamingservices abcilistener register streamingservice within baseapp baseapp pas beginblock delivertx endblock request response streaming service update abci appabcilisteners appendappabcilisteners add two new field baseapp struct type baseapp struct abcilistenersasync determining abcilisteners run asynchronously abcilistenersasyncfalse stopnodeonabcilistenererrfalse listener run synchronized stop node abcilistenersasynctrue stopnodeonabcilistenererr ignored abcilistenersasync bool stopnodeonabcilistenererr halt node abci streaming service listening result error stopnodeonabcilistenererrtrue must paired abcilistenersasyncfalse stopnodeonabcilistenererr bool abci event hook modify finalizeblock commit method pas abci request response streaming service hook registered baseapp func app baseapp finalizeblockreq abcirequestfinalizeblock abciresponsefinalizeblock var abcires abciresponsefinalizeblock defer func call streaming service hook finalizeblock message abcilistener range appabcilisteners ctx appfinalizestatectx blockheight ctxblockheight appabcilistenersasync funcreq abcirequestfinalizeblock abciresponsefinalizeblock err appabcilistenerfinalizeblockblockheight req err nil apploggererrorfinalizeblock listening hook failed height blockheight err err req abcires else err appabcilistenerlistenfinalizeblockblockheight req err nil apploggererrorfinalizeblock listening hook failed height blockheight err err appstopnodeonabcilistenererr osexit return abcires func app baseapp commit abciresponsecommit abciresponsecommit data commitidhash retainheight retainheight call streaming service hook commit message abcilistener range appabcilisteners ctx appdeliverstatectx blockheight ctxblockheight changeset appcmspopstatecache appabcilistenersasync funcres abciresponsecommit changeset storestorekvpair err appabcilistenerlistencommitctx changeset err nil apploggererrorlistencommit listening hook failed height blockheight err err changeset else err appabcilistenerlistencommitctx changeset err nil apploggererrorlistencommit listening hook failed height blockheight err err appstopnodeonabcilistenererr osexit return plugin system propose plugin architecture load run streaming plugins type implementation introduce plugin system grpc load run cosmossdk plugins plugin system hashicorpgoplugin plugin must struct implement pluginplugin interface impl interface processing message grpc plugin must also message protocol defined grpc service streamingpluginsabcipluginversioninterfacego handshake common handshake shared streaming host prevents user executing bad plugins executing plugin directory feature security feature var handshake pluginhandshakeconfig protocolversion magiccookiekey abcilistenerplugin magiccookievalue efdbdfcfca listenerplugin base struct kind goplugin implementation included interface different plugins type abcilistenerplugin struct grpcplugin must still implement plugin interface pluginplugin concrete implementation written plugins written impl baseappabcilistener func listenergrpcplugin grpcserver plugingrpcbroker grpcserver error registerabcilistenerserviceservers grpcserverimpl pimpl return nil func listenergrpcplugin grpcclient contextcontext plugingrpcbroker grpcclientconn interface error return grpcclientclient newabcilistenerserviceclientc nil pluginplugin interface two method client server grpc service grpcclient grpcserver impl field hold concrete implementation baseappabcilistener interface written note plugin implementation written advantage plugin system within plugin author define message protocol way fit case example state change listening desired abcilistener message protocol defined illustrative purpose state change listening desired listencommit omitted protocol protobuf syntax proto message empty message listenfinalizeblockrequest requestfinalizeblock req responsefinalizeblock message listencommitrequest int blockheight responsecommit repeated storekvpair changeset plugin listens state change service abcilistenerservice rpc listenfinalizeblocklistenfinalizeblockrequest return empty rpc listencommitlistencommitrequest return empty protobuf plugin doesnt listen state change service abcilistenerservice rpc listenfinalizeblocklistenfinalizeblockrequest return empty rpc listencommitlistencommitrequest return empty implementing service streamingpluginsabcipluginversiongrpcgo var baseappabcilistener grpcclientnil grpcclient implementation abcilistener abcilistenerplugin interface talk rpc type grpcclient struct client abcilistenerserviceclient func grpcclient listenfinalizeblockgoctx contextcontext req abcirequestfinalizeblock abciresponsefinalizeblock error ctx sdkunwrapsdkcontextgoctx err mclientlistendelivertxctx listendelivertxrequestblockheight ctxblockheight req req return err func grpcclient listencommitgoctx contextcontext abciresponsecommit changeset storestorekvpair error ctx sdkunwrapsdkcontextgoctx err mclientlistencommitctx listencommitrequestblockheight ctxblockheight changeset changeset return err grpcserver grpc server grpcclient talk type grpcserver struct real implementation impl baseappabcilistener func grpcserver listenfinalizeblockctx contextcontext req listenfinalizeblockrequest empty error return empty mimpllistenfinalizeblockctx reqreq reqres func grpcserver listencommitctx contextcontext req listencommitrequest empty error return empty mimpllistencommitctx reqres reqchangeset precompiled plugin implthis plugins written streamingpluginsabcipluginversionimplplugingo plugins precompiled loaded plugin system abcilistener implementation baseappabcilistener interface type abcilistener struct func abcilistenerplugin listenfinalizeblockctx contextcontext req abcirequestfinalizeblock abciresponsefinalizeblock error send data external system func abcilistenerplugin listencommitctx contextcontext abciresponsecommit changeset storestorekvpair error send data external system func main pluginservepluginserveconfig handshakeconfig grpcabcivhandshake plugins mapstringpluginplugin grpcpluginv grpcabcivabcilistenergrpcpluginimpl abcilistenerplugin nonnil value enables grpc serving streaming grpcserver plugindefaultgrpcserver introduce plugin loading system return interface error provides advantage versioned plugins plugin interface grpc protocol change time addition allows building independent plugin expose different part system grpc func newstreamingpluginname string loglevel string interface error logger hclognewhclogloggeroptions output hclogdefaultoutput level tohcloglevelloglevel name fmtsprintfplugins name host start launching streaming process env osgetenvgetpluginenvkeyname client pluginnewclientpluginclientconfig handshakeconfig handshakemapname plugins pluginmap cmd execcommandsh env logger logger allowedprotocols pluginprotocol pluginprotocolnetrpc pluginprotocolgrpc connect via rpc rpcclient err clientclient err nil return nil err request streaming plugin return rpcclientdispensename propose registerstreamingplugin function app register newstreamingplugins apps baseapp streaming plugins type therefore function take interface concrete type example could plugins abcilistener wasmlistener ibclistener note registerstreamingpluing function helper function requirement plugin registration easily moved app baseapp directly baseappstreaminggo registerstreamingplugin register streaming plugins app method return error plugin supported func registerstreamingplugin bapp baseapp appopts servertypesappoptions key mapstringtypeskvstorekey streamingplugin interface error switch streamingplugintype case abcilistener registerabcilistenerpluginbapp appopts key default return fmterrorfunexpected plugin type return nil func registerabcilistenerplugin bapp baseapp appopts servertypesappoptions key mapstringstorekvstorekey abcilistener abcilistener asynckey fmtsprintfsss streamingtomlkey streamingabcitomlkey streamingabciasync async casttoboolappoptsgetasynckey stopnodeonerrkey fmtsprintfsss streamingtomlkey streamingabcitomlkey streamingabcistopnodeonerrtomlkey stopnodeonerr casttoboolappoptsgetstopnodeonerrkey keyskey fmtsprintfsss streamingtomlkey streamingabcitomlkey streamingabcikeystomlkey exposekeysstr casttostringsliceappoptsgetkeyskey exposedkeys exposestorekeyssortedexposekeysstr key bappcmsaddlistenersexposedkeys appsetstreamingmanager storetypesstreamingmanager abcilisteners storetypesabcilistenerabcilistener stopnodeonerr stopnodeonerr func exposealllist string bool ele range list ele return true return false func exposestorekeyskeysstr string key mapstringtypeskvstorekey typesstorekey var exposestorekeys typesstorekey exposeallkeysstr exposestorekeys maketypesstorekey lenkeys storekey range key exposestorekeys appendexposestorekeys storekey else exposestorekeys maketypesstorekey lenkeysstr keystr range keysstr storekey keyskeystr exposestorekeys appendexposestorekeys storekey sort storekeys deterministic output sortslicestableexposestorekeys funci int bool return exposestorekeysiname exposestorekeysjname return exposestorekeys newstreamingplugin registerstreamingplugin function register plugin apps baseapp newsimapp func newsimapp logger loglogger dbmdb tracestore iowriter loadlatest bool appopts servertypesappoptions baseappoptions funcbaseappbaseapp simapp key sdknewkvstorekeys authtypesstorekey banktypesstorekey stakingtypesstorekey minttypesstorekey distrtypesstorekey slashingtypesstorekey govtypesstorekey paramstypesstorekey ibchoststorekey upgradetypesstorekey evidencetypesstorekey ibctransfertypesstorekey capabilitytypesstorekey register streaming service streamingcfg casttostringmapappoptsgetbaseappstreamingtomlkey service range streamingcfg pluginkey fmtsprintfsss baseappstreamingtomlkey service baseappstreamingplugintomlkey pluginname stringstrimspacecasttostringappoptsgetpluginkey lenpluginname loglevel casttostringappoptsgetflagsflagloglevel plugin err streamingnewstreamingpluginpluginname loglevel err nil tmosexiterrerror err baseappregisterstreamingpluginbapp appopts key plugin err nil tmosexiterrerror return app configuration plugin system configured within apps toml configuration file toml grpc streaming streaming abci streaming service streamingabci plugin version abci listening plugin abciv list store key listen state change set expose key key enable abcilisteners run asynchronously abcilistenersasyncfalse stopnodeonabcilistenererrfalse listener run synchronized stop node abcilistenersasynctrue stopnodeonabcilistenererr ignored async false whether stop node message deliver error stopnodeonerr true four parameter configuring abcilistener plugin streamingabciplugin streamingabcikeys streamingabciasync streamingabcistopnodeonerr streamingabciplugin name plugin want streaming streamingabcikeys set store key store listens streamingabciasync bool enabling asynchronous listening streamingabcistopnodeonerr bool stop node true operating synchronized mode streamingabciasyncfalse note streamingabcistopnodeonerrtrue ignored streamingabciasynctrue configuration support additional streaming plugins adding plugin streaming configuration section registering plugin registerstreamingplugin helper function note plugin must include streamingserviceplugin property requirement lookup registration plugin app property unique individual service encoding decoding stream adr introduces interface type streaming state change kvstores associating data related abci request response registering service consuming data streaming destination final format instead prescribing final data format adr left specific plugin implementation define document format take approach flexibility final format necessary support wide range streaming service plugins example data format streaming service writes data set file differ data format written kafka topic consequence change provide mean subscribing kvstore state change real time backwards compatibility adr change commitmultistore interface implementation supporting previous version interface support new one positive ability listen kvstore state change real time expose event external consumer negative change commitmultistore interface implementation neutral introduces additional optional complexity configuring running cosmos application application developer opts feature expose data aware ramificationsrisks data exposure pertains specific application