rule organizing command actor api code submitted several year ago cli team began refactoring legacy codebase place converting command one time acceleration team vat created focus finishing cli would primarily capi endpoint picked pattern introduced part refactors began applying new command ported architecture inherited looked roughly like command layer life command directory commandv package contains one filestruct per command vspacequotacommand actor layer life action directory actionvaction package contains roughly one file per api resource method related resource dropletsgo api layer life api directory apicloudcontrollerccv package contains one file per api resource method related hitting capi endpoint porting large number command architecture vat accumulated number small frustration ambiguity architecture left asking question logic live command layer actor layer ccvspace struct vactionspace struct similar often literally alias one another actor method call actor method unit test cant mock actor method level mock underlying api method make test harder reason decided needed come stricter set rule could overlay onto current architecture help resolve question dont keep revisiting rule decided note pattern described already various part codebase consistently might think pickingandchoosing greatest hit piece cli command weve written apilayer rule responsibility api layer also called client layer simplest layer contains package designed hit specific apis commonly one apicloudcontrollerccv contains method hit capi api method layer one thing usually mean make single request api endpoint input method correspond input endpoint take return value correspond return value endpoint time think layer mapping api endpoint client method however permissible add helper method layer long making single request good example getapplicationbynameandspaceguid sort helper needed lot actor method doesnt map directly single endpoint instead map get vapplicationsnamesnamespaceguidsguid good define method api layer mean easily mock unit test actorlayer method resourcelayer rule responsibility resource layer secondsimplest layer new layer extracted api layer life resource directory previously structs modeling api resource defined api layer ccvspacequota api method would return actor layer actor layer would convert actorlayer struct type often done type alias package vaction type spacequota ccvspacequota ccvspacequota actorcloudcontrollerclientgetspacequotaguid return spacequotaccvspacequota cast felt unnecessary amount indirection abstraction struct defined two place nobody could think strong reason plus made api layer unit test fairly large hard read since often testing logic json marshallingunmarshalling test extracting structs resource layer single shared struct definition api resource shared layer api command actor structs defined layer map directly api resource data present resource come back primary api endpoint returned see summary pattern actorlayer example correctly layer also contain json marshallingunmarshalling logic let unittest behavior individually resourcelayer unit test without needing clutter apilayer test simplify field access resource structs flat possible example resourcesapplication spaceguid field api json response data life apprelationshipsspacedataguid handle nestingunnesting field like marshalunmarshal logic layer dont know care specific json representation api give rule thumb word relationship never appear outside resource layer since api implementation detail handling complex marshallingunmarshalling logic jsonry library come quite handy expect resource layer make heavy package finally layer contain method make api request live api layer commandlayer rule responsibility command layer responsible taking user input presenting output user former involves thing like defining validating flagspositional argumentsenvironment variable latter involves formatting printing message stdout stderr command call actor layer real work command make single call actorlayer method command usually give indication creating app myapp space myspace org myorg someuser give indication action succeeded failed table data error message exception rule command perform multiple step example createorg first create org assign current user org manager org two discrete step presented user display successful completion two separate actorlayer call see style guide guideline format command output actorlayer rule responsibility actor layer historically hardest layer explain easiest start describing thing shouldnt responsible see preceding section left layer primarily responsible taking input command layer orchestrating multiple apilayer call necessary packaging multiple response resourcesummary structs returned command layer actorlayer method generally wrap single apilayer call actor method making single call sign probably much work command layer called consider putting work actor method good example something like applyorgquotaorgname string quotaname string method take name resource guids thats typically user provided command layer method probably make series call achieve single goal fetch org name retrieve org guid fetch quota name retrieve quota guid apply quota request two guids command layer pointofview method one thing applying org quota needed orchestrate three api call summary pattern another common category actor method follow summary pattern method read command space might called something like getspacesummary typically command fetch single primary resource like space plus handful related resource route space space parent org actor layer responsible defining struct type contain information actor method return summary struct back command layer handle displaying information appropriately here summary struct might look like package vaction type spacesummary struct space resourcesspace route resourcesroute org resourcesorganization note composed several resource defined resource package resource layer since resource fetched different api endpoint single resource struct contain job actor layer assemble summary struct consequence looked one way rule classify existing code wrong right intended takeaway believe valuable back refactor every place adhering rule often thing amount minor cosmetic difference plus like rule perfect apply time strong reason deviate developer feel guilty rule aim resolve confusion exists want add additional confusion never refer rule thats fine theyre primary goal going forward question arise framework answering new teammate join point rule starting point external contributor want understand codebase refer rule pain point addressed said let look rule address specific pain point feeling responsibility actor layer much clearer several pattern sometimes seen actor layer moved either command api layer explicitly allowing helper method exist api layer often avoid actor method call actor method prevents problem unable mock call unit test much possible actor call api method introducing resource layer eliminate separate resource structs live actor api layer much simpler every layer refer shared resource new summary struct pattern handle case actor combine data multiple resource link resource here visual representation screenshot miro board linked may grow slightly outofdate time document linked miro board considered reliable source truth related link miro board idea first written image